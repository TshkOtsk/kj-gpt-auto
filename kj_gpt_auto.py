import streamlit as st
from langchain.chat_models import ChatOpenAI
from langchain.schema import (
    SystemMessage,
    HumanMessage,
    AIMessage
)
from langchain.callbacks import get_openai_callback

import re

# theme = "The items in the input field are records of fieldwork at a rural village in Nepal."
theme = ""
prompt_ptrn = ""

# ä¾‹ç¤ºãƒ‡ãƒ¼ã‚¿ã®å‡ºå…¸
# ã€Œä½•ã¨ãªãæ°—ã«ãªã‚‹èˆˆå‘³é–¢å¿ƒã«ã¤ã„ã¦ã€
# å››æ³¨è¨˜ (1) 2023/10/26-10/31(2)è‡ªå®… (3) ãƒžãƒ³ãƒ€ãƒ©ãƒãƒ£ãƒ¼ãƒˆã‚’ã‚‚ã¨ã«ãƒ–ãƒ¬ã‚¹ãƒˆã—ã¦å‡ºãŸã‚¢ã‚¤ãƒ‡ã‚¢(4)Toshiki Otsuka


def prompt_grouping(lines, translated_theme):
    theme = translated_theme
    grouping1 = f"""
###Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.
Each group should have at most 3 items. Be sure to group ALL items. Items that cannot be grouped should be listed as is.
Please write in Japanese.

### Input:
é£Ÿå“ãƒ­ã‚¹ã‚’ã©ã†ã‚„ã£ã¦æ¸›ã‚‰ã›ã°ã„ã„ã‹æ°—ã«ãªã‚‹
æ­´å²ã‚ã‚‹äº¬éƒ½ã®ç”ºä¸¦ã¿ãŒã¨ã¦ã‚‚å¥½ãã 
åœ°åŸŸã§ä½œã£ãŸã‚‚ã®ã¯åœ°å…ƒã§é£Ÿã¹ãŸã»ã†ãŒã„ã„
æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
åœ°å…ƒã®ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒã‚ã‚Œã°é£Ÿã¹ãŸã„
ä½ã‚“ã§ã„ã‚‹ç¦å³¶çœŒã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã‚‚ã£ã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ä½ã‚“ã§ã„ã‚‹åœ°åŸŸã®äººå£ãŒã©ã‚“ã©ã‚“æ¸›ã£ã¦ã„ã¦ä¸å®‰
ä¿®å­¦æ—…è¡Œã§è¡Œãäº¬éƒ½ã®åº§ç¦…ä½“é¨“ãŒãŸã®ã—ã¿
å‹é”ã¨éŠã¶ã¨ãã«äº¤é€šæ‰‹æ®µãŒå°‘ãªã„ã®ãŒæ‚©ã¿

###Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
åœ°å…ƒã®ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒã‚ã‚Œã°é£Ÿã¹ãŸã„
ä½ã‚“ã§ã„ã‚‹ç¦å³¶çœŒã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã‚‚ã£ã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—2:
å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—3:
é£Ÿå“ãƒ­ã‚¹ã‚’ã©ã†ã‚„ã£ã¦æ¸›ã‚‰ã›ã°ã„ã„ã‹æ°—ã«ãªã‚‹
åœ°åŸŸã§ä½œã£ãŸã‚‚ã®ã¯åœ°å…ƒã§é£Ÿã¹ãŸã»ã†ãŒã„ã„
ã‚°ãƒ«ãƒ¼ãƒ—4:
ä½ã‚“ã§ã„ã‚‹åœ°åŸŸã®äººå£ãŒã©ã‚“ã©ã‚“æ¸›ã£ã¦ã„ã¦ä¸å®‰
å‹é”ã¨éŠã¶ã¨ãã«äº¤é€šæ‰‹æ®µãŒå°‘ãªã„ã®ãŒæ‚©ã¿
ã‚°ãƒ«ãƒ¼ãƒ—5:
ä¿®å­¦æ—…è¡Œã§è¡Œãäº¬éƒ½ã®åº§ç¦…ä½“é¨“ãŒãŸã®ã—ã¿
æ­´å²ã‚ã‚‹äº¬éƒ½ã®ç”ºä¸¦ã¿ãŒã¨ã¦ã‚‚å¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—6:
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
ã‚°ãƒ«ãƒ¼ãƒ—7:
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
ã‚°ãƒ«ãƒ¼ãƒ—8:
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ã‚°ãƒ«ãƒ¼ãƒ—9:
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ã‚°ãƒ«ãƒ¼ãƒ—10:
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
ã‚°ãƒ«ãƒ¼ãƒ—11:
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
ã‚°ãƒ«ãƒ¼ãƒ—12:
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—13:
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
ã‚°ãƒ«ãƒ¼ãƒ—14:
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
ã‚°ãƒ«ãƒ¼ãƒ—15:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚°ãƒ«ãƒ¼ãƒ—16:
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—17:
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

###Input:
"""
    grouping2 = f"""
###Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.
Each group should have at most 2 items. Be sure to group ALL items. Items that cannot be grouped should be listed as is.
Please write in Japanese.

### Input:
ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„
ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹
äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

###Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
ã‚°ãƒ«ãƒ¼ãƒ—2:
ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
ã‚°ãƒ«ãƒ¼ãƒ—3:
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
ã‚°ãƒ«ãƒ¼ãƒ—4:
ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹
äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…
ã‚°ãƒ«ãƒ¼ãƒ—5:
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
ã‚°ãƒ«ãƒ¼ãƒ—6:
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
ã‚°ãƒ«ãƒ¼ãƒ—7:
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ã‚°ãƒ«ãƒ¼ãƒ—8:
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ã‚°ãƒ«ãƒ¼ãƒ—9:
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—10:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚°ãƒ«ãƒ¼ãƒ—11:
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—12:
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

###Input:
"""
    grouping3 = f"""
###Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.
Each group should have at most 2 items. Be sure to group ALL items. Items that cannot be grouped should be listed as is.
Please write in Japanese.

### Input:
è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã®å¼·ã¿ã‚’ç”Ÿã‹ã—ã¦ã€ç¦å³¶çœŒã‚’ç››ã‚Šä¸Šã’ãŸã„
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã£ã¦ã„ãã‹ã‚‰ã“ãã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’ç¶­æŒã—ãŸã„
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

###Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã®å¼·ã¿ã‚’ç”Ÿã‹ã—ã¦ã€ç¦å³¶çœŒã‚’ç››ã‚Šä¸Šã’ãŸã„
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã£ã¦ã„ãã‹ã‚‰ã“ãã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’ç¶­æŒã—ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—2:
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—3:
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ã‚°ãƒ«ãƒ¼ãƒ—4:
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚°ãƒ«ãƒ¼ãƒ—5:
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
ã‚°ãƒ«ãƒ¼ãƒ—6:
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ã‚°ãƒ«ãƒ¼ãƒ—7:
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—8:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚°ãƒ«ãƒ¼ãƒ—9:
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

###Input:
"""
    grouping4 = f"""
###Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.
Each group should have at most 2 items. Be sure to group ALL items. Items that cannot be grouped should be listed as is.
Please write in Japanese.

###Input:
ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã‚Šã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„
äº¬éƒ½ã§ã®æ•£ç­–ã‚„åº§ç¦…ãªã©ã€æ­´å²ã‚ã‚‹åœŸåœ°ã«è¡Œã‹ãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«æ¥½ã—ã¿ãŸã„
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

###Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã‚Šã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„
äº¬éƒ½ã§ã®æ•£ç­–ã‚„åº§ç¦…ãªã©ã€æ­´å²ã‚ã‚‹åœŸåœ°ã«è¡Œã‹ãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«æ¥½ã—ã¿ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—2:
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ã‚°ãƒ«ãƒ¼ãƒ—3:
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
ã‚°ãƒ«ãƒ¼ãƒ—4:
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—5:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚°ãƒ«ãƒ¼ãƒ—6:
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

###Input:
"""
    grouping5 = f"""
###Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.
Each group should have at most 2 items. Be sure to group ALL items. Items that cannot be grouped should be listed as is.
Please write in Japanese.

###Input:
è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªã‚‰ã‚‚ãã†ã—ãŸåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„
ä¾‹ãˆã°å¹´é½¢å·®ã‚„éšœå®³ã®æœ‰ç„¡ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸã‚ˆã†ãªå¸¸è­˜ã®æž ã«æ‰ã‚ã‚Œãšã€æœ¬è³ªçš„ãªæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

###Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªã‚‰ã‚‚ãã†ã—ãŸåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—2:
ä¾‹ãˆã°å¹´é½¢å·®ã‚„éšœå®³ã®æœ‰ç„¡ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸã‚ˆã†ãªå¸¸è­˜ã®æž ã«æ‰ã‚ã‚Œãšã€æœ¬è³ªçš„ãªæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹
ã‚°ãƒ«ãƒ¼ãƒ—3:
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
ã‚°ãƒ«ãƒ¼ãƒ—4:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„

###Input:
"""
    if lines >= 20:
        prompt_ptrn = grouping1
    elif 15 <= lines < 20:
        prompt_ptrn = grouping2
    elif 10 <= lines < 15:
        prompt_ptrn = grouping3
    elif 6 <= lines < 10:
        prompt_ptrn = grouping4
    else:
        prompt_ptrn = grouping5
    return prompt_ptrn

def theme_translate(user_theme):
    theme = "ã‚¤ãƒ³ãƒ—ãƒƒãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥åŠ›ã—ãŸã®ã¯ã€" + user_theme + "ã«ã¤ã„ã¦ã®ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚"
    llm = ChatOpenAI(temperature=0, model_name="gpt-3.5-turbo-0613")
    translating_prompt = f"""
Please translate the following Japanese sentence into English.
{theme}
"""
    st.session_state.messages.append(SystemMessage(content=translating_prompt))
    with st.spinner("KJ-GPTãŒãƒ†ãƒ¼ãƒžã‚’åˆ†æžã—ã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-1:])
    translated_theme = answer
    st.session_state.costs.append(cost)
    return translated_theme


def data_generating(user_theme):
    theme = user_theme
    llm = ChatOpenAI(temperature=0, model_name="gpt-3.5-turbo-0613")
    translating_prompt = f"""
Please translate the following Japanese sentence into English.
{theme}
"""
    st.session_state.messages.append(SystemMessage(content=translating_prompt))
    with st.spinner("KJ-GPTãŒãƒ†ãƒ¼ãƒžã«ã¤ã„ã¦è€ƒãˆã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-1:])
    translated_theme = answer
    st.session_state.costs.append(cost)

    generating_prompt = f"""
### Instruction:
Please list about 15 bulleted assertions or opinions from a variety of perspectives, including those that may be somehow related to the following topic.
Items should begin with the letter "ãƒ»".
Items should be generated with more subjective items that are full of emotions and feelings.
Keep sentences as concise as possible, avoiding duplication.
Please write in Japanese.

### Topic:
{translated_theme}
"""
    return generating_prompt

labeling1 = """
###Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

###Conditions:
Please write in Japanese.

###Input:
åœ°å…ƒã®ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒã‚ã‚Œã°é£Ÿã¹ãŸã„
ä½ã‚“ã§ã„ã‚‹ç¦å³¶çœŒã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã‚‚ã£ã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„
###Output:
ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„

###Input:
å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„
###Output:
ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„

###Input:
é£Ÿå“ãƒ­ã‚¹ã‚’ã©ã†ã‚„ã£ã¦æ¸›ã‚‰ã›ã°ã„ã„ã‹æ°—ã«ãªã‚‹
åœ°åŸŸã§ä½œã£ãŸã‚‚ã®ã¯åœ°å…ƒã§é£Ÿã¹ãŸã»ã†ãŒã„ã„
###Output:
ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹

###Input:
ä½ã‚“ã§ã„ã‚‹åœ°åŸŸã®äººå£ãŒã©ã‚“ã©ã‚“æ¸›ã£ã¦ã„ã¦ä¸å®‰
å‹é”ã¨éŠã¶ã¨ãã«äº¤é€šæ‰‹æ®µãŒå°‘ãªã„ã®ãŒæ‚©ã¿
###Output:
äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…

###Input:
ä¿®å­¦æ—…è¡Œã§è¡Œãäº¬éƒ½ã®åº§ç¦…ä½“é¨“ãŒãŸã®ã—ã¿
æ­´å²ã‚ã‚‹äº¬éƒ½ã®ç”ºä¸¦ã¿ãŒã¨ã¦ã‚‚å¥½ãã 
###Output:
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã

###Input:
"""

labeling2 = """
###Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

###Conditions:
Please write in Japanese.

###Input:
ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
###Output:
è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã®å¼·ã¿ã‚’ç”Ÿã‹ã—ã¦ã€ç¦å³¶çœŒã‚’ç››ã‚Šä¸Šã’ãŸã„

###Input:
ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
###Output:
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 

###Input:
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
###Output:
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹

###Input:
ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹
äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…
###Output:
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã£ã¦ã„ãã‹ã‚‰ã“ãã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’ç¶­æŒã—ãŸã„

###Input:
"""

labeling3 = """
###Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

###Conditions:
Please write in Japanese.

###Input:
è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã®å¼·ã¿ã‚’ç”Ÿã‹ã—ã¦ã€ç¦å³¶çœŒã‚’ç››ã‚Šä¸Šã’ãŸã„
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã£ã¦ã„ãã‹ã‚‰ã“ãã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’ç¶­æŒã—ãŸã„
###Output:
ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã‚Šã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„

###Input:
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
###Output:
äº¬éƒ½ã§ã®æ•£ç­–ã‚„åº§ç¦…ãªã©ã€æ­´å²ã‚ã‚‹åœŸåœ°ã«è¡Œã‹ãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«æ¥½ã—ã¿ãŸã„

###Input:
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
###Output:
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹

###Input:
"""

labeling4 = """
###Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

###Conditions:
Use metaphors and proverbs as needed. Please write in Japanese.

###Input:
ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã‚Šã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„
äº¬éƒ½ã§ã®æ•£ç­–ã‚„åº§ç¦…ãªã©ã€æ­´å²ã‚ã‚‹åœŸåœ°ã«è¡Œã‹ãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«æ¥½ã—ã¿ãŸã„
###Output:
è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªã‚‰ã‚‚ãã†ã—ãŸåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„

###Input:
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
###Output:
ä¾‹ãˆã°å¹´é½¢å·®ã‚„éšœå®³ã®æœ‰ç„¡ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸã‚ˆã†ãªå¸¸è­˜ã®æž ã«æ‰ã‚ã‚Œãšã€æœ¬è³ªçš„ãªæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹

###Input:
"""

labeling5 = """
###Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

###Conditions:
Use metaphors and proverbs as needed. Please write in Japanese.

###Input:
è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªã‚‰ã‚‚ãã†ã—ãŸåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
###Output:
ãã®åœŸåœ°åœŸåœ°ãŒæŒã¤æ­´å²ã‚„è‡ªç„¶ç’°å¢ƒã€é£Ÿæ–‡åŒ–ã‚„é›°å›²æ°—ãªã©ã‚’ã€è‡ªåˆ†ã‹ã‚‰æ¥½ã—ã¿ã€ãã—ã¦åºƒã‚ãŸã„

###Input:
ä¾‹ãˆã°å¹´é½¢å·®ã‚„éšœå®³ã®æœ‰ç„¡ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸã‚ˆã†ãªå¸¸è­˜ã®æž ã«æ‰ã‚ã‚Œãšã€æœ¬è³ªçš„ãªæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹
###Output:
æ—¢å­˜ã®æž çµ„ã¿ã‚„å¯¾ç«‹è»¸ã‚’ã¯ã¿å‡ºã—ã¦ã§ã‚‚ã€æœ¬å½“ã«å¤§åˆ‡ãªè¡Œå‹•ã‚’èµ·ã“ã—ã€å¹³å’Œãªæœªæ¥ã‚’ç›®æŒ‡ã—ãŸã„

###Input:
"""

symbol = """
###Instructions:
Paraphrase each group of sentences in a single word that can be understood instantaneously.
Rephrase it with an adjective, verb or metaphor in Japanese.

###Input:
ãã®åœŸåœ°åœŸåœ°ãŒæŒã¤æ­´å²ã‚„è‡ªç„¶ç’°å¢ƒã€é£Ÿæ–‡åŒ–ã‚„é›°å›²æ°—ãªã©ã‚’ã€è‡ªåˆ†ã‹ã‚‰æ¥½ã—ã¿ã€ãã—ã¦åºƒã‚ãŸã„
###Output:
åœ°åŸŸç‹¬ç‰¹ã®é¢¨åœŸ

###Input:
æ—¢å­˜ã®æž çµ„ã¿ã‚„å¯¾ç«‹è»¸ã‚’ã¯ã¿å‡ºã—ã¦ã§ã‚‚ã€æœ¬å½“ã«å¤§åˆ‡ãªè¡Œå‹•ã‚’èµ·ã“ã—ã€å¹³å’Œãªæœªæ¥ã‚’ç›®æŒ‡ã—ãŸã„
###Output:
å¸¸è­˜ã¯ãšã‚Œã®å¤§åˆ‡ãªè¡Œå‹•

###Input:
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
###Output:
æ¼«ç”»ãªã‚‰ã§ã¯ã®æ„Ÿå‹•

###Input:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
###Output:
ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ãƒˆ

###Input:
"""

def init_page():
    st.set_page_config(
        page_title="KJ-GPT",
        page_icon="ðŸ•µï¸â€â™‚ï¸"
    )
    st.header("KJ-GPT ðŸ•µï¸â€â™‚ï¸")
    st.sidebar.title("Options")

def init_messages():
    clear_button = st.sidebar.button("Clear Conversation", key="clear")
    if clear_button or "messages" not in st.session_state:

        st.session_state.messages = [
            SystemMessage(content="")
        ]

        # st.session_state.messages = [
        #     SystemMessage(content=labeling4)
        # ]

        # st.session_state.messages = [
        #     SystemMessage(content=symbol)
        # ]

        st.session_state.costs = []

def select_model():
    model = st.sidebar.radio("Choose a model:", ("GPT-3.5", "GPT-3.5-16k", "GPT-4", "GPT-4-Turbo"))
    if model == "GPT-3.5":
        model_name = "gpt-3.5-turbo-0613"
    elif model == "GPT-3.5-16k":
        model_name = "gpt-3.5-turbo-16k-0613"
    elif model == "GPT-4":
        model_name = "gpt-4"
    else:
        model_name = "gpt-4-1106-preview"

    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã€temperatureã‚’0ã‹ã‚‰1ã¾ã§ã®ç¯„å›²ã§é¸æŠžå¯èƒ½ã«ã™ã‚‹
    # åˆæœŸå€¤ã¯0.0ã€åˆ»ã¿å¹…ã¯0.1ã¨ã™ã‚‹
    temperature = st.sidebar.slider("Temperature:", min_value=0.0, max_value=1.0, value=0.7, step=0.01)
    
    return ChatOpenAI(temperature=temperature, model_name=model_name)

def get_answer(llm, messages):
    with get_openai_callback() as cb:
        answer = llm(messages)
    return answer.content, cb.total_cost

def count_newlines(text):
    # æ”¹è¡Œæ–‡å­—ã‚’å«ã‚€æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®šç¾©
    pattern = r"\r\n|\n|\r"
    # ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒžãƒƒãƒã™ã‚‹éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã€ãã®æ•°ã‚’è¿”ã™
    return len(re.findall(pattern, text))

def get_init_list(data):
    lines = data.strip().split("\n")
    return lines

def get_list(data):
    # ãƒ‡ãƒ¼ã‚¿ã‚’è¡Œã”ã¨ã«åˆ†å‰²
    lines = data.strip().split("\n")

    result = []
    temp = []

    for line in lines:
        # â€ã‚°ãƒ«ãƒ¼ãƒ—â€ã‚‚ã—ãã¯"å˜ç‹¬"ã®è¡Œã®å ´åˆã€tempã‚’ãƒªã‚»ãƒƒãƒˆ
        if "ã‚°ãƒ«ãƒ¼ãƒ—" in line or "å˜ç‹¬" in line:
            if temp:
                if len(temp) == 1:
                    result.append(temp[0])
                else:
                    result.append(temp)
                temp = []
        # è¡Œã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
        elif line:
            temp.append(line)
    # æœ€å¾Œã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    if temp:
        if len(temp) == 1:
            result.append(temp[0])
        else:
            result.append(temp)
    # ""ã®ç©ºç™½è¦ç´ ã‚’å‰Šé™¤
    result = [item for item in result if item != ""]
    return result

def add_markdown_entry(level, text):
    """ä¸Žãˆã‚‰ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ã™ã‚‹é–¢æ•°"""
    return f"{'#' * level} {text}\n"

def find_sub_items(key, level, dict_items):
    """ã‚µãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŽ¢ã—ã€ãã®è¦‹å‡ºã—ã‚’ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§è¿”ã™é–¢æ•°"""
    markdown = ""
    for dict_item in dict_items:
        if isinstance(dict_item, dict) and key in dict_item:
            for sub_item in dict_item[key]:
                if sub_item:  # ç©ºã®æ–‡å­—åˆ—ã§ãªã„å ´åˆã«ã‚µãƒ–è¦‹å‡ºã—ã‚’è¿½åŠ 
                    markdown += add_markdown_entry(level, sub_item)
                    # å†å¸°çš„ã«ä¸‹ã®ãƒ¬ãƒ™ãƒ«ã®é …ç›®ã‚’æŽ¢ã™
                    if level < 6:  # 6æ¬¡è¦‹å‡ºã—ã¾ã§ç¶šã‘ã‚‹
                        markdown += find_sub_items(sub_item, level + 1, dict_items)
    return markdown

def headline_to_list(markdown_input):
    """ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã•ã‚ŒãŸè¦‹å‡ºã—ã‚’ãƒªã‚¹ãƒˆç®‡æ¡æ›¸ãå½¢å¼ã«å¤‰æ›ã—ã¦è¿”ã™é–¢æ•°"""
    # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã«åˆ†å‰²ã—ã¾ã™ã€‚
    lines = markdown_input.strip().split("\n")

    # å¤‰æ›ã•ã‚ŒãŸãƒªã‚¹ãƒˆã‚’ä¿æŒã™ã‚‹ãŸã‚ã®ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
    converted_list = []

    # å„è¡Œã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦å‡¦ç†ã—ã¾ã™ã€‚
    for line in lines:

        if "**" in line:
            converted_list.append("\n" + line + "\n")

        else:
            # è¦‹å‡ºã—ã®ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®šã—ã¾ã™ï¼ˆ#ã®æ•°ã§æ±ºã¾ã‚Šã¾ã™ï¼‰ã€‚
            level = line.count("#")
            
            # è¦‹å‡ºã—ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã—ã¾ã™ã€‚
            text = line.replace("#", "").strip()
            
            # ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’æ±ºå®šã—ã¾ã™ã€‚
            # ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¯è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¢—ã‚„ã—ã¾ã™ã€‚
            indent = '    ' * (level - 1)
            
            # å¤‰æ›ã•ã‚ŒãŸãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¾ã™ã€‚
            converted_list.append(f"{indent}- {text}")

    # ãƒªã‚¹ãƒˆå½¢å¼ã«å¤‰æ›ã•ã‚ŒãŸãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’çµåˆã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚
    converted_markdown = "\n".join(converted_list)

    return converted_markdown

def segmented_by_three(markdown_input):
    """ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã•ã‚ŒãŸè¦‹å‡ºã—ã‚’3è¡Œã”ã¨ã«åˆ†å‰²ã—ã¦è¿”ã™é–¢æ•°"""
    # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã«åˆ†å‰²ã—ã¾ã™ã€‚
    lines = markdown_input.strip().split("\n")

    # 3è¡Œã”ã¨ã«åŒºåˆ‡ã£ã¦ãƒªã‚¹ãƒˆåŒ–ã—ã¾ã™ã€‚
    segmented_markdown = []
    for i in range(0, len(lines), 3):
        segment = lines[i:i + 3]
        segmented_markdown.append("\n".join(segment))

    return segmented_markdown

def messages_init():
    st.session_state.messages = [
        SystemMessage(content=""),
        HumanMessage(content=""),
        AIMessage(content="")
    ]

def main():
    init_page()

    llm = select_model()
    init_messages()

    translated_theme = None

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ç›£è¦–
    theme_container = st.container()
    with theme_container:
        with st.form(key="my_theme", clear_on_submit=False):
            user_theme = st.text_area(label="ãƒ†ãƒ¼ãƒž: ", key="theme_input", height=50)
            st.text("ã«ã¤ã„ã¦")
            theme_button = st.form_submit_button(label="æ±ºå®š")
        # if theme_button and user_theme:
        #     translated_theme = theme_translate(user_theme)

    container = st.container()
    with container:
        with st.form(key="my_form", clear_on_submit=False):
            user_input = st.text_area(label="é …ç›®ãƒ©ãƒ™ãƒ«: ", key="input", height=300)
            # generating_button = st.form_submit_button(label="é …ç›®è‡ªå‹•ç”Ÿæˆ")
            grouping_button = st.form_submit_button(label="ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ")
            # labeling_button = st.form_submit_button(label="è¡¨æœ­ã¥ãã‚Š")
            # symbol_button = st.form_submit_button(label="ã‚·ãƒ³ãƒœãƒ«ä½œæˆ")

        # if generating_button and user_theme:
        #     prompt_ptrn = data_generating(user_theme)
        #     st.session_state.messages.append(SystemMessage(content=prompt_ptrn))
        #     st.session_state.messages.append(HumanMessage(content=user_input))
        #     with st.spinner("KJ-GPTãŒå…ƒãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ ..."):
        #         answer, cost = get_answer(llm, st.session_state.messages[-2:])
        #     st.session_state.messages.append(AIMessage(content=answer))
        #     st.session_state.costs.append(cost)

        if grouping_button and user_input:
            group_list = get_init_list(user_input)
            number_of_items = len(group_list)
            print(number_of_items)
            labeling_pair = []
            dict = {}
            count = 0
            while number_of_items > 5:
                # lines = count_newlines(user_input)
                if translated_theme is None:
                    translated_theme = theme_translate(user_theme)
                prompt_ptrn = prompt_grouping(number_of_items, translated_theme)
                st.session_state.messages.append(SystemMessage(content=prompt_ptrn))
                st.session_state.messages.append(HumanMessage(content=user_input))
                with st.spinner("KJ-GPTãŒãƒ©ãƒ™ãƒ«ã‚’é›†ã‚ã¦ã„ã¾ã™ ..."):
                    answer, cost = get_answer(llm, st.session_state.messages[-2:])
                st.session_state.messages.append(AIMessage(content=answer))
                st.session_state.costs.append(cost)
                group_list = get_list(answer)
                for group in group_list:
                    if isinstance(group, list):
                        group_string = "\n".join(group)
                        if number_of_items >= 20:
                            prompt_ptrn = labeling1
                        elif 16 <= number_of_items < 20:
                            prompt_ptrn = labeling2
                        elif 12 <= number_of_items < 16:
                            prompt_ptrn = labeling3
                        elif 8 <= number_of_items < 12:
                            prompt_ptrn = labeling4
                        else:
                            prompt_ptrn = labeling5
                        st.session_state.messages.append(SystemMessage(content=prompt_ptrn))
                        st.session_state.messages.append(HumanMessage(content=group_string))
                        with st.spinner("KJ-GPTãŒè¡¨æœ­ã‚’è€ƒãˆã¦ã„ã¾ã™ ..."):
                            answer, cost = get_answer(llm, st.session_state.messages[-2:])
                        group_list.append(answer)
                        dict = {answer: group}
                        labeling_pair.append(dict)
                        st.session_state.messages.append(AIMessage(content=answer))
                        st.session_state.costs.append(cost)
                    # else:
                    #     labeling_pair.append(group)
                group_list = [item for item in group_list if not isinstance(item, list)]
                # print(labeling_pair)
                group_list_str = "\n".join(group_list)
                user_input = group_list_str
                count += 1
                result = st.text_area(label=f"{count}å›žç›®ã®çµæžœ: ", key=f"result{count}", value=group_list_str, height=300)
                number_of_items = len(group_list)
            # symbol_input_list = get_list(user_input)
            # print("symbol_input_list:", symbol_input_list)
            top_items = []
            symbol_sets = []
            symbol_dict = {}
            symbol_count = 0
            for item in group_list:
                symbol_count += 1
                item_str = str(item)
                st.session_state.messages.append(SystemMessage(content=symbol))
                st.session_state.messages.append(HumanMessage(content=item_str))
                with st.spinner("KJ-GPTãŒã‚·ãƒ³ãƒœãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™ ..."):
                    symbol_answer, cost = get_answer(llm, st.session_state.messages[-2:])
                symbol_set = symbol_answer + "ï¼š" + item_str
                symbol_title = "**" + f"({symbol_count}) " +  symbol_answer + "**"
                symbol_dict["# " + item_str] = symbol_title + "\n" + "# " + item_str
                # print("symbol_set", symbol_set)
                top_items.append(item_str)
                symbol_sets.append(symbol_set)
                st.session_state.messages.append(AIMessage(content=answer))
                st.session_state.costs.append(cost)
            symbol_str = "\n".join(symbol_sets)
            st.text_area(label="ã‚·ãƒ³ãƒœãƒ«: ", value=symbol_str, key="final_result", height=300)
            st.text_area(label="è¾žæ›¸: ", value=labeling_pair, key="final_dict", height=300)

            markdown_text = ""

            # top_itemsãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦æœ€ä¸Šä½ã®è¦‹å‡ºã—ã‚’å‡¦ç†ã—ã¾ã™ã€‚
            for top_item in top_items:
                # top_text = top_item.split("ï¼š")[1].strip()
                markdown_text += add_markdown_entry(1, top_item)  # æœ€ä¸Šä½ã®è¦‹å‡ºã—ã‚’è¿½åŠ 
                markdown_text += find_sub_items(top_item, 2, labeling_pair)  # ã‚µãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŽ¢ã—ã¦è¿½åŠ 
            for key, value in symbol_dict.items():
                markdown_text = markdown_text.replace(key, value)
            
            st.text_area(label="Mark down: ", value=markdown_text, key="markdown", height=450)


#             sentence = f"""
# ###Instructions:
# {translated_theme}
# You are a philosopher who excels at introspection. Please logically connect each of the following bulleted items into a sentence.
# Please add philosophical criticism along the way.

# ### Condition:
# Please write in Japanese.
# Any additional explanations should be enclosed in parentheses.
# The line beginning with "**" is the title of the chapter, so insert a line break before and after it.
# Please add a logical connection to the last sentence of the text below.
# {answer}

# ###Input:
# # æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
# ## å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
# ## ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
# ### å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
# ### æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„

# ###Output:
# å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œã€‚ï¼ˆç­”ãˆã®ã‚ã‚‹å•é¡Œã‚’ãŸã å¼·åˆ¶çš„ã«è§£ç­”ã•ã›ã‚‰ã‚Œã‚‹ã®ã¯ç„¡é§„ã ã¨æ€ã†ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„ChatGPTãªã©ãŒæ€¥é€Ÿã«ç™ºå±•ã—ã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã£ãŸå˜ãªã‚‹æš—è¨˜ã‚„è«–ç†è¨ˆç®—ã¯ã€ãã®ã†ã¡äººé–“ãŒã‚„ã‚‹å¿…è¦ã¯ãªããªã‚‹ã¨æ€ã†ã€‚ãã‚Œãªã®ã«ã€ã“ã®ã¾ã¾åå·®å€¤è‡³ä¸Šä¸»ç¾©ã®è©°ã‚è¾¼ã¿æ•™è‚²ã§ä»Šå¾Œã‚‚ã‚„ã£ã¦ã„ããªã‚‰ã°ã€ä½•ã®å½¹ã«ã‚‚ç«‹ãŸãªã„å¤§äººã‚’è‚²ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚ï¼‰
# ãã†ã§ã¯ãªãã¦ã€ã‚‚ã£ã¨æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„ã€‚ï¼ˆç­”ãˆã®ãªã„å•ã„ã«è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ç«‹ã¡å‘ã‹ã£ãŸã‚Šã€è‡ªåˆ†ã ã‘ã®ç‰¹åˆ¥ãªèˆˆå‘³é–¢å¿ƒã‚’è‚²ã¦ã¦å°‚é–€æ€§ã‚’é«˜ã‚ãŸã‚Šã™ã‚‹å‹‰å¼·ã®æ–¹ãŒä»Šå¾Œæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã¯æ˜Žã‚‰ã‹ã ã€‚ï¼‰ã¤ã¾ã‚Šã€ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„ã¨ã„ã†ã“ã¨ã€‚ãã—ã¦ãã®ãŸã‚ã«ã¯ã€å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†ã€‚
# ï¼ˆãã‚‚ãã‚‚ä»Šã®æ•™å¸«ãŒæ˜”ãªãŒã‚‰ã®è©°ã‚è¾¼ã¿å¼ã®æ•™è‚²ã§è‚²ã£ãŸã®ã§ã€ãã®æ„è­˜æ”¹é©ãŒå¿…è¦ã ã€‚æ•™å¸«è‡ªèº«ãŒç­”ãˆã®ãªã„è‡ªåˆ†ã®å¿ƒã®åº•ã‹ã‚‰å‡ºã¦ããŸå•ã„ã‚’è¨­å®šã—ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«ãã‚Œã«å–ã‚Šçµ„ã‚€å§¿å‹¢ã‚’è¦‹ã›ãªã„ã¨ã€å­ä¾›é”ã¯ã¤ã„ã¦ã„ã‹ãªã„ã€‚ãã‚Œã ã‘ã§ã¯ãªãã€å­ä¾›ã®è¦ªãŸã¡ã‚‚æ–°ã—ã„å­¦ã³ã‚’äººç”Ÿã«å–ã‚Šå…¥ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ç­”ãˆã®ãªã„æŽ¢ç©¶æ´»å‹•ã¯å¾“æ¥ã®å­¦ç¿’ã«æ¯”ã¹ã¦ã€ã‚ˆã‚Šæ—¥å¸¸ç”Ÿæ´»ã«æ·±ãé–¢ã‚ã‚‹ã‚‚ã®ã ã€‚æ™®æ®µéŽã”ã—ã¦ã„ã‚‹ä¸­ã§æ„Ÿã˜ã‚‹ç–‘å•ã‚„é•å’Œæ„Ÿãªã©ã‚’èµ·ç‚¹ã«ã—ãŸã€å®Ÿä½“é¨“ã«å³ã—ãŸå•ã„ã§ã‚ã‚‹ã»ã©ã€ä»Šå¾Œã®é•·ã„äººç”Ÿã§å–ã‚Šçµ„ã‚€ã«å€¤ã™ã‚‹æ·±ã„ã‚‚ã®ã«ãªã‚Šã‚„ã™ã„ã€‚ãªã®ã§ã€ã“ã‚Œã¾ã§ã®ã‚ˆã†ã«è¦ªãŒæ•™è‚²ã‚’å­¦æ ¡ã‚„å¡¾ã«ä»»ã›ã£ã±ãªã—ã«ã—ã¦ã€å®¶åº­ã§å­ä¾›ã«ç„¡é–¢å¿ƒã§ã„ã¦ã¯å­ä¾›ã®æŽ¢ç©¶å¿ƒãŒè‚²ã¡ã«ãããªã‚‹ã€‚æ•™å¸«ã¨åŒã˜ã‚ˆã†ã«ã€è¦ªãŸã¡ã‚‚è‡ªåˆ†ã®å•ã„ã‚’ç«‹ã¦ã¦ãã‚Œã‚’è¿½æ±‚ã™ã‚‹å–¶ã¿ã‚’å®Ÿéš›ã«ã‚„ã‚‹ã¹ãã ã€‚ãã—ã¦ã€ãã®è¡Œå‹•ãŒå­ä¾›ãŸã¡ã‚’æ„ŸåŒ–ã•ã›ã€å®¶åº­ã‚’æ´»æ°—ã¥ã‹ã›ã¦ã€ã•ã‚‰ã«ã¯è·å ´ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚‚ä¸Šã’ã‚‹ã“ã¨ã«ãªã‚‹ã®ãŒç†æƒ³ã ã€‚ï¼‰ã“ã®ã‚ˆã†ã«ã€æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã¨è¨€ãˆã‚‹ã€‚

# ###Input:
# """

            # å¤‰æ•°answerã‚’ãƒªã‚»ãƒƒãƒˆ
            answer = ""
            sentence = f"""
###Instructions:
{translated_theme}
You are a philosopher who excels at introspection. Please logically connect each of the following bulleted items into a sentence.
Please add philosophical criticism along the way.

### Condition:
Please write in Japanese.
Any additional explanations should be enclosed in parentheses.
The line beginning with "**" is the title of the chapter, so insert a line break before and after it.
Please add a logical connection to the last sentence of the text below.
{answer}

###Input:
**(1) å¸¸è­˜ã¯ãšã‚Œã®å¤§åˆ‡ãªè¡Œå‹•**
# æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
## å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
## ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
### å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
### æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„

###Output:

(1) å¸¸è­˜ã¯ãšã‚Œã®å¤§åˆ‡ãªè¡Œå‹•

å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œã€‚ï¼ˆç­”ãˆã®ã‚ã‚‹å•é¡Œã‚’ãŸã å¼·åˆ¶çš„ã«è§£ç­”ã•ã›ã‚‰ã‚Œã‚‹ã®ã¯ç„¡é§„ã ã¨æ€ã†ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„ChatGPTãªã©ãŒæ€¥é€Ÿã«ç™ºå±•ã—ã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã£ãŸå˜ãªã‚‹æš—è¨˜ã‚„è«–ç†è¨ˆç®—ã¯ã€ãã®ã†ã¡äººé–“ãŒã‚„ã‚‹å¿…è¦ã¯ãªããªã‚‹ã¨æ€ã†ã€‚ãã‚Œãªã®ã«ã€ã“ã®ã¾ã¾åå·®å€¤è‡³ä¸Šä¸»ç¾©ã®è©°ã‚è¾¼ã¿æ•™è‚²ã§ä»Šå¾Œã‚‚ã‚„ã£ã¦ã„ããªã‚‰ã°ã€ä½•ã®å½¹ã«ã‚‚ç«‹ãŸãªã„å¤§äººã‚’è‚²ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚ï¼‰
ãã†ã§ã¯ãªãã¦ã€ã‚‚ã£ã¨æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„ã€‚ï¼ˆç­”ãˆã®ãªã„å•ã„ã«è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ç«‹ã¡å‘ã‹ã£ãŸã‚Šã€è‡ªåˆ†ã ã‘ã®ç‰¹åˆ¥ãªèˆˆå‘³é–¢å¿ƒã‚’è‚²ã¦ã¦å°‚é–€æ€§ã‚’é«˜ã‚ãŸã‚Šã™ã‚‹å‹‰å¼·ã®æ–¹ãŒä»Šå¾Œæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã¯æ˜Žã‚‰ã‹ã ã€‚ï¼‰ã¤ã¾ã‚Šã€ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„ã¨ã„ã†ã“ã¨ã€‚ãã—ã¦ãã®ãŸã‚ã«ã¯ã€å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†ã€‚
ï¼ˆãã‚‚ãã‚‚ä»Šã®æ•™å¸«ãŒæ˜”ãªãŒã‚‰ã®è©°ã‚è¾¼ã¿å¼ã®æ•™è‚²ã§è‚²ã£ãŸã®ã§ã€ãã®æ„è­˜æ”¹é©ãŒå¿…è¦ã ã€‚æ•™å¸«è‡ªèº«ãŒç­”ãˆã®ãªã„è‡ªåˆ†ã®å¿ƒã®åº•ã‹ã‚‰å‡ºã¦ããŸå•ã„ã‚’è¨­å®šã—ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«ãã‚Œã«å–ã‚Šçµ„ã‚€å§¿å‹¢ã‚’è¦‹ã›ãªã„ã¨ã€å­ä¾›é”ã¯ã¤ã„ã¦ã„ã‹ãªã„ã€‚ãã‚Œã ã‘ã§ã¯ãªãã€å­ä¾›ã®è¦ªãŸã¡ã‚‚æ–°ã—ã„å­¦ã³ã‚’äººç”Ÿã«å–ã‚Šå…¥ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ç­”ãˆã®ãªã„æŽ¢ç©¶æ´»å‹•ã¯å¾“æ¥ã®å­¦ç¿’ã«æ¯”ã¹ã¦ã€ã‚ˆã‚Šæ—¥å¸¸ç”Ÿæ´»ã«æ·±ãé–¢ã‚ã‚‹ã‚‚ã®ã ã€‚æ™®æ®µéŽã”ã—ã¦ã„ã‚‹ä¸­ã§æ„Ÿã˜ã‚‹ç–‘å•ã‚„é•å’Œæ„Ÿãªã©ã‚’èµ·ç‚¹ã«ã—ãŸã€å®Ÿä½“é¨“ã«å³ã—ãŸå•ã„ã§ã‚ã‚‹ã»ã©ã€ä»Šå¾Œã®é•·ã„äººç”Ÿã§å–ã‚Šçµ„ã‚€ã«å€¤ã™ã‚‹æ·±ã„ã‚‚ã®ã«ãªã‚Šã‚„ã™ã„ã€‚ãªã®ã§ã€ã“ã‚Œã¾ã§ã®ã‚ˆã†ã«è¦ªãŒæ•™è‚²ã‚’å­¦æ ¡ã‚„å¡¾ã«ä»»ã›ã£ã±ãªã—ã«ã—ã¦ã€å®¶åº­ã§å­ä¾›ã«ç„¡é–¢å¿ƒã§ã„ã¦ã¯å­ä¾›ã®æŽ¢ç©¶å¿ƒãŒè‚²ã¡ã«ãããªã‚‹ã€‚æ•™å¸«ã¨åŒã˜ã‚ˆã†ã«ã€è¦ªãŸã¡ã‚‚è‡ªåˆ†ã®å•ã„ã‚’ç«‹ã¦ã¦ãã‚Œã‚’è¿½æ±‚ã™ã‚‹å–¶ã¿ã‚’å®Ÿéš›ã«ã‚„ã‚‹ã¹ãã ã€‚ãã—ã¦ã€ãã®è¡Œå‹•ãŒå­ä¾›ãŸã¡ã‚’æ„ŸåŒ–ã•ã›ã€å®¶åº­ã‚’æ´»æ°—ã¥ã‹ã›ã¦ã€ã•ã‚‰ã«ã¯è·å ´ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚‚ä¸Šã’ã‚‹ã“ã¨ã«ãªã‚‹ã®ãŒç†æƒ³ã ã€‚ï¼‰ã“ã®ã‚ˆã†ã«ã€æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã¨è¨€ãˆã‚‹ã€‚

###Input:
"""
            
            simplified_answer = ""
            simplifying_sentence = f"""
### Instruction:
{translated_theme}
Extract the bracketed sentences from the text and create an integrated text of them.

### Condition:
Please write in Japanese.
Please make sure that the text is chewed up in a way that high school students can understand.
Lines beginning with bracketed numbers should be transcribed in their original position and with no change in content.
Please add a logical connection to the text below.
{simplified_answer}

###Input:
(1) å¸¸è­˜ã¯ãšã‚Œã®å¤§åˆ‡ãªè¡Œå‹•

å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œã€‚ï¼ˆç­”ãˆã®ã‚ã‚‹å•é¡Œã‚’ãŸã å¼·åˆ¶çš„ã«è§£ç­”ã•ã›ã‚‰ã‚Œã‚‹ã®ã¯ç„¡é§„ã ã¨æ€ã†ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„ChatGPTãªã©ãŒæ€¥é€Ÿã«ç™ºå±•ã—ã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã£ãŸå˜ãªã‚‹æš—è¨˜ã‚„è«–ç†è¨ˆç®—ã¯ã€ãã®ã†ã¡äººé–“ãŒã‚„ã‚‹å¿…è¦ã¯ãªããªã‚‹ã¨æ€ã†ã€‚ãã‚Œãªã®ã«ã€ã“ã®ã¾ã¾åå·®å€¤è‡³ä¸Šä¸»ç¾©ã®è©°ã‚è¾¼ã¿æ•™è‚²ã§ä»Šå¾Œã‚‚ã‚„ã£ã¦ã„ããªã‚‰ã°ã€ä½•ã®å½¹ã«ã‚‚ç«‹ãŸãªã„å¤§äººã‚’è‚²ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚ï¼‰
ãã†ã§ã¯ãªãã¦ã€ã‚‚ã£ã¨æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„ã€‚ï¼ˆç­”ãˆã®ãªã„å•ã„ã«è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ç«‹ã¡å‘ã‹ã£ãŸã‚Šã€è‡ªåˆ†ã ã‘ã®ç‰¹åˆ¥ãªèˆˆå‘³é–¢å¿ƒã‚’è‚²ã¦ã¦å°‚é–€æ€§ã‚’é«˜ã‚ãŸã‚Šã™ã‚‹å‹‰å¼·ã®æ–¹ãŒä»Šå¾Œæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã¯æ˜Žã‚‰ã‹ã ã€‚ï¼‰ã¤ã¾ã‚Šã€ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„ã¨ã„ã†ã“ã¨ã€‚ãã—ã¦ãã®ãŸã‚ã«ã¯ã€å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†ã€‚
ï¼ˆãã‚‚ãã‚‚ä»Šã®æ•™å¸«ãŒæ˜”ãªãŒã‚‰ã®è©°ã‚è¾¼ã¿å¼ã®æ•™è‚²ã§è‚²ã£ãŸã®ã§ã€ãã®æ„è­˜æ”¹é©ãŒå¿…è¦ã ã€‚æ•™å¸«è‡ªèº«ãŒç­”ãˆã®ãªã„è‡ªåˆ†ã®å¿ƒã®åº•ã‹ã‚‰å‡ºã¦ããŸå•ã„ã‚’è¨­å®šã—ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«ãã‚Œã«å–ã‚Šçµ„ã‚€å§¿å‹¢ã‚’è¦‹ã›ãªã„ã¨ã€å­ä¾›é”ã¯ã¤ã„ã¦ã„ã‹ãªã„ã€‚ãã‚Œã ã‘ã§ã¯ãªãã€å­ä¾›ã®è¦ªãŸã¡ã‚‚æ–°ã—ã„å­¦ã³ã‚’äººç”Ÿã«å–ã‚Šå…¥ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ç­”ãˆã®ãªã„æŽ¢ç©¶æ´»å‹•ã¯å¾“æ¥ã®å­¦ç¿’ã«æ¯”ã¹ã¦ã€ã‚ˆã‚Šæ—¥å¸¸ç”Ÿæ´»ã«æ·±ãé–¢ã‚ã‚‹ã‚‚ã®ã ã€‚æ™®æ®µéŽã”ã—ã¦ã„ã‚‹ä¸­ã§æ„Ÿã˜ã‚‹ç–‘å•ã‚„é•å’Œæ„Ÿãªã©ã‚’èµ·ç‚¹ã«ã—ãŸã€å®Ÿä½“é¨“ã«å³ã—ãŸå•ã„ã§ã‚ã‚‹ã»ã©ã€ä»Šå¾Œã®é•·ã„äººç”Ÿã§å–ã‚Šçµ„ã‚€ã«å€¤ã™ã‚‹æ·±ã„ã‚‚ã®ã«ãªã‚Šã‚„ã™ã„ã€‚ãªã®ã§ã€ã“ã‚Œã¾ã§ã®ã‚ˆã†ã«è¦ªãŒæ•™è‚²ã‚’å­¦æ ¡ã‚„å¡¾ã«ä»»ã›ã£ã±ãªã—ã«ã—ã¦ã€å®¶åº­ã§å­ä¾›ã«ç„¡é–¢å¿ƒã§ã„ã¦ã¯å­ä¾›ã®æŽ¢ç©¶å¿ƒãŒè‚²ã¡ã«ãããªã‚‹ã€‚æ•™å¸«ã¨åŒã˜ã‚ˆã†ã«ã€è¦ªãŸã¡ã‚‚è‡ªåˆ†ã®å•ã„ã‚’ç«‹ã¦ã¦ãã‚Œã‚’è¿½æ±‚ã™ã‚‹å–¶ã¿ã‚’å®Ÿéš›ã«ã‚„ã‚‹ã¹ãã ã€‚ãã—ã¦ã€ãã®è¡Œå‹•ãŒå­ä¾›ãŸã¡ã‚’æ„ŸåŒ–ã•ã›ã€å®¶åº­ã‚’æ´»æ°—ã¥ã‹ã›ã¦ã€ã•ã‚‰ã«ã¯è·å ´ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚‚ä¸Šã’ã‚‹ã“ã¨ã«ãªã‚‹ã®ãŒç†æƒ³ã ã€‚ï¼‰ã“ã®ã‚ˆã†ã«ã€æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã¨è¨€ãˆã‚‹ã€‚

###Output:
(1) å¸¸è­˜ã¯ãšã‚Œã®å¤§åˆ‡ãªè¡Œå‹•

ãŸã å•é¡Œã®ç­”ãˆã‚’æ•™ãˆè¾¼ã‚€å¤ã„ã‚„ã‚Šæ–¹ã§ã¯ãªãã€ãªãœãã†ãªã‚‹ã®ã‹ã‚’è€ƒãˆãŸã‚Šã€æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã‚Šã™ã‚‹å­¦ã³ãŒå¤§åˆ‡ã ã£ã¦è©±ã ã‚ˆã€‚ãƒãƒƒãƒˆã‚„ChatGPTã¿ãŸã„ãªè³¢ã„ãƒ„ãƒ¼ãƒ«ãŒãŸãã•ã‚“ã‚ã‚‹ã‹ã‚‰ã€å˜ç´”ãªæš—è¨˜ã‚„è¨ˆç®—ã¯ã‚‚ã†äººé–“ãŒã‚ã–ã‚ã–ã‚„ã‚‹ã“ã¨ã˜ã‚ƒãªããªã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ãªã€‚ã§ã‚‚ã€å­¦æ ¡ãŒä»Šã®ã¾ã¾è©°ã‚è¾¼ã¿ã§ç‚¹æ•°ã ã‘è¿½ã„ã‹ã‘ã‚‹æ•™è‚²ã‚’ç¶šã‘ãŸã‚‰ã€æœ¬å½“ã«å¿…è¦ãªã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã‚‰ã‚Œãªã„å¤§äººã«ãªã£ã¦ã—ã¾ã†ã€‚
ã“ã‚Œã‹ã‚‰ã¯ã€ç­”ãˆãŒã™ãã«ã¯å‡ºãªã„ã‚ˆã†ãªå•é¡Œã«ã©ã†ç«‹ã¡å‘ã‹ã†ã‹ã€è‡ªåˆ†ã®å¥½ããªã“ã¨ã‚’è¦‹ã¤ã‘ã¦æ·±ãæŽ˜ã‚Šä¸‹ã’ã‚‹å­¦ã³ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚“ã ã€‚å…ˆç”ŸãŸã¡ã‚‚æ˜”ã®ã‚„ã‚Šæ–¹ã‹ã‚‰å¤‰ã‚ã£ã¦ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«è€ƒãˆã‚‹ã“ã¨ãŒå¤§äº‹ã ã—ã€ãã‚Œã¯è¦ªã‚‚åŒã˜ã€‚å®¶ã§ã®å­¦ã³ã‚‚ã™ã”ãé‡è¦ã§ã€è¦ªãŒè‡ªåˆ†ã§ç–‘å•ã‚’æŒã£ã¦è€ƒãˆã‚‹å§¿ã‚’å­ä¾›ã«è¦‹ã›ã‚‹ã“ã¨ãŒã€å­ä¾›ã®å¥½å¥‡å¿ƒã‚’è‚²ã¦ã‚‹ã‚“ã ã€‚
ã¤ã¾ã‚Šã€å­¦æ ¡ã‚„å¡¾ã ã‘ã˜ã‚ƒãªãã¦ã€å®¶ã§ã‚‚è¦ªãŒå­ä¾›ã¨ä¸€ç·’ã«æ–°ã—ã„ã“ã¨ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸã‚Šã€è€ƒãˆãŸã‚Šã™ã‚‹ã“ã¨ãŒã€å­ä¾›ã®æˆé•·ã«ã¨ã£ã¦ã¯ã‚ã¡ã‚ƒãã¡ã‚ƒå¤§äº‹ã£ã¦ã‚ã‘ã€‚ãã†ã™ã‚‹ã¨ã€å®¶ã®ä¸­ã‚‚ã‚‚ã£ã¨æ¥½ã—ããªã£ã¦ã€è¦ªã®ä»•äº‹ã®ã‚„ã‚‹æ°—ã«ã‚‚ã¤ãªãŒã‚‹ã‚“ã ã€‚

###Input:
"""
            
            summarized_answer = ""
            summarized_sentence = f"""
### Instruction:
{translated_theme}
Briefly summarize the following sentences in one sentence.

### Condition:
Please write in Japanese.
Please make sure that the text is chewed up in a way that high school students can understand.
Please add a logical connection and a conjunction to the the text below.
{summarized_answer}

###Input:
ãŸã å•é¡Œã®ç­”ãˆã‚’æ•™ãˆè¾¼ã‚€å¤ã„ã‚„ã‚Šæ–¹ã§ã¯ãªãã€ãªãœãã†ãªã‚‹ã®ã‹ã‚’è€ƒãˆãŸã‚Šã€æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã‚Šã™ã‚‹å­¦ã³ãŒå¤§åˆ‡ã ã£ã¦è©±ã ã‚ˆã€‚ãƒãƒƒãƒˆã‚„ChatGPTã¿ãŸã„ãªè³¢ã„ãƒ„ãƒ¼ãƒ«ãŒãŸãã•ã‚“ã‚ã‚‹ã‹ã‚‰ã€å˜ç´”ãªæš—è¨˜ã‚„è¨ˆç®—ã¯ã‚‚ã†äººé–“ãŒã‚ã–ã‚ã–ã‚„ã‚‹ã“ã¨ã˜ã‚ƒãªããªã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ãªã€‚ã§ã‚‚ã€å­¦æ ¡ãŒä»Šã®ã¾ã¾è©°ã‚è¾¼ã¿ã§ç‚¹æ•°ã ã‘è¿½ã„ã‹ã‘ã‚‹æ•™è‚²ã‚’ç¶šã‘ãŸã‚‰ã€æœ¬å½“ã«å¿…è¦ãªã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã‚‰ã‚Œãªã„å¤§äººã«ãªã£ã¦ã—ã¾ã†ã‚ˆã€‚
ã“ã‚Œã‹ã‚‰ã¯ã€ç­”ãˆãŒã™ãã«ã¯å‡ºãªã„ã‚ˆã†ãªå•é¡Œã«ã©ã†ç«‹ã¡å‘ã‹ã†ã‹ã€è‡ªåˆ†ã®å¥½ããªã“ã¨ã‚’è¦‹ã¤ã‘ã¦æ·±ãæŽ˜ã‚Šä¸‹ã’ã‚‹å­¦ã³ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚“ã ã€‚å…ˆç”ŸãŸã¡ã‚‚æ˜”ã®ã‚„ã‚Šæ–¹ã‹ã‚‰å¤‰ã‚ã£ã¦ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«è€ƒãˆã‚‹ã“ã¨ãŒå¤§äº‹ã ã—ã€ãã‚Œã¯è¦ªã‚‚åŒã˜ã€‚å®¶ã§ã®å­¦ã³ã‚‚ã™ã”ãé‡è¦ã§ã€è¦ªãŒè‡ªåˆ†ã§ç–‘å•ã‚’æŒã£ã¦è€ƒãˆã‚‹å§¿ã‚’å­ä¾›ã«è¦‹ã›ã‚‹ã“ã¨ãŒã€å­ä¾›ã®å¥½å¥‡å¿ƒã‚’è‚²ã¦ã‚‹ã‚“ã ã€‚
ã¤ã¾ã‚Šã€å­¦æ ¡ã‚„å¡¾ã ã‘ã˜ã‚ƒãªãã¦ã€å®¶ã§ã‚‚è¦ªãŒå­ä¾›ã¨ä¸€ç·’ã«æ–°ã—ã„ã“ã¨ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸã‚Šã€è€ƒãˆãŸã‚Šã™ã‚‹ã“ã¨ãŒã€å­ä¾›ã®æˆé•·ã«ã¨ã£ã¦ã¯ã‚ã¡ã‚ƒãã¡ã‚ƒå¤§äº‹ã£ã¦ã‚ã‘ã€‚ãã†ã™ã‚‹ã¨ã€å®¶ã®ä¸­ã‚‚ã‚‚ã£ã¨æ¥½ã—ããªã£ã¦ã€è¦ªã®ä»•äº‹ã®ã‚„ã‚‹æ°—ã«ã‚‚ã¤ãªãŒã‚‹ã‚ˆã€‚

###Output:
ã„ã¾ã®æ™‚ä»£ã¯ã€å˜ç´”ãªæš—è¨˜ã‚ˆã‚Šã‚‚è€ƒãˆã‚‹åŠ›ã‚„æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã™ã‚‹åŠ›ã‚’è‚²ã¦ã‚‹å­¦ã³ãŒå¤§åˆ‡ãªã‚“ã ã€‚ãã—ã¦ã€å®¶åº­ã§ã‚‚è¦ªãŒå­ä¾›ã¨ä¸€ç·’ã«å­¦ã¶ã“ã¨ãŒã§ãã‚Œã°ã€å­ä¾›ã ã‘ã˜ã‚ƒãªãã¦è¦ªã®æˆé•·ã«ã‚‚ã¤ãªãŒã‚‹ã£ã¦ã‚ã‘ã€‚

###Input:
"""

            converted_markdown = headline_to_list(markdown_text)

            st.markdown(converted_markdown)

            segmented_markdown = segmented_by_three(markdown_text)
            combined_list = []
            simplified_list = []
            summarized_list = []

            for segment in segmented_markdown:

                st.session_state.messages.append(SystemMessage(content=sentence))
                st.session_state.messages.append(HumanMessage(content=segment))
                with st.spinner("KJ-GPTãŒæ–‡ç« åŒ–ã—ã¦ã„ã¾ã™ ..."):
                    answer, cost = get_answer(llm, st.session_state.messages[-2:])
                # ã‚‚ã—ç­”ãˆãŒ(1)ãªã©ã§å§‹ã¾ã£ã¦ã„ãŸã‚‰ã€ãã®å‰ã«æ”¹è¡Œã‚’è¿½åŠ 
                if answer.startswith("("):
                    answer = "\n" + answer
                combined_list.append(answer)
                st.session_state.messages.append(AIMessage(content=answer))
                st.session_state.costs.append(cost)

                st.session_state.messages.append(SystemMessage(content=simplifying_sentence))
                st.session_state.messages.append(HumanMessage(content=answer))
                with st.spinner("KJ-GPTãŒæ–‡ç« åŒ–ã—ã¦ã„ã¾ã™ ..."):
                    simplified_answer, cost = get_answer(llm, st.session_state.messages[-2:])
                # ã‚‚ã—ç­”ãˆãŒ(1)ãªã©ã§å§‹ã¾ã£ã¦ã„ãŸã‚‰ã€ãã®å‰ã«æ”¹è¡Œã‚’è¿½åŠ 
                if simplified_answer.startswith("("):
                    simplified_answer = "\n" + simplified_answer
                simplified_list.append(simplified_answer)
                st.session_state.messages.append(AIMessage(content=simplified_answer))

            #     st.session_state.messages.append(SystemMessage(content=summarized_sentence))
            #     st.session_state.messages.append(HumanMessage(content=simplified_answer))
            #     with st.spinner("KJ-GPTãŒæ–‡ç« åŒ–ã—ã¦ã„ã¾ã™ ..."):
            #         summarized_answer, cost = get_answer(llm, st.session_state.messages[-2:])
            #     summarized_list.append(summarized_answer)
            #     st.session_state.messages.append(AIMessage(content=summarized_answer))

            combined_sentences = "\n".join(combined_list)
            simplified_sentences = "\n".join(simplified_list)
            # summarized_sentences = "\n".join(summarized_list)
            st.markdown(combined_sentences)
            st.markdown(simplified_sentences)
            # st.markdown(summarized_sentences)

            

        # if labeling_button and user_input:
        #     lines = count_newlines(user_input)
        #     if lines >= 35:
        #         prompt_ptrn = labeling1
        #     elif 25 <= lines < 35:
        #         prompt_ptrn = labeling2
        #     elif 15 <= lines < 25:
        #         prompt_ptrn = labeling3
        #     elif 11 <= lines < 15:
        #         prompt_ptrn = labeling4
        #     else:
        #         prompt_ptrn = labeling5
        #     st.session_state.messages.append(SystemMessage(content=prompt_ptrn))
        #     st.session_state.messages.append(HumanMessage(content=user_input))
        #     print(st.session_state.messages[-2:])
        #     with st.spinner("KJ-GPTãŒè¡¨æœ­ã‚’è€ƒãˆã¦ã„ã¾ã™ ..."):
        #         answer, cost = get_answer(llm, st.session_state.messages[-2:])
        #     st.session_state.messages.append(AIMessage(content=answer))
        #     st.session_state.costs.append(cost)

        # if symbol_button and user_input:
        #     st.session_state.messages.append(SystemMessage(content=symbol))
        #     st.session_state.messages.append(HumanMessage(content=user_input))
        #     print(st.session_state.messages[-2:])
        #     with st.spinner("KJ-GPTãŒå…¥åŠ›ã—ã¦ã„ã¾ã™ ..."):
        #         answer, cost = get_answer(llm, st.session_state.messages[-2:])
        #     st.session_state.messages.append(AIMessage(content=answer))
        #     st.session_state.costs.append(cost)

    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º
    messages = st.session_state.get("messages", [])
    for message in messages:
        if isinstance(message, AIMessage):
            with st.chat_message("assistant"):
                st.markdown(message.content)
        elif isinstance(message, HumanMessage):
            with st.chat_message("user"):
                st.markdown(message.content)
        # else:
        #     st.write(f"System message: {message.content}")

    # ã‚³ã‚¹ãƒˆã®è¨ˆç®—ã¨è¡¨ç¤º
    costs = st.session_state.get('costs', [])
    st.sidebar.markdown("## Costs")
    st.sidebar.markdown(f"**Total cost: ${sum(costs):.5f}**")
    for cost in costs:
        st.sidebar.markdown(f"- ${cost:.5f}")

if __name__ == "__main__":
    main()