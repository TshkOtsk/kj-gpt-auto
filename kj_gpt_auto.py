from logging import basicConfig
from urllib import response
import streamlit as st
from langchain.chat_models import ChatOpenAI
from langchain.schema import (
    SystemMessage,
    HumanMessage,
    AIMessage
)
from langchain.callbacks import get_openai_callback

import re
import urllib.parse
import random

import requests

from datasets.download import DownloadManager
from datasets import load_dataset
from sentence_transformers import SentenceTransformer
import faiss

theme = ""
prompt_ptrn = ""

# ä¾‹ç¤ºãƒ‡ãƒ¼ã‚¿ã®å‡ºå…¸
# ã€Œä½•ã¨ãªãæ°—ã«ãªã‚‹èˆˆå‘³é–¢å¿ƒã«ã¤ã„ã¦ã€
# å››æ³¨è¨˜ (1) 2023/10/26-10/31(2)è‡ªå®… (3) ãƒžãƒ³ãƒ€ãƒ©ãƒãƒ£ãƒ¼ãƒˆã‚’ã‚‚ã¨ã«ãƒ–ãƒ¬ã‚¹ãƒˆã—ã¦å‡ºãŸã‚¢ã‚¤ãƒ‡ã‚¢(4)Toshiki Otsuka


def prompt_grouping(lines, translated_theme):
    theme = translated_theme
    grouping1 = f"""
### Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.

### Condition:
Please write in Japanese.
Each group should have at most 3 items. Items that cannot be grouped should be listed as is.
Items with conflicting content should be grouped separately.

### Input:
é£Ÿå“ãƒ­ã‚¹ã‚’ã©ã†ã‚„ã£ã¦æ¸›ã‚‰ã›ã°ã„ã„ã‹æ°—ã«ãªã‚‹
æ­´å²ã‚ã‚‹äº¬éƒ½ã®ç”ºä¸¦ã¿ãŒã¨ã¦ã‚‚å¥½ãã 
åœ°åŸŸã§ä½œã£ãŸã‚‚ã®ã¯åœ°å…ƒã§é£Ÿã¹ãŸã»ã†ãŒã„ã„
æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
åœ°å…ƒã®ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒã‚ã‚Œã°é£Ÿã¹ãŸã„
ä½ã‚“ã§ã„ã‚‹ç¦å³¶çœŒã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã‚‚ã£ã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ä½ã‚“ã§ã„ã‚‹åœ°åŸŸã®äººå£ãŒã©ã‚“ã©ã‚“æ¸›ã£ã¦ã„ã¦ä¸å®‰
ä¿®å­¦æ—…è¡Œã§è¡Œãäº¬éƒ½ã®åº§ç¦…ä½“é¨“ãŒãŸã®ã—ã¿
å‹é”ã¨éŠã¶ã¨ãã«äº¤é€šæ‰‹æ®µãŒå°‘ãªã„ã®ãŒæ‚©ã¿

### Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
åœ°å…ƒã®ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒã‚ã‚Œã°é£Ÿã¹ãŸã„
ä½ã‚“ã§ã„ã‚‹ç¦å³¶çœŒã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã‚‚ã£ã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—2:
å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—3:
é£Ÿå“ãƒ­ã‚¹ã‚’ã©ã†ã‚„ã£ã¦æ¸›ã‚‰ã›ã°ã„ã„ã‹æ°—ã«ãªã‚‹
åœ°åŸŸã§ä½œã£ãŸã‚‚ã®ã¯åœ°å…ƒã§é£Ÿã¹ãŸã»ã†ãŒã„ã„
ã‚°ãƒ«ãƒ¼ãƒ—4:
ä½ã‚“ã§ã„ã‚‹åœ°åŸŸã®äººå£ãŒã©ã‚“ã©ã‚“æ¸›ã£ã¦ã„ã¦ä¸å®‰
å‹é”ã¨éŠã¶ã¨ãã«äº¤é€šæ‰‹æ®µãŒå°‘ãªã„ã®ãŒæ‚©ã¿
ã‚°ãƒ«ãƒ¼ãƒ—5:
ä¿®å­¦æ—…è¡Œã§è¡Œãäº¬éƒ½ã®åº§ç¦…ä½“é¨“ãŒãŸã®ã—ã¿
æ­´å²ã‚ã‚‹äº¬éƒ½ã®ç”ºä¸¦ã¿ãŒã¨ã¦ã‚‚å¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—6:
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
ã‚°ãƒ«ãƒ¼ãƒ—7:
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
ã‚°ãƒ«ãƒ¼ãƒ—8:
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ã‚°ãƒ«ãƒ¼ãƒ—9:
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ã‚°ãƒ«ãƒ¼ãƒ—10:
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
ã‚°ãƒ«ãƒ¼ãƒ—11:
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
ã‚°ãƒ«ãƒ¼ãƒ—12:
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—13:
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
ã‚°ãƒ«ãƒ¼ãƒ—14:
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
ã‚°ãƒ«ãƒ¼ãƒ—15:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚°ãƒ«ãƒ¼ãƒ—16:
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—17:
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

### Input:
"""
    grouping2 = f"""
### Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.

### Condition:
Please write in Japanese.
Each group should have at most 3 items. Items that cannot be grouped should be listed as is.
Items with conflicting content should be grouped separately.

### Input:
ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„
ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹
äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

### Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
ã‚°ãƒ«ãƒ¼ãƒ—2:
ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
ã‚°ãƒ«ãƒ¼ãƒ—3:
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
ã‚°ãƒ«ãƒ¼ãƒ—4:
ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹
äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…
ã‚°ãƒ«ãƒ¼ãƒ—5:
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
ã‚°ãƒ«ãƒ¼ãƒ—6:
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
ã‚°ãƒ«ãƒ¼ãƒ—7:
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ã‚°ãƒ«ãƒ¼ãƒ—8:
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ã‚°ãƒ«ãƒ¼ãƒ—9:
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—10:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚°ãƒ«ãƒ¼ãƒ—11:
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—12:
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

### Input:
"""
    grouping3 = f"""
### Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.

### Condition:
Please write in Japanese.
Each group should have at most 3 items. Items that cannot be grouped should be listed as is.
Items with conflicting content should be grouped separately.

### Input:
è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã®å¼·ã¿ã‚’ç”Ÿã‹ã—ã¦ã€ç¦å³¶çœŒã‚’ç››ã‚Šä¸Šã’ãŸã„
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã£ã¦ã„ãã‹ã‚‰ã“ãã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’ç¶­æŒã—ãŸã„
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

### Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã®å¼·ã¿ã‚’ç”Ÿã‹ã—ã¦ã€ç¦å³¶çœŒã‚’ç››ã‚Šä¸Šã’ãŸã„
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã£ã¦ã„ãã‹ã‚‰ã“ãã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’ç¶­æŒã—ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—2:
è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—3:
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
ã‚°ãƒ«ãƒ¼ãƒ—4:
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚°ãƒ«ãƒ¼ãƒ—5:
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
ã‚°ãƒ«ãƒ¼ãƒ—6:
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ã‚°ãƒ«ãƒ¼ãƒ—7:
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—8:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚°ãƒ«ãƒ¼ãƒ—9:
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

### Input:
"""
    grouping4 = f"""
### Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.

### Condition:
Please write in Japanese.
Each group should have at most 3 items. Items that cannot be grouped should be listed as is.
Items with conflicting content should be grouped separately.

### Input:
ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã‚Šã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„
äº¬éƒ½ã§ã®æ•£ç­–ã‚„åº§ç¦…ãªã©ã€æ­´å²ã‚ã‚‹åœŸåœ°ã«è¡Œã‹ãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«æ¥½ã—ã¿ãŸã„
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

### Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã‚Šã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„
äº¬éƒ½ã§ã®æ•£ç­–ã‚„åº§ç¦…ãªã©ã€æ­´å²ã‚ã‚‹åœŸåœ°ã«è¡Œã‹ãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«æ¥½ã—ã¿ãŸã„
ã‚°ãƒ«ãƒ¼ãƒ—2:
æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
ã‚°ãƒ«ãƒ¼ãƒ—3:
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
ã‚°ãƒ«ãƒ¼ãƒ—4:
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—5:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚°ãƒ«ãƒ¼ãƒ—6:
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

### Input:
"""
    grouping5 = f"""
### Instruction:
{theme}
Please group all of these items with those that are closer in deeper underlying meaning.

### Condition:
Please write in Japanese.
Each group should have at most 3 items. Items that cannot be grouped should be listed as is.
Items with conflicting content should be grouped separately.

### Input:
è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªã‚‰ã‚‚ãã†ã—ãŸåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„
ä¾‹ãˆã°å¹´é½¢å·®ã‚„éšœå®³ã®æœ‰ç„¡ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸã‚ˆã†ãªå¸¸è­˜ã®æž ã«æ‰ã‚ã‚Œãšã€æœ¬è³ªçš„ãªæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹

### Output:
ã‚°ãƒ«ãƒ¼ãƒ—1:
è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªã‚‰ã‚‚ãã†ã—ãŸåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
ã‚°ãƒ«ãƒ¼ãƒ—2:
ä¾‹ãˆã°å¹´é½¢å·®ã‚„éšœå®³ã®æœ‰ç„¡ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸã‚ˆã†ãªå¸¸è­˜ã®æž ã«æ‰ã‚ã‚Œãšã€æœ¬è³ªçš„ãªæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹
ã‚°ãƒ«ãƒ¼ãƒ—3:
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
ã‚°ãƒ«ãƒ¼ãƒ—4:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„

### Input:
"""
    if lines >= 20:
        prompt_ptrn = grouping1
    elif 15 <= lines < 20:
        prompt_ptrn = grouping2
    elif 10 <= lines < 15:
        prompt_ptrn = grouping3
    elif 6 <= lines < 10:
        prompt_ptrn = grouping4
    else:
        prompt_ptrn = grouping5
    return prompt_ptrn

def theme_translate(user_theme,openai_api_key):
    theme = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹ã®ã¯ã€" + user_theme + "ã«ã¤ã„ã¦ã®ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚"
    llm = ChatOpenAI(openai_api_key=openai_api_key, temperature=0, model_name="gpt-3.5-turbo-0613")
    translating_prompt = f"""
Please translate the following Japanese sentence into English.
{theme}
"""
    st.session_state.messages.append(SystemMessage(content=translating_prompt))
    with st.spinner("KJ-GPTãŒãƒ†ãƒ¼ãƒžã‚’åˆ†æžã—ã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-1:])
    translated_theme = answer
    st.session_state.costs.append(cost)
    st.session_state["translated_theme"] = translated_theme
    return translated_theme

def eng_translates(text,openai_api_key):
    llm = ChatOpenAI(openai_api_key=openai_api_key, temperature=0, model_name="gpt-3.5-turbo-16k-0613")
    translating_prompt = f"""
Please translate the following Japanese sentence into English.
{text}
"""
    st.session_state.messages.append(SystemMessage(content=translating_prompt))
    with st.spinner("KJ-GPTãŒå†…å®¹ã‚’åˆ†æžã—ã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-1:])
    translated_text = answer
    st.session_state.costs.append(cost)
    return translated_text

def summarize(text,openai_api_key):
    llm = ChatOpenAI(openai_api_key=openai_api_key, temperature=0.7, model_name="gpt-4-1106-preview")
    translating_prompt = f"""
### Instruction:
Act as an introspective person who excels at looking deep into his or her own mind.
Briefly summarise the following statement in about 50 words.

### Conditions:
Please write in Japanese.

### Input:
ï¼ˆãã®ä¸­ã§ã‚‚ä¸€ç•ªæ°—ã«ãªã£ã¦ã„ã‚‹ã®ãŒã€ï¼‰å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œã¨ã„ã†ã“ã¨ã€‚ï¼ˆç­”ãˆã®ã‚ã‚‹å•é¡Œã‚’ãŸã å¼·åˆ¶çš„ã«è§£ç­”ã•ã›ã‚‰ã‚Œã‚‹ã®ã¯ç„¡é§„ã ã¨æ€ã†ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„ChatGPTãªã©ãŒæ€¥é€Ÿã«ç™ºå±•ã—ã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã£ãŸå˜ãªã‚‹æš—è¨˜ã‚„è«–ç†è¨ˆç®—ã¯ã€ãã®ã†ã¡äººé–“ãŒã‚„ã‚‹å¿…è¦ã¯ãªããªã‚‹ã¨æ€ã†ã€‚ãã‚Œãªã®ã«ã€ã“ã®ã¾ã¾åå·®å€¤è‡³ä¸Šä¸»ç¾©ã®è©°ã‚è¾¼ã¿æ•™è‚²ã§ä»Šå¾Œã‚‚ã‚„ã£ã¦ã„ããªã‚‰ã°ã€ä½•ã®å½¹ã«ã‚‚ç«‹ãŸãªã„å¤§äººã‚’è‚²ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚ï¼‰
ãã†ã§ã¯ãªãã¦ã€ã‚‚ã£ã¨æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„ã€‚ï¼ˆç­”ãˆã®ãªã„å•ã„ã«è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ç«‹ã¡å‘ã‹ã£ãŸã‚Šã€è‡ªåˆ†ã ã‘ã®ç‰¹åˆ¥ãªèˆˆå‘³é–¢å¿ƒã‚’è‚²ã¦ã¦å°‚é–€æ€§ã‚’é«˜ã‚ãŸã‚Šã™ã‚‹å‹‰å¼·ã®æ–¹ãŒä»Šå¾Œæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã¯æ˜Žã‚‰ã‹ã ã€‚ï¼‰ã¤ã¾ã‚Šã€ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„ã¨ã„ã†ã“ã¨ã€‚ãã—ã¦ãã®ãŸã‚ã«ã¯ã€å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†ã€‚
ï¼ˆãã‚‚ãã‚‚ä»Šã®æ•™å¸«ãŒæ˜”ãªãŒã‚‰ã®è©°ã‚è¾¼ã¿å¼ã®æ•™è‚²ã§è‚²ã£ãŸã®ã§ã€ãã®æ„è­˜æ”¹é©ãŒå¿…è¦ã ã€‚æ•™å¸«è‡ªèº«ãŒç­”ãˆã®ãªã„è‡ªåˆ†ã®å¿ƒã®åº•ã‹ã‚‰å‡ºã¦ããŸå•ã„ã‚’è¨­å®šã—ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«ãã‚Œã«å–ã‚Šçµ„ã‚€å§¿å‹¢ã‚’è¦‹ã›ãªã„ã¨ã€å­ä¾›é”ã¯ã¤ã„ã¦ã„ã‹ãªã„ã€‚ãã‚Œã ã‘ã§ã¯ãªãã€å­ä¾›ã®è¦ªãŸã¡ã‚‚æ–°ã—ã„å­¦ã³ã‚’äººç”Ÿã«å–ã‚Šå…¥ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ç­”ãˆã®ãªã„æŽ¢ç©¶æ´»å‹•ã¯å¾“æ¥ã®å­¦ç¿’ã«æ¯”ã¹ã¦ã€ã‚ˆã‚Šæ—¥å¸¸ç”Ÿæ´»ã«æ·±ãé–¢ã‚ã‚‹ã‚‚ã®ã ã€‚æ™®æ®µéŽã”ã—ã¦ã„ã‚‹ä¸­ã§æ„Ÿã˜ã‚‹ç–‘å•ã‚„é•å’Œæ„Ÿãªã©ã‚’èµ·ç‚¹ã«ã—ãŸã€å®Ÿä½“é¨“ã«å³ã—ãŸå•ã„ã§ã‚ã‚‹ã»ã©ã€ä»Šå¾Œã®é•·ã„äººç”Ÿã§å–ã‚Šçµ„ã‚€ã«å€¤ã™ã‚‹æ·±ã„ã‚‚ã®ã«ãªã‚Šã‚„ã™ã„ã€‚ãªã®ã§ã€ã“ã‚Œã¾ã§ã®ã‚ˆã†ã«è¦ªãŒæ•™è‚²ã‚’å­¦æ ¡ã‚„å¡¾ã«ä»»ã›ã£ã±ãªã—ã«ã—ã¦ã€å®¶åº­ã§å­ä¾›ã«ç„¡é–¢å¿ƒã§ã„ã¦ã¯å­ä¾›ã®æŽ¢ç©¶å¿ƒãŒè‚²ã¡ã«ãããªã‚‹ã€‚æ•™å¸«ã¨åŒã˜ã‚ˆã†ã«ã€è¦ªãŸã¡ã‚‚è‡ªåˆ†ã®å•ã„ã‚’ç«‹ã¦ã¦ãã‚Œã‚’è¿½æ±‚ã™ã‚‹å–¶ã¿ã‚’å®Ÿéš›ã«ã‚„ã‚‹ã¹ãã ã€‚ãã—ã¦ã€ãã®è¡Œå‹•ãŒå­ä¾›ãŸã¡ã‚’æ„ŸåŒ–ã•ã›ã€å®¶åº­ã‚’æ´»æ°—ã¥ã‹ã›ã¦ã€ã•ã‚‰ã«ã¯è·å ´ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚‚ä¸Šã’ã‚‹ã“ã¨ã«ãªã‚‹ã®ãŒç†æƒ³ã ã€‚ï¼‰ã“ã‚Œã‚‰ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ãªã®ã ã¨è¨€ãˆã‚‹ã€‚

### Output:
è€ƒãˆã‚‹åŠ›ã‚„æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã™ã‚‹åŠ›ã‚’è‚²ã‚€ã‚ˆã†ãªæœ¬å½“ã«æ„å‘³ã®ã‚ã‚‹å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚å¤§åˆ‡ã ã€‚

### Input:
{text}
"""
    st.session_state.messages.append(SystemMessage(content=translating_prompt))
    with st.spinner("KJ-GPTãŒå†…å®¹ã‚’è¦ç´„ã—ã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-1:])
    summarized_text = answer
    st.session_state.costs.append(cost)
    return summarized_text

def data_generating(user_theme,openai_api_key):
    theme = user_theme
    llm = ChatOpenAI(openai_api_key=openai_api_key, temperature=0, model_name="gpt-3.5-turbo-0613")
    translating_prompt = f"""
Please translate the following Japanese sentence into English.
{theme}
"""
    st.session_state.messages.append(SystemMessage(content=translating_prompt))
    with st.spinner("KJ-GPTãŒãƒ†ãƒ¼ãƒžã«ã¤ã„ã¦è€ƒãˆã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-1:])
    translated_theme = answer
    st.session_state.costs.append(cost)

    generating_prompt = f"""
### Instruction:
Please list about 15 bulleted assertions or opinions from a variety of perspectives, including those that may be somehow related to the following topic.
Items should begin with the letter "ãƒ»".
Items should be generated with more subjective items that are full of emotions and feelings.
Keep sentences as concise as possible, avoiding duplication.
Please write in Japanese.

### Topic:
{translated_theme}
"""
    return generating_prompt

# labeling1 = """
# ### Instructions:
# Please summarize the items of groups in one concise sentence with a deeper meaning.

# ### Conditions:
# Please write in Japanese.

# ###Input:
# åœ°å…ƒã®ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒã‚ã‚Œã°é£Ÿã¹ãŸã„
# ä½ã‚“ã§ã„ã‚‹ç¦å³¶çœŒã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã‚‚ã£ã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„
# ###Output:
# ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„

# ###Input:
# å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
# æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„
# ###Output:
# ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„

# ###Input:
# é£Ÿå“ãƒ­ã‚¹ã‚’ã©ã†ã‚„ã£ã¦æ¸›ã‚‰ã›ã°ã„ã„ã‹æ°—ã«ãªã‚‹
# åœ°åŸŸã§ä½œã£ãŸã‚‚ã®ã¯åœ°å…ƒã§é£Ÿã¹ãŸã»ã†ãŒã„ã„
# ###Output:
# ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹

# ###Input:
# ä½ã‚“ã§ã„ã‚‹åœ°åŸŸã®äººå£ãŒã©ã‚“ã©ã‚“æ¸›ã£ã¦ã„ã¦ä¸å®‰
# å‹é”ã¨éŠã¶ã¨ãã«äº¤é€šæ‰‹æ®µãŒå°‘ãªã„ã®ãŒæ‚©ã¿
# ###Output:
# äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…

# ###Input:
# ä¿®å­¦æ—…è¡Œã§è¡Œãäº¬éƒ½ã®åº§ç¦…ä½“é¨“ãŒãŸã®ã—ã¿
# æ­´å²ã‚ã‚‹äº¬éƒ½ã®ç”ºä¸¦ã¿ãŒã¨ã¦ã‚‚å¥½ãã 
# ###Output:
# è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã

# ### Input:
# """

# labeling2 = """
# ### Instructions:
# Please summarize the items of groups in one concise sentence with a deeper meaning.

# ### Conditions:
# Please write in Japanese.

# ###Input:
# ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„
# ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
# ###Output:
# è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã®å¼·ã¿ã‚’ç”Ÿã‹ã—ã¦ã€ç¦å³¶çœŒã‚’ç››ã‚Šä¸Šã’ãŸã„

# ###Input:
# ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
# å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
# ###Output:
# æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 

# ###Input:
# ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
# ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
# å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
# ###Output:
# ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹

# ###Input:
# ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹
# äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…
# ###Output:
# ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã£ã¦ã„ãã‹ã‚‰ã“ãã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’ç¶­æŒã—ãŸã„

# ### Input:
# """

# labeling3 = """
# ### Instructions:
# Please summarize the items of groups in one concise sentence with a deeper meaning.

# ### Conditions:
# Please write in Japanese.

# ###Input:
# è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã®å¼·ã¿ã‚’ç”Ÿã‹ã—ã¦ã€ç¦å³¶çœŒã‚’ç››ã‚Šä¸Šã’ãŸã„
# ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã£ã¦ã„ãã‹ã‚‰ã“ãã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’ç¶­æŒã—ãŸã„
# ###Output:
# ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã‚Šã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„

# ###Input:
# è¡—ä¸¦ã¿ã‚„åº§ç¦…ãªã©æ­´å²ã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
# æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
# ###Output:
# äº¬éƒ½ã§ã®æ•£ç­–ã‚„åº§ç¦…ãªã©ã€æ­´å²ã‚ã‚‹åœŸåœ°ã«è¡Œã‹ãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«æ¥½ã—ã¿ãŸã„

# ###Input:
# æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
# æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
# ###Output:
# ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹

# ### Input:
# """

# labeling4 = """
# ### Instructions:
# Please summarize the items of groups in one concise sentence with a deeper meaning.

# ### Conditions:
# Please write in Japanese.

# ###Input:
# ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã‚Šã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„
# äº¬éƒ½ã§ã®æ•£ç­–ã‚„åº§ç¦…ãªã©ã€æ­´å²ã‚ã‚‹åœŸåœ°ã«è¡Œã‹ãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«æ¥½ã—ã¿ãŸã„
# ###Output:
# è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªã‚‰ã‚‚ãã†ã—ãŸåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„

# ###Input:
# æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
# ã‚¹ãƒãƒ¼ãƒ„ã®é­…åŠ›ã¯ã€ç«¶æŠ€ãŒä¸Šæ‰‹ã„ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
# éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
# ###Output:
# ä¾‹ãˆã°å¹´é½¢å·®ã‚„éšœå®³ã®æœ‰ç„¡ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸã‚ˆã†ãªå¸¸è­˜ã®æž ã«æ‰ã‚ã‚Œãšã€æœ¬è³ªçš„ãªæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹

# ### Input:
# """

# labeling5 = """
# ### Instructions:
# Please summarize the items of groups in one concise sentence with a deeper meaning.

# ### Conditions:
# Please write in Japanese.

# ###Input:
# è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªã‚‰ã‚‚ãã†ã—ãŸåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„
# ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
# ###Output:
# ãã®åœŸåœ°åœŸåœ°ãŒæŒã¤æ­´å²ã‚„è‡ªç„¶ç’°å¢ƒã€é£Ÿæ–‡åŒ–ã‚„é›°å›²æ°—ãªã©ã‚’ã€è‡ªåˆ†ã‹ã‚‰æ¥½ã—ã¿ã€ãã—ã¦åºƒã‚ãŸã„

# ###Input:
# ä¾‹ãˆã°å¹´é½¢å·®ã‚„éšœå®³ã®æœ‰ç„¡ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸã‚ˆã†ãªå¸¸è­˜ã®æž ã«æ‰ã‚ã‚Œãšã€æœ¬è³ªçš„ãªæœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹
# ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹
# ###Output:
# æ—¢å­˜ã®æž çµ„ã¿ã‚„å¯¾ç«‹è»¸ã‚’ã¯ã¿å‡ºã—ã¦ã§ã‚‚ã€æœ¬å½“ã«å¤§åˆ‡ãªè¡Œå‹•ã‚’èµ·ã“ã—ã€å¹³å’Œãªæœªæ¥ã‚’ç›®æŒ‡ã—ãŸã„

# ### Input:
# """

# symbol = """
# ### Instructions:
# Act as an introspective artist who excels at looking deep into his or her own mind.
# Paraphrase each group of sentences in a single word that can be understood instantaneously.

# ### Conditions:
# Please write in Japanese.
# Rephrase it with an adjective, verb or metaphor in Japanese.

# ###Input:
# ãã®åœŸåœ°åœŸåœ°ãŒæŒã¤æ­´å²ã‚„è‡ªç„¶ç’°å¢ƒã€é£Ÿæ–‡åŒ–ã‚„é›°å›²æ°—ãªã©ã‚’ã€è‡ªåˆ†ã‹ã‚‰æ¥½ã—ã¿ã€ãã—ã¦åºƒã‚ãŸã„
# ###Output:
# åœ°åŸŸç‹¬ç‰¹ã®é¢¨åœŸ

# ###Input:
# æ—¢å­˜ã®æž çµ„ã¿ã‚„å¯¾ç«‹è»¸ã‚’ã¯ã¿å‡ºã—ã¦ã§ã‚‚ã€æœ¬å½“ã«å¤§åˆ‡ãªè¡Œå‹•ã‚’èµ·ã“ã—ã€å¹³å’Œãªæœªæ¥ã‚’ç›®æŒ‡ã—ãŸã„
# ###Output:
# å¸¸è­˜ã¯ãšã‚Œã®å¤§åˆ‡ãªè¡Œå‹•

# ###Input:
# ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã‚ˆã†ãªã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
# ###Output:
# æ¼«ç”»ãªã‚‰ã§ã¯ã®æ„Ÿå‹•

# ###Input:
# ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
# ###Output:
# ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ãƒˆ

# ### Input:
# """

labeling1 = """
### Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

### Conditions:
Please write in Japanese.

###Input:
åœ°å…ƒã®ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒã‚ã‚Œã°é£Ÿã¹ãŸã„
ä½ã‚“ã§ã„ã‚‹ç¦å³¶çœŒã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã‚‚ã£ã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„
###Output:
ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„

###Input:
å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„
###Output:
æ¯Žæ—¥ã®å®¿é¡Œã‚’ãŸã ã“ãªã™ã‚“ã˜ã‚ƒãªãã€æœªæ¥ã«ã¨ã£ã¦æ„å‘³ãŒã‚ã‚‹ã“ã¨ã‚’å­¦ã³ãŸã„

###Input:
é£Ÿå“ãƒ­ã‚¹ã‚’ã©ã†ã‚„ã£ã¦æ¸›ã‚‰ã›ã°ã„ã„ã‹æ°—ã«ãªã‚‹
åœ°åŸŸã§ä½œã£ãŸã‚‚ã®ã¯åœ°å…ƒã§é£Ÿã¹ãŸã»ã†ãŒã„ã„
###Output:
ãƒ ãƒ€ãŒãªãã¦åœ°åŸŸã¨ã¡ã‚ƒã‚“ã¨ã¤ãªãŒã£ãŸé£ŸãŒå¤§åˆ‡ã¨æ€ã£ã¦ã„ã‚‹

###Input:
ä½ã‚“ã§ã„ã‚‹åœ°åŸŸã®äººå£ãŒã©ã‚“ã©ã‚“æ¸›ã£ã¦ã„ã¦ä¸å®‰
å‹é”ã¨éŠã¶ã¨ãã«äº¤é€šæ‰‹æ®µãŒå°‘ãªã„ã®ãŒæ‚©ã¿
###Output:
äººå£ãŒã™ããªããªã£ã¦ã„ã£ã¦ã€ã¿ã‚“ãªã¨ã®äº¤æµãŒãªããªã‚‹ã®ãŒå¿ƒé…

###Input:
ä¿®å­¦æ—…è¡Œã§è¡Œãäº¬éƒ½ã®åº§ç¦…ä½“é¨“ãŒãŸã®ã—ã¿
æ­´å²ã‚ã‚‹äº¬éƒ½ã®ç”ºä¸¦ã¿ãŒã¨ã¦ã‚‚å¥½ãã 
###Output:
è¡—ä¸¦ã¿ã¨ã‹åº§ç¦…ã¨ã‹ã€æ­´å²ãŒã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã

### Input:
"""

labeling2 = """
### Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

### Conditions:
Please write in Japanese.

###Input:
ç¦å³¶çœŒã®ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã€ã”å½“åœ°ã‚¹ã‚¤ãƒ¼ãƒ„ãŒé£Ÿã¹ãŸã„
ç¦å³¶çœŒã®è‡ªç„¶ã‚’æ´»ã‹ã—ãŸç”ºãŠã“ã—ã«èˆˆå‘³ãŒã‚ã‚‹
###Output:
è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã€ç¦å³¶çœŒã®å¾—æ„ãªã¨ã“ã‚ã§ç››ã‚Šä¸Šã’ãŸã„

###Input:
ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
###Output:
å°†æ¥ã«ã¨ã£ã¦æ„å‘³ãŒã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´ã«é–¢ä¿‚ãªãèª°ã«ã¨ã£ã¦ã‚‚å¿…è¦

###Input:
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯ãªã‚“ã ã‚ã†
ãƒ‘ãƒ©ãƒªãƒ³ãƒ”ãƒƒã‚¯ã§è¦‹ãŸéšœç¢è€…ã®å§¿ã«æ„Ÿå‹•ã—ãŸ
å“çƒéƒ¨ã®éƒ¨æ´»ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ€ã‚µãã¦ã„ã‚„ã 
###Output:
ã‚¹ãƒãƒ¼ãƒ„ã®é¢ç™½ã•ã¯ã€ä¸Šæ‰‹ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹

###Input:
ç„¡é§„ãŒãªãã¦åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚ŠãŒå¤§åˆ‡ã ã¨æ€ã£ã¦ã„ã‚‹
äººå£ãŒæ¸›ã£ã¦ã„ãã€äººã¨ã®äº¤æµãŒãªããªã£ã¦ã„ãã®ãŒå¿ƒé…
###Output:
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã‚‹ä¸€æ–¹ã ã‹ã‚‰ã“ãã€åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’å¤§åˆ‡ã«ã—ãŸã„

### Input:
"""

labeling3 = """
### Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

### Conditions:
Please write in Japanese.

###Input:
è‡ªç„¶ã‚„æžœç‰©ã€ã‚¹ã‚¤ãƒ¼ãƒ„ãªã©ã€ç¦å³¶çœŒã®å¾—æ„ãªã¨ã“ã‚ã§ç››ã‚Šä¸Šã’ãŸã„
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå°ã•ããªã‚‹ã‹ã‚‰ã€åŠ¹çŽ‡çš„ã§åœ°å…ƒã«æ ¹ä»˜ã„ãŸé£Ÿã®ã¤ãªãŒã‚Šã‚’å¤§åˆ‡ã«ã—ãŸã„
###Output:
ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã£ã¦ã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„

###Input:
è¡—ä¸¦ã¿ã¨ã‹åº§ç¦…ã¨ã‹ã€æ­´å²ãŒã‚ã‚‹äº¬éƒ½ã§ã—ã‹å‘³ã‚ãˆãªã„ä½“é¨“ãŒå¥½ã
æ­´å²ãŒå¥½ããªå½¼å¥³ã‚’å–œã°ã›ãŸã„
###Output:
äº¬éƒ½ã®æ•£ç­–ã ã£ãŸã‚Šåº§ç¦…ãªã©ã§ã€æ­´å²ãŒã‚ã‚‹åœŸåœ°ã˜ã‚ƒãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«ã—ãŸã„

###Input:
æ¼«ç”»ã‚’ã‚¢ãƒ‹ãƒ¡åŒ–ã—ã¦ã‚‚ã€åŽŸä½œã‹ã‚‰å…¨ãé•ã†ã®ã«ãªã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«é£Ÿã‚ãªã„
æ„Ÿå‹•ã—ã¦æ³£ã‘ã‚‹ã‚ˆã†ãªæ¼«ç”»ãŒã™ãã 
###Output:
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹

### Input:
"""

labeling4 = """
### Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

### Conditions:
Please write in Japanese.

###Input:
ç¦å³¶çœŒã®è‡ªç„¶ã‚„æžœç‰©ã‚’æ´»ã‹ã—ãŸåœ°ç”£åœ°æ¶ˆã®ã¤ãªãŒã‚Šã‚’ä½œã£ã¦ã€äººãŒæ¸›ã£ã¦ã‚‚æ´»æ°—ã‚ã‚‹åœ°åŸŸã«ã—ãŸã„
äº¬éƒ½ã®æ•£ç­–ã ã£ãŸã‚Šåº§ç¦…ãªã©ã§ã€æ­´å²ãŒã‚ã‚‹åœŸåœ°ã˜ã‚ƒãªã„ã¨ã§ããªã„ä½“é¨“ã‚’å½¼å¥³ã¨ä¸€ç·’ã«ã—ãŸã„
###Output:
è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªåˆ†ã‚‚ãã‚“ãªåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„

###Input:
å°†æ¥ã«ã¨ã£ã¦æ„å‘³ãŒã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´ã«é–¢ä¿‚ãªãèª°ã«ã¨ã£ã¦ã‚‚é‡è¦
ã‚¹ãƒãƒ¼ãƒ„ã®é¢ç™½ã•ã¯ã€ãã®ç«¶æŠ€ãŒä¸Šæ‰‹ã‹ä¸‹æ‰‹ã‹ã¨ã„ã†ä»¥å¤–ã«ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹
éšœç¢è€…ã‚‚ã¡ã‚ƒã‚“ã¨çµ¦æ–™ã‚’ã‚‚ã‚‰ã£ã¦ç”Ÿæ´»ã§ãã‚‹ç¤¾ä¼šã«ã™ã¹ãã 
###Output:
å¹´é½¢ã¨ã‹éšœå®³ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸå¸¸è­˜ã«æ‰ã‚ã‚Œãšã€æœ¬å½“ã®æœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹

### Input:
"""

labeling5 = """
### Instructions:
Please summarize the items of groups in one concise sentence with a deeper meaning.

### Conditions:
Please write in Japanese.

###Input:
è‡ªç„¶ã‚„é£Ÿã€æ­´å²ãªã©ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®çµã³ã¤ãã‚„ä½“é¨“ã«èˆˆå‘³ãŒã‚ã‚Šã€è‡ªåˆ†ã‚‚ãã‚“ãªåœ°åŸŸã¥ãã‚ŠãŒã—ãŸã„
ãŠã˜ã„ã¡ã‚ƒã‚“ã®ä½ã‚€æ²–ç¸„ã®é™½æ°—ãªé›°å›²æ°—ãŒå¥½ãã 
###Output:
ãã®åœŸåœ°åœŸåœ°ãŒæŒã¤æ­´å²ã‚„è‡ªç„¶ç’°å¢ƒã€é£Ÿæ–‡åŒ–ã‚„é›°å›²æ°—ãªã©ã‚’ã€è‡ªåˆ†ã‹ã‚‰æ¥½ã—ã¿ã€ãã—ã¦åºƒã‚ãŸã„

###Input:
å¹´é½¢ã¨ã‹éšœå®³ã€ç«¶æŠ€ã®ãƒ¬ãƒ™ãƒ«ã¨ã„ã£ãŸå¸¸è­˜ã«æ‰ã‚ã‚Œãšã€æœ¬å½“ã®æœªæ¥ã‚’åˆ‡ã‚Šé–‹ã„ã¦ã„ãå¿…è¦ãŒã‚ã‚‹
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰ã¯ã©ã†ã™ã‚Œã°è§£æ±ºã™ã‚‹ã ã‚ã†ã‹
###Output:
ã™ã§ã«ã‚ã‚‹æž çµ„ã¿ã‚’ã¯ã¿å‡ºã—ã¦ã§ã‚‚ã€æœ¬å½“ã«å¤§åˆ‡ãªè¡Œå‹•ã‚’èµ·ã“ã—ã€å¹³å’Œãªæœªæ¥ã‚’ç›®æŒ‡ã—ãŸã„

### Input:
"""

symbol = """
### Instructions:
Act as an introspective artist who excels at looking deep into his or her own mind.
Paraphrase each group of sentences in a single word that can be understood instantaneously.

### Conditions:
Please write in Japanese.
Rephrase it with an adjective, verb or metaphor in Japanese.

###Input:
ãã®åœŸåœ°åœŸåœ°ãŒæŒã¤æ­´å²ã‚„è‡ªç„¶ç’°å¢ƒã€é£Ÿæ–‡åŒ–ã‚„é›°å›²æ°—ãªã©ã‚’ã€è‡ªåˆ†ã‹ã‚‰æ¥½ã—ã¿ã€ãã—ã¦åºƒã‚ãŸã„
###Output:
åœ°åŸŸç‹¬ç‰¹ã®é¢¨åœŸã‚’ãƒ•ãƒ«ã§æ¥½ã—ã‚€

###Input:
ã™ã§ã«ã‚ã‚‹æž çµ„ã¿ã‚’ã¯ã¿å‡ºã—ã¦ã§ã‚‚ã€æœ¬å½“ã«å¤§åˆ‡ãªè¡Œå‹•ã‚’èµ·ã“ã—ã€å¹³å’Œãªæœªæ¥ã‚’ç›®æŒ‡ã—ãŸã„
###Output:
å¸¸è­˜ã‚’ã¯ã¿å‡ºã—ãŸå¤§åˆ‡ãªè¡Œå‹•ã‚’ã—ãŸã„

###Input:
ã‚¢ãƒ‹ãƒ¡ã§ã¯è¡¨ã›ãªã„ã€æ¼«ç”»ã«ã—ã‹ãªã„æ„Ÿå‹•ã®ä½“é¨“ãŒã‚ã‚‹
###Output:
æ¼«ç”»ãªã‚‰ã§ã¯ã®æ„Ÿå‹•ãŒã‚ã‚‹

###Input:
ã‚¤ãƒ©ã‚¹ãƒˆã‚’iPadã§æãã®ãŒå¾—æ„
###Output:
ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ãƒˆãŒå¾—æ„

### Input:
"""

# embeddings ã¸å¤‰æ›
def to_emb(model, text, prefix="query: "):
    return model.encode([prefix + text], normalize_embeddings=True)

def init_page():
    st.set_page_config(
        page_title="KJ-GPT",
        page_icon="ðŸ•µï¸â€â™‚ï¸"
    )
    st.header("KJ-GPT ðŸ•µï¸â€â™‚ï¸")
    st.sidebar.title("Options")

def init_messages():
    clear_button = st.sidebar.button("Clear Conversation", key="clear")
    if clear_button or "messages" not in st.session_state:

        st.session_state.messages = [
            SystemMessage(content="")
        ]

        # st.session_state.messages = [
        #     SystemMessage(content=labeling4)
        # ]

        # st.session_state.messages = [
        #     SystemMessage(content=symbol)
        # ]

        st.session_state.costs = []

        st.session_state["openai_api_key"] = ""

        st.session_state["markdown_text"] = ""

        st.session_state["user_theme"] = ""

        st.session_state["translated_theme"] = ""

        st.session_state["summarized_data"] = ""



def select_model(openai_api_key):
    model = st.sidebar.radio("Choose a model:", ("GPT-3.5", "GPT-3.5-16k", "GPT-4", "GPT-4-Turbo"),index=3)
    if model == "GPT-3.5":
        model_name = "gpt-3.5-turbo-0613"
    elif model == "GPT-3.5-16k":
        model_name = "gpt-3.5-turbo-16k-0613"
    elif model == "GPT-4":
        model_name = "gpt-4"
    else:
        model_name = "gpt-4-1106-preview"
    
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã€temperatureã‚’0ã‹ã‚‰1ã¾ã§ã®ç¯„å›²ã§é¸æŠžå¯èƒ½ã«ã™ã‚‹
    # åˆæœŸå€¤ã¯0.0ã€åˆ»ã¿å¹…ã¯0.1ã¨ã™ã‚‹
    temperature = st.sidebar.slider("Temperature:", min_value=0.0, max_value=1.0, value=0.7, step=0.01)
    
    return ChatOpenAI(openai_api_key=openai_api_key, temperature=temperature, model_name=model_name)

def get_answer(llm, messages):
    with get_openai_callback() as cb:
        answer = llm(messages)
    return answer.content, cb.total_cost

def count_newlines(text):
    # æ”¹è¡Œæ–‡å­—ã‚’å«ã‚€æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®šç¾©
    pattern = r"\r\n|\n|\r"
    # ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒžãƒƒãƒã™ã‚‹éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã€ãã®æ•°ã‚’è¿”ã™
    return len(re.findall(pattern, text))

def get_init_list(data):
    lines = data.strip().split("\n")
    return lines

def get_list(data):
    # ãƒ‡ãƒ¼ã‚¿ã‚’è¡Œã”ã¨ã«åˆ†å‰²
    lines = data.strip().split("\n")

    result = []
    temp = []

    for line in lines:
        # â€ã‚°ãƒ«ãƒ¼ãƒ—â€ã‚‚ã—ãã¯"å˜ç‹¬"ã®è¡Œã®å ´åˆã€tempã‚’ãƒªã‚»ãƒƒãƒˆ
        if "ã‚°ãƒ«ãƒ¼ãƒ—" in line or "å˜ç‹¬" in line:
            if temp:
                if len(temp) == 1:
                    result.append(temp[0])
                else:
                    result.append(temp)
                temp = []
        # è¡Œã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
        elif line:
            temp.append(line)
    # æœ€å¾Œã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    if temp:
        if len(temp) == 1:
            result.append(temp[0])
        else:
            result.append(temp)
    # ""ã®ç©ºç™½è¦ç´ ã‚’å‰Šé™¤
    result = [item for item in result if item != ""]
    return result

def add_markdown_entry(level, text):
    """ä¸Žãˆã‚‰ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ã™ã‚‹é–¢æ•°"""
    return f"{'#' * level} {text}\n"

def find_sub_items(key, level, dict_items):
    """ã‚µãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŽ¢ã—ã€ãã®è¦‹å‡ºã—ã‚’ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§è¿”ã™é–¢æ•°"""
    markdown = ""
    for dict_item in dict_items:
        if isinstance(dict_item, dict) and key in dict_item:
            for sub_item in dict_item[key]:
                if sub_item:  # ç©ºã®æ–‡å­—åˆ—ã§ãªã„å ´åˆã«ã‚µãƒ–è¦‹å‡ºã—ã‚’è¿½åŠ 
                    markdown += add_markdown_entry(level, sub_item)
                    # å†å¸°çš„ã«ä¸‹ã®ãƒ¬ãƒ™ãƒ«ã®é …ç›®ã‚’æŽ¢ã™
                    if level < 6:  # 6æ¬¡è¦‹å‡ºã—ã¾ã§ç¶šã‘ã‚‹
                        markdown += find_sub_items(sub_item, level + 1, dict_items)
    return markdown

def headline_to_list(markdown_text):
    """ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã•ã‚ŒãŸè¦‹å‡ºã—ã‚’ãƒªã‚¹ãƒˆç®‡æ¡æ›¸ãå½¢å¼ã«å¤‰æ›ã—ã¦è¿”ã™é–¢æ•°"""

    # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã«åˆ†å‰²ã—ã¾ã™ã€‚
    lines = markdown_text.strip().split("\n")
    
    # å¤‰æ›ã•ã‚ŒãŸãƒªã‚¹ãƒˆã‚’ä¿æŒã™ã‚‹ãŸã‚ã®ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
    converted_list = []

    # å„è¡Œã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦å‡¦ç†ã—ã¾ã™ã€‚
    for line in lines:

        if "**" in line:
            converted_list.append("\n" + line + "\n")

        else:
            # è¦‹å‡ºã—ã®ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®šã—ã¾ã™ï¼ˆ#ã®æ•°ã§æ±ºã¾ã‚Šã¾ã™ï¼‰ã€‚
            level = line.count("#")
            
            # è¦‹å‡ºã—ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã—ã¾ã™ã€‚
            text = line.replace("#", "").strip()
            
            # ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’æ±ºå®šã—ã¾ã™ã€‚
            # ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¯è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¢—ã‚„ã—ã¾ã™ã€‚
            indent = '    ' * (level - 1)
            
            # å¤‰æ›ã•ã‚ŒãŸãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¾ã™ã€‚
            converted_list.append(f"{indent}- {text}")

    # ãƒªã‚¹ãƒˆå½¢å¼ã«å¤‰æ›ã•ã‚ŒãŸãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’çµåˆã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚
    converted_markdown = "\n".join(converted_list)

    return converted_markdown

def segmented_by_three(markdown_input):
    """ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã•ã‚ŒãŸè¦‹å‡ºã—ã‚’3è¡Œã”ã¨ã«åˆ†å‰²ã—ã¦è¿”ã™é–¢æ•°"""
    # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã«åˆ†å‰²ã—ã¾ã™ã€‚
    lines = markdown_input.strip().split("\n")

    # 3è¡Œã”ã¨ã«åŒºåˆ‡ã£ã¦ãƒªã‚¹ãƒˆåŒ–ã—ã¾ã™ã€‚
    segmented_markdown = []
    for i in range(0, len(lines), 3):
        segment = lines[i:i + 3]
        segmented_markdown.append("\n".join(segment))

    return segmented_markdown

def split_sections(text):
    """æ®µè½ã”ã¨ã«åˆ†å‰²ã—ã¦è¿”ã™é–¢æ•°"""
    # å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®ãƒªã‚¹ãƒˆ
    sections = []
    # ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®å¤‰æ•°
    current_section = []
    
    # ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã”ã¨ã«åˆ†å‰²ã—ã¦å‡¦ç†
    for line in text.strip().split("\n"):
        # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¤œå‡ºã—ãŸå ´åˆã€
        # ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹
        if line.startswith("**"):
            if current_section:
                sections.append("\n".join(current_section))
                current_section = []
        current_section.append(line)
    
    # æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    if current_section:
        sections.append("\n".join(current_section))
    
    return sections

def split_by_hashes(text):
    """#ã®ä¸Šä½ä¸‹ä½ã”ã¨ã«ã‚»ãƒƒãƒˆã«ã—ã¦è¾žæ›¸åž‹ãƒªã‚¹ãƒˆã‚’è¿”ã™é–¢æ•°ï¼ˆBasic Data for Abductionï¼‰"""
    # "#" ã§å§‹ã¾ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³
    pattern_hashes = [r"(^" + "#"*i + " [^\n]*(?:\n(?!#).*)*)" for i in range(1, 7)]

    # ãƒžãƒƒãƒãƒ³ã‚°çµæžœã‚’ãƒªã‚¹ãƒˆã«æ ¼ç´
    matches_hashes = [re.findall(p, text, re.MULTILINE) for p in pattern_hashes]

    # '**' ã§æŒŸã¾ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ "(æ•°å­—)" ã‚’é™¤å¤–ã—ã¦æŠ½å‡ºã™ã‚‹æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³
    pattern_bold_text_excluding_numbers = r"\*\*\(\d+\) (.+?)\*\*"

    # ãƒžãƒƒãƒãƒ³ã‚°çµæžœã‚’ãƒªã‚¹ãƒˆã«æ ¼ç´
    matches_bold_text_excluding_numbers = re.findall(pattern_bold_text_excluding_numbers, text)

    # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¾žæ›¸ã¨ã—ã¦é–¢é€£ä»˜ã‘ã‚‹
    related_sections = {}

    # ã‚‚ã—ä¸€ç•ªä¸Šä½ã®é …ç›®ã—ã‹ãªã„ä¸€åŒ¹ç‹¼ã®å ´åˆã¯ã€ãã®é …ç›®ã®ã¿è¾žæ›¸ã«å…¥ã‚Œã‚‹ã€‚
    if matches_hashes[1] == []:
        # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚·ãƒ³ãƒœãƒ«ãƒžãƒ¼ã‚¯ã‚’keyã€ä¸€åŒ¹ç‹¼ã®ãƒ©ãƒ™ãƒ«ã‚’valueã¨ã—ã¦è¾žæ›¸ã«ç™»éŒ²
        symbol_mark = matches_bold_text_excluding_numbers[0]
        related_sections[symbol_mark] = matches_hashes[0]

    # å„ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«é–¢é€£ä»˜ã‘ã‚’è¡Œã†
    for level in range(len(matches_hashes) - 1, -1, -1):
        # matches_hashes[level]ã®è¦ç´ ã‚’å¾Œã‚ã‹ã‚‰ãƒ«ãƒ¼ãƒ—
        for section in reversed(matches_hashes[level]):
            # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹
            section_start_index = text.index(section)
            # ã“ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚ˆã‚Šå‰ã®ã™ã¹ã¦ã®ä¸Šä½ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
            for upper_level in range(level - 1, -1, -1):
                previous_sections = [s for s in matches_hashes[upper_level] if text.index(s) < section_start_index]
                # ã‚‚ã£ã¨ã‚‚è¿‘ã„ä¸Šä½ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠžã™ã‚‹
                if previous_sections:
                    nearest_section = previous_sections[-1]
                    # ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ¼ã¨ã—ã¦è¾žæ›¸ã«è¿½åŠ 
                    if nearest_section in related_sections:
                        related_sections[nearest_section].append(section.strip())
                    else:
                        related_sections[nearest_section] = [section.strip()]
                    break

    return related_sections

def sentence_generating(llm,group,translated_theme,summarized_list,openai_api_key):
    combined_list = []
    # simplified_list = []
    # summarized_list = []

    if summarized_list:
        last_answer = st.session_state.messages[-1].content
    else:
        last_answer = ""
    print("last_answerã¯", last_answer)
    
    if last_answer:
        last_answer_summarized = summarize(last_answer,openai_api_key)
    else:
        last_answer_summarized = ""
    print("last_answerã®è¦ç´„ã¯", last_answer_summarized)

    print("å†…å®¹ã¯ã€€", group)

#     sentence = f"""
# ### Instructions:
# {translated_theme}
# Act as an introspective person who excels at looking deep into his or her own mind.
# Please write sentences that connect the following bullet points.

# ### Condition:
# Please write in Japanese.
# Any additional explanations should be enclosed in parentheses.
# Start writing so that it connects logically with the following sentences.
# {last_answer_summarized}

# ### Input:
# # æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
# ## å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
# ## ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
# ### å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
# ### æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„

# ### Output:
# ä¾‹ãˆã°ã€å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œã ã€‚ï¼ˆç­”ãˆã®ã‚ã‚‹å•é¡Œã‚’ãŸã å¼·åˆ¶çš„ã«è§£ç­”ã•ã›ã‚‰ã‚Œã‚‹ã®ã¯ç„¡é§„ã ã¨æ€ã†ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„ChatGPTãªã©ãŒæ€¥é€Ÿã«ç™ºå±•ã—ã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã£ãŸå˜ãªã‚‹æš—è¨˜ã‚„è«–ç†è¨ˆç®—ã¯ã€ãã®ã†ã¡äººé–“ãŒã‚„ã‚‹å¿…è¦ã¯ãªããªã‚‹ã¨æ€ã†ã€‚ãã‚Œãªã®ã«ã€ã“ã®ã¾ã¾åå·®å€¤è‡³ä¸Šä¸»ç¾©ã®è©°ã‚è¾¼ã¿æ•™è‚²ã§ä»Šå¾Œã‚‚ã‚„ã£ã¦ã„ããªã‚‰ã°ã€ä½•ã®å½¹ã«ã‚‚ç«‹ãŸãªã„å¤§äººã‚’è‚²ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚ï¼‰
# ãã†ã§ã¯ãªãã¦ã€ã‚‚ã£ã¨æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„ã€‚ï¼ˆç­”ãˆã®ãªã„å•ã„ã«è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ç«‹ã¡å‘ã‹ã£ãŸã‚Šã€è‡ªåˆ†ã ã‘ã®ç‰¹åˆ¥ãªèˆˆå‘³é–¢å¿ƒã‚’è‚²ã¦ã¦å°‚é–€æ€§ã‚’é«˜ã‚ãŸã‚Šã™ã‚‹å‹‰å¼·ã®æ–¹ãŒä»Šå¾Œæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã¯æ˜Žã‚‰ã‹ã ã€‚ï¼‰ã¤ã¾ã‚Šã€ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„ã¨ã„ã†ã“ã¨ã€‚ãã—ã¦ãã®ãŸã‚ã«ã¯ã€å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†ã€‚
# ï¼ˆãã‚‚ãã‚‚ä»Šã®æ•™å¸«ãŒæ˜”ãªãŒã‚‰ã®è©°ã‚è¾¼ã¿å¼ã®æ•™è‚²ã§è‚²ã£ãŸã®ã§ã€ãã®æ„è­˜æ”¹é©ãŒå¿…è¦ã ã€‚æ•™å¸«è‡ªèº«ãŒç­”ãˆã®ãªã„è‡ªåˆ†ã®å¿ƒã®åº•ã‹ã‚‰å‡ºã¦ããŸå•ã„ã‚’è¨­å®šã—ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«ãã‚Œã«å–ã‚Šçµ„ã‚€å§¿å‹¢ã‚’è¦‹ã›ãªã„ã¨ã€å­ä¾›é”ã¯ã¤ã„ã¦ã„ã‹ãªã„ã€‚ãã‚Œã ã‘ã§ã¯ãªãã€å­ä¾›ã®è¦ªãŸã¡ã‚‚æ–°ã—ã„å­¦ã³ã‚’äººç”Ÿã«å–ã‚Šå…¥ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ç­”ãˆã®ãªã„æŽ¢ç©¶æ´»å‹•ã¯å¾“æ¥ã®å­¦ç¿’ã«æ¯”ã¹ã¦ã€ã‚ˆã‚Šæ—¥å¸¸ç”Ÿæ´»ã«æ·±ãé–¢ã‚ã‚‹ã‚‚ã®ã ã€‚æ™®æ®µéŽã”ã—ã¦ã„ã‚‹ä¸­ã§æ„Ÿã˜ã‚‹ç–‘å•ã‚„é•å’Œæ„Ÿãªã©ã‚’èµ·ç‚¹ã«ã—ãŸã€å®Ÿä½“é¨“ã«å³ã—ãŸå•ã„ã§ã‚ã‚‹ã»ã©ã€ä»Šå¾Œã®é•·ã„äººç”Ÿã§å–ã‚Šçµ„ã‚€ã«å€¤ã™ã‚‹æ·±ã„ã‚‚ã®ã«ãªã‚Šã‚„ã™ã„ã€‚ãªã®ã§ã€ã“ã‚Œã¾ã§ã®ã‚ˆã†ã«è¦ªãŒæ•™è‚²ã‚’å­¦æ ¡ã‚„å¡¾ã«ä»»ã›ã£ã±ãªã—ã«ã—ã¦ã€å®¶åº­ã§å­ä¾›ã«ç„¡é–¢å¿ƒã§ã„ã¦ã¯å­ä¾›ã®æŽ¢ç©¶å¿ƒãŒè‚²ã¡ã«ãããªã‚‹ã€‚æ•™å¸«ã¨åŒã˜ã‚ˆã†ã«ã€è¦ªãŸã¡ã‚‚è‡ªåˆ†ã®å•ã„ã‚’ç«‹ã¦ã¦ãã‚Œã‚’è¿½æ±‚ã™ã‚‹å–¶ã¿ã‚’å®Ÿéš›ã«ã‚„ã‚‹ã¹ãã ã€‚ãã—ã¦ã€ãã®è¡Œå‹•ãŒå­ä¾›ãŸã¡ã‚’æ„ŸåŒ–ã•ã›ã€å®¶åº­ã‚’æ´»æ°—ã¥ã‹ã›ã¦ã€ã•ã‚‰ã«ã¯è·å ´ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚‚ä¸Šã’ã‚‹ã“ã¨ã«ãªã‚‹ã®ãŒç†æƒ³ã ã€‚ï¼‰ã“ã‚Œã‚‰ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ãªã®ã ã¨è¨€ãˆã‚‹ã€‚

# ### Input:
# """
    
    sentence = f"""
### Instructions:
{translated_theme}
Act as an introspective person who excels at looking deep into his or her own mind.
Please write sentences that connect the bullet points.

### Condition:
Please write in Japanese.
Any additional explanations should be enclosed in parentheses.
Start writing so that it connects logically with the following sentences.
{last_answer_summarized}

### Input:
# æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã 
## å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†
## ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„
### å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
### æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„

### Output:
ä¾‹ãˆã°ã€å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œã ã€‚ï¼ˆç­”ãˆãŒã‚ã‹ã£ã¦ã‚‹å•é¡Œã‚’ã¨ã‘ã£ã¦è¨€ã‚ã‚Œã‚‹ã®ã€ãƒžã‚¸ãªã„ã¨æ€ã†ã€‚ãƒãƒƒãƒˆã¨ã‹ChatGPTã¨ã‹ä»Šã®æ™‚ä»£ã‚ã£ã¡ã‚ƒã‚ã‚‹ã—ã€‚ãã‚Œä½¿ãˆã°ä¸€çž¬ã ã‹ã‚‰ã€‚ãã‚“ãªã“ã¨ã‚ã–ã‚ã–äººé–“ãŒã‚„ã‚‹å¿…è¦ãªãã­ï¼Ÿã“ã®ã¾ã¾ã€Œåå·®å€¤ã€ã°ã£ã‹è¨€ã£ã¦è©°ã‚è¾¼ã¿ã¾ãã£ãŸã‚‰ã€å°†æ¥å½¹ã«ç«‹ãŸãªã„å¤§äººã«ãªã‚‹ã§ã—ã‚‡ã€‚ï¼‰
ãã†ã§ã¯ãªãã¦ã€ã‚‚ã£ã¨æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„ã€‚ï¼ˆç­”ãˆãŒæ±ºã¾ã£ã¦ãªã„å•é¡Œã‚’ã‚ã£ã¡ã‚ƒè€ƒãˆãŸã‚Šã€è‡ªåˆ†ã ã‘èˆˆå‘³ãŒã‚ã‚‹åˆ†é‡Žã‚’æŽ˜ã‚Šä¸‹ã’ãŸã‚Šã—ãŸæ–¹ãŒã‚ã£ã¡ã‚ƒæ¥½ã—ã„ã¨æ€ã†ã—ã€ãã‚ŒãŒã“ã‚Œã‹ã‚‰ã¯å¤§åˆ‡ã€‚ï¼‰ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„ã¨ã„ã†ã“ã¨ã€‚ãã—ã¦ãã®ãŸã‚ã«ã¯ã€å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†ã€‚
ï¼ˆã¦ã„ã†ã‹ã€å…ˆç”Ÿè‡ªä½“ãŒå¤ã„è©°ã‚è¾¼ã¿ã‚­ãƒ§ãƒ¼ã‚¤ã‚¯ã•ã‚Œã¦ãã¦ã‚‹ã‚“ã ã‹ã‚‰ã€ãã®æ„è­˜ã‚’å¤‰ãˆãªã„ã¨ãƒ€ãƒ¡ã§ã—ã‚‡ã€‚å…ˆç”ŸãŒè‡ªåˆ†ã§ã‚„ã£ã¦ãªã„ã®ã«ã€ç”Ÿå¾’ã«æŽ¢ç©¶å­¦ç¿’ã‚’ã—ã‚ã¨ã‹è¨€ã£ã¦ã‚‚éŸ¿ã‹ãªã„ã—ã€‚ã†ã‚“ã€‚ã†ã¡ã®è¦ªã‚‚ãã†ã˜ã‚ƒã‚“ã€‚å¤§å­¦è©¦é¨“ã®é¢æŽ¥ã«å¿…è¦ã ã‹ã‚‰ã£ã¦å¡¾ã®ã‚„ã£ã¦ã‚‹ä¼æ¥­ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ã‚·æŒã£ã¦ãã‚‹ã‘ã©ã€è‡ªåˆ†ã¯ä»•äº‹ã§ä½•ã‹ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã—ã‚ˆã†ã¨ã—ã¦ã‚“ã®ã‹ãªã€‚æŽ¢ç©¶ã£ã¦ã„ã¤ã‚‚ã®ç”Ÿæ´»ã®ä¸­ã§è¦‹ã¤ã‘ã¦ã„ãã‚‚ã®ã˜ã‚ƒã‚“ã€‚å®¶ã§éŽã”ã™ã¨ãã«ãã†ã„ã£ãŸç’°å¢ƒã«ãªã„ã¨ã€ã„ãã‚‰å­¦æ ¡ã¨ã‹å¡¾ã§ã‚„ã£ã¦ã‚‚ãŠã‚“ãªã˜ã˜ã‚ƒã‚“ã€‚å…ˆç”Ÿã‚‚è¦ªã‚‚è‡ªåˆ†ãŸã¡ã§æŽ¢ç©¶å­¦ç¿’ã£ã¦ã®ã‚’ã‚„ã‚Œã°ã€ä»•äº‹ã‚‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚‚ãƒŽãƒªã«ä¹—ã£ã¦ã„ã„æ„Ÿã˜ã«ãªã‚‹ã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿãã‚ŒãŒåˆ†ã‹ã£ã¦ã‹ã‚‰ã˜ã‚ƒãªã„ã¨ã€å­ã©ã‚‚ãŸã¡ã«ã‚‚æ•™ãˆã‚‹ã“ã¨ãŒã§ããªã„ã¨æ€ã†ã‘ã©â€¦ã€‚ï¼‰ä½•ãŒè¨€ã„ãŸã‹ã£ãŸã‹ã£ã¦ã„ã†ã¨ã€ã¤ã¾ã‚Šã€æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ãªã‚“ã ã£ã¦ã“ã¨ã€‚

### Input:
"""

    print("prompt:", sentence)

    st.session_state.messages.append(SystemMessage(content=sentence))
    st.session_state.messages.append(HumanMessage(content=group))
    with st.spinner("KJ-GPTãŒæ–‡ç« åŒ–ã—ã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-2:])
    combined_list.append(answer)
    st.session_state.messages.append(AIMessage(content=answer))
    st.session_state.costs.append(cost)

    # st.session_state.messages.append(SystemMessage(content=simplifying_sentence))
    # st.session_state.messages.append(HumanMessage(content=answer))
    # with st.spinner("KJ-GPTãŒæ–‡ç« åŒ–ã—ã¦ã„ã¾ã™ ..."):
    #     simplified_answer, cost = get_answer(llm, st.session_state.messages[-2:])
    # simplified_list.append(simplified_answer)
    # st.session_state.messages.append(AIMessage(content=simplified_answer))

    # st.session_state.messages.append(SystemMessage(content=summarized_sentence))
    # st.session_state.messages.append(HumanMessage(content=simplified_answer))
    # with st.spinner("KJ-GPTãŒæ–‡ç« åŒ–ã—ã¦ã„ã¾ã™ ..."):
    #     summarized_answer, cost = get_answer(llm, st.session_state.messages[-2:])
    # summarized_list.append(summarized_answer)
    # st.session_state.messages.append(AIMessage(content=summarized_answer))

    combined_sentences = "".join(combined_list)
    # simplified_sentences = "\n".join(simplified_list)
    # summarized_sentences = "\n".join(summarized_list)
    st.markdown(combined_sentences)
    return last_answer_summarized
    # st.markdown(simplified_sentences)
    # st.markdown(summarized_sentences)
    # return combined_sentences, simplified_sentences

def sumarized_sentence_generating(llm,group,translated_theme):
    combined_list = []

    sentence = f"""
### Instructions:
{translated_theme}
Act as an introspective artist who excels at looking deep into his or her own mind.
Please write sentences that connect the following bullet points.

### Condition:
Please write in Japanese.
Please supplement the conjunctions so that the places separated by line breaks are logically connected.

### Input:
æ²–ç¸„ã®æš–ã‹ã•ã‚„ç¦å³¶ã®è‡ªç„¶ã¸ã®æ„›æƒ…ã¯ã€è‡ªåˆ†ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨çµã³ã¤ã„ã¦ã„ã‚‹ã€‚åœ°åŸŸã®ç‰¹è‰²ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã¯ã€æ–‡åŒ–ã‚„ä¼çµ±ã‚’å‘³ã‚ã†ã“ã¨ã«ã‚‚ç¹‹ãŒã‚‹ã€‚
åœ°åŸŸã®è‡ªç„¶ã¨ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã‚¹ã‚¤ãƒ¼ãƒ„ã§ç¦å³¶çœŒã‚’æ´»æ€§åŒ–ã—ã€åœ°åŸŸæ„›ã‚„ç’°å¢ƒã¸ã®é…æ…®ã€é£Ÿå“ãƒ­ã‚¹å‰Šæ¸›ã«è²¢çŒ®ã—ãŸã„ã¨æ€ã†ã€‚
ç„¡é§„ã®ãªã„ã€åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿæ–‡åŒ–ã®é‡è¦æ€§ã‚’æ„Ÿã˜ã¦ãŠã‚Šã€ãã‚Œã‚’é€šã˜ã¦æŒç¶šå¯èƒ½ãªç¤¾ä¼šã¥ãã‚Šã«è²¢çŒ®ã—ãŸã„ã€‚ã¾ãŸã€åœ°åŸŸã®äº¤é€šã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚‚é‡è¦ãªèª²é¡Œã§ã‚ã‚‹ã¨è€ƒãˆã€è‹¥è€…ã¨ã—ã¦ç©æ¥µçš„ã«è­°è«–ã«å‚åŠ ã—ãŸã„ã€‚
éŽç–ŽåŒ–ã¨äº¤é€šå•é¡Œã‚’å…‹æœã—ã€ç¦å³¶ã®é£Ÿæ–‡åŒ–ã‚’æ´»ã‹ã—ãŸåœ°åŸŸæ´»æ€§åŒ–ã®ãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŒã¤ã“ã¨ãŒã€åœ°åŸŸã®äººã€…ã®å”åŠ›ã«ã‚ˆã‚ŠéŽç–ŽåŒ–ã‚’é£Ÿã„æ­¢ã‚ã€ã‚ˆã‚Šè‰¯ã„æœªæ¥ã‚’å‰µã‚‹éµã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
å½¼å¥³ã®æ­´å²ã¸ã®èˆˆå‘³ã‚’å…±æœ‰ã—ã€äº¬éƒ½ã§ã®åº§ç¦…ä½“é¨“ã‚„å¤ã„ç”ºä¸¦ã¿ã‚’é€šã—ã¦ã€ã‚ˆã‚Šæ·±ã„çµ†ã‚’è‚²ã‚€ã“ã¨ãŒé‡è¦ã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
æ­´å²ã‚„åœ°åŸŸæ–‡åŒ–ã«è§¦ã‚Œã‚‹ã“ã¨ã§ã€ç§ãŸã¡ã®ç”Ÿãæ–¹ã‚’è¦‹ã¤ã‚ç›´ã—ã€ã‚ˆã‚Šäººé–“ã‚‰ã—ã•ã«å›žå¸°ã—å…±ã«æˆé•·ã—ã¦ã„ãã“ã¨ãŒé‡è¦ã ã¨æ„Ÿã˜ã¦ã„ã‚‹ã€‚
ç§ã¯ç”Ÿã¾ã‚Œè‚²ã£ãŸåœ°åŸŸã¸ã®æ·±ã„æ„›æƒ…ã‚’æŒã£ã¦ãŠã‚Šã€åœ°å…ƒã®æ–‡åŒ–ã‚„ä¼çµ±ã€ç¥­ã‚Šã‚„è¡Œäº‹ã¸ã®å‚åŠ ã‚’é€šã˜ã¦å…±åŒä½“ã®ä¸€å“¡ã¨ã—ã¦ã®çµ†ã‚’æ„Ÿã˜ã‚‹ã€‚åœ°åŸŸæ„›ã¯ã€ç§ãŸã¡ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‚²ã¿ã€æœªæ¥ã¸ç¹‹ã’ã¦ã„ãã¹ãä¾¡å€¤ã§ã‚ã‚‹ã€‚
iPadã‚’ä½¿ã£ãŸã‚¤ãƒ©ã‚¹ãƒˆã®æ‰èƒ½ã‚’æ´»ã‹ã—ã€åŽŸä½œã®é­…åŠ›ã‚’æãªã‚ãšã«æ„Ÿå‹•ã‚’ä¸Žãˆã‚‹ä½œå“ã‚’å‰µé€ ã—ãŸã„ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
åŽŸä½œã®æ„Ÿå‹•ã‚’ã‚¢ãƒ‹ãƒ¡ã§ã©ã†è¡¨ç¾ã™ã‚‹ã‹ã¯å¤§ããªèª²é¡Œã ãŒã€ãƒ‡ã‚¸ã‚¿ãƒ«ã®åˆ©ç‚¹ã‚’æ´»ã‹ã—å‰µé€ çš„ãªè©¦ã¿ã«ã‚ˆã‚Šæ–°ã—ã„é­…åŠ›ã‚’åŠ ãˆã€åŽŸä½œã¸ã®æ•¬æ„ã‚’ä¿ã¡ã¤ã¤æ„Ÿå‹•ã‚’å†å‰µé€ ã—ãŸã„ã€‚
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰è§£æ±ºã«ã¯ã€å›½éš›ç¤¾ä¼šå…¨ä½“ã®å¹³å’Œé¡˜æœ›ã‚’é‡ã‚“ã˜ã€å®Ÿè¡Œå¯èƒ½ãªå¯¾è©±ã¨è§£æ±ºç­–ã‚’æ¨¡ç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
æœªæ¥ã®ç¤¾ä¼šã«è²¢çŒ®ã™ã‚‹æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã¸ã®æ¸‡æœ›ã¯ã€å˜ãªã‚‹æ„Ÿæƒ…ã§ã¯ãªãã€å†…é¢ã‹ã‚‰ã®å¼·ã„æ¬²æ±‚ã ã€‚ç¾æ•™è‚²ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç–‘å•ã¨å®¿é¡Œã®å¤šã•ã¸ã®ä¸æº€ã¯ã€æ•™è‚²ã®æœ¬è³ªã‚’è¦‹ç›´ã™å¿…è¦æ€§ã‚’ç¤ºå”†ã—ã¦ã„ã‚‹ã€‚
å­ã©ã‚‚ã‚‚å¤§äººã‚‚ã€å¹´é½¢ã«é–¢ã‚ã‚‰ãšã€å¸¸ã«æ–°ã—ã„ã“ã¨ã‚’å­¦ã³ç¶šã‘ã‚‹ã“ã¨ãŒå¿…è¦ã ã€‚
éšœç¢è€…ã‚‚å«ã‚ãŸã™ã¹ã¦ã®äººã€…ãŒã€ç¤¾ä¼šã«ãŠã„ã¦å°Šé‡ã•ã‚Œã€è‡ªã‚‰ã®èƒ½åŠ›ã‚’ç™ºæ®ã§ãã‚‹ç’°å¢ƒã‚’ä½œã‚‹ã“ã¨ã®é‡è¦æ€§ã‚’èªè­˜ã—ã€å…±ç”Ÿç¤¾ä¼šã‚’ç›®æŒ‡ã™ã¹ãã§ã‚ã‚‹ã€‚
å…±ç”Ÿç¤¾ä¼šã«ãŠã„ã¦ã¯ã€éšœå®³è€…ã‚’å«ã‚å…¨ã¦ã®äººãŒã€è‡ªå·±ã®èƒ½åŠ›ã‚’ç™ºæ®ã—å°Šé‡ã•ã‚Œã‚‹ç’°å¢ƒãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚ãã‚Œã«ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãæ„ç¾©ã‚ã‚‹å­¦ã³ãŒå¿…è¦ã§ã‚ã‚Šã€ãã‚ŒãŒå…±ç”Ÿç¤¾ä¼šã®æ§‹ç¯‰ã«ä¸å¯æ¬ ã§ã‚ã‚‹ã€‚
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã¯ã€æŠ€è¡“åŠ›ã ã‘ã§ãªãã€çµŒæ¸ˆçš„å ±é…¬ã€ç²¾ç¥žåŠ›ã€å°‚é–€çŸ¥è­˜ã®é¢ã§ã‚‚ç•°ãªã‚‹ã€‚ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«ã‚‚ãã®å·®ãŒç¾ã‚Œã€ãƒ—ãƒ­ã¯æ´—ç·´ã•ã‚ŒãŸã‚‚ã®ã‚’ç”¨ã„ã€ã‚¢ãƒžã¯å®Ÿç”¨æ€§ã‚„ã‚³ã‚¹ãƒˆã‚’é‡è¦–ã™ã‚‹å‚¾å‘ã«ã‚ã‚‹ã€‚

### Output:
æ²–ç¸„ã®æš–ã‹ã•ã‚„ç¦å³¶ã®è‡ªç„¶ã¸ã®æ„›æƒ…ã¯ã€è‡ªåˆ†ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨æ·±ãçµã³ã¤ã„ã¦ãŠã‚Šã€åœ°åŸŸã®ç‰¹è‰²ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã¯æ–‡åŒ–ã‚„ä¼çµ±ã‚’å‘³ã‚ã†ã“ã¨ã¸ã¨ç¹‹ãŒã‚‹ã€‚ãã®ãŸã‚ã€åœ°åŸŸã®è‡ªç„¶ã¨ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã‚¹ã‚¤ãƒ¼ãƒ„ã§ç¦å³¶çœŒã‚’æ´»æ€§åŒ–ã™ã‚‹ã“ã¨ã‚„ã€åœ°åŸŸæ„›ã‚„ç’°å¢ƒã¸ã®é…æ…®ã€é£Ÿå“ãƒ­ã‚¹å‰Šæ¸›ãªã©ã«èˆˆå‘³ãŒã‚ã‚‹ã€‚ç„¡é§„ã®ãªã„ã€åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿæ–‡åŒ–ã®é‡è¦æ€§ã‚’æ„Ÿã˜ã€æŒç¶šå¯èƒ½ãªç¤¾ä¼šã‚’å®Ÿç¾ã—ãŸã„ã¨è€ƒãˆã¦ãŠã‚Šã€ãã®ãŸã‚ã«ã¯åœ°åŸŸã®äº¤é€šã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚‚é‡è¦ãªèª²é¡Œã§ã‚ã‚‹ã€‚è‹¥è€…ã¨ã—ã¦ã€ã“ã‚Œã‚‰ã®è­°è«–ã«ç©æ¥µçš„ã«å‚åŠ ã—ãŸã„ã¨æ€ã†ã€‚
ã“ã®ã‚ˆã†ã«ã€éŽç–ŽåŒ–ã¨äº¤é€šå•é¡Œã‚’å…‹æœã—ã€ç¦å³¶ã®é£Ÿæ–‡åŒ–ã‚’æ´»ã‹ã—ãŸåœ°åŸŸæ´»æ€§åŒ–ã®ãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŒã¤ã“ã¨ã¯ã€åœ°åŸŸã®äººã€…ã¨å”åŠ›ã—éŽç–ŽåŒ–ã‚’é£Ÿã„æ­¢ã‚ã€ã‚ˆã‚Šè‰¯ã„æœªæ¥ã‚’å‰µã‚‹éµã ã¨ç¢ºä¿¡ã—ã¦ã„ã‚‹ã€‚ã¾ãŸã€å½¼å¥³ã®æ­´å²ã¸ã®èˆˆå‘³ã‚’å…±æœ‰ã—ã€äº¬éƒ½ã§ã®åº§ç¦…ä½“é¨“ã‚„å¤ã„ç”ºä¸¦ã¿ã‚’é€šã˜ã¦ã€ã‚ˆã‚Šæ·±ã„çµ†ã‚’è‚²ã‚€ã“ã¨ã‚‚é‡è¦ã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚æ­´å²ã‚„åœ°åŸŸæ–‡åŒ–ã«è§¦ã‚Œã‚‹ã“ã¨ã¯ã€ç§ãŸã¡ã®ç”Ÿãæ–¹ã‚’è¦‹ã¤ã‚ç›´ã—ã€ã‚ˆã‚Šäººé–“ã‚‰ã—ã•ã«å›žå¸°ã—å…±ã«æˆé•·ã™ã‚‹æ©Ÿä¼šã‚’æä¾›ã™ã‚‹ã€‚ç§è‡ªèº«ã€ç”Ÿã¾ã‚Œè‚²ã£ãŸåœ°åŸŸã¸ã®æ·±ã„æ„›æƒ…ã‚’æŒã¡ã€åœ°å…ƒã®æ–‡åŒ–ã‚„ä¼çµ±ã€ç¥­ã‚Šã‚„è¡Œäº‹ã¸ã®å‚åŠ ã‚’é€šã˜ã¦å…±åŒä½“ã®ä¸€å“¡ã¨ã—ã¦ã®çµ†ã‚’æ„Ÿã˜ã¦ã„ã‚‹ã€‚ã“ã®åœ°åŸŸæ„›ã¯ã€ç§ãŸã¡ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‚²ã¿ã€æœªæ¥ã¸ç¹‹ã’ã¦ã„ãã¹ãä¾¡å€¤ã ã¨ç†è§£ã—ã¦ã„ã‚‹ã€‚
ã¾ãŸiPadã‚’ä½¿ã£ãŸã‚¤ãƒ©ã‚¹ãƒˆã®æ‰èƒ½ã‚’æ´»ã‹ã—ã€åŽŸä½œã®é­…åŠ›ã‚’æãªã‚ãšã«æ„Ÿå‹•ã‚’ä¸Žãˆã‚‹ä½œå“ã‚’å‰µé€ ã—ãŸã„ã¨ã®æ€ã„ã‚’æŒã£ã¦ã„ã‚‹ã€‚åŽŸä½œã®æ„Ÿå‹•ã‚’ã‚¢ãƒ‹ãƒ¡ã§ã©ã†è¡¨ç¾ã™ã‚‹ã‹ã¯å¤§ããªèª²é¡Œã§ã‚ã‚‹ãŒã€ãƒ‡ã‚¸ã‚¿ãƒ«ã®åˆ©ç‚¹ã‚’æ´»ã‹ã—å‰µé€ çš„ãªè©¦ã¿ã«ã‚ˆã‚Šæ–°ã—ã„é­…åŠ›ã‚’åŠ ãˆã€åŽŸä½œã¸ã®æ•¬æ„ã‚’ä¿ã¡ã¤ã¤æ„Ÿå‹•ã‚’å†å‰µé€ ã—ãŸã„ã€‚ãã‚ŒãŒä½•ã‚‰ã‹ã®å½¢ã§åœ°åŸŸæ„›ã®è‚²æˆã«ã¤ãªãŒã‚Œã°å¬‰ã—ã„ã€‚
å›½éš›ç¤¾ä¼šã«ç›®ã‚’å‘ã‘ã‚Œã°ã€ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰è§£æ±ºã¯ã€å…¨ä½“ã®å¹³å’Œé¡˜æœ›ã‚’é‡ã‚“ã˜ã€å®Ÿè¡Œå¯èƒ½ãªå¯¾è©±ã¨è§£æ±ºç­–ã‚’æ¨¡ç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚æœªæ¥ã®ç¤¾ä¼šã«è²¢çŒ®ã™ã‚‹æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã¸ã®æ¸‡æœ›ã¯ã€å˜ãªã‚‹æ„Ÿæƒ…ã§ã¯ãªãã€å†…é¢ã‹ã‚‰ã®å¼·ã„æ¬²æ±‚ã§ã‚ã‚Šã€ç¾æ•™è‚²ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç–‘å•ã¨å®¿é¡Œã®å¤šã•ã¸ã®ä¸æº€ã¯ã€æ•™è‚²ã®æœ¬è³ªã‚’è¦‹ç›´ã™å¿…è¦æ€§ã‚’ç¤ºå”†ã—ã¦ã„ã‚‹ã€‚å­ã©ã‚‚ã‚‚å¤§äººã‚‚ã€å¹´é½¢ã«é–¢ã‚ã‚‰ãšã€å¸¸ã«æ–°ã—ã„ã“ã¨ã‚’å­¦ã³ç¶šã‘ã‚‹ã“ã¨ãŒå¿…è¦ã§ã‚ã‚Šã€éšœå®³è€…ã‚‚å«ã‚ãŸã™ã¹ã¦ã®äººã€…ãŒç¤¾ä¼šã«ãŠã„ã¦å°Šé‡ã•ã‚Œã€èƒ½åŠ›ã‚’ç™ºæ®ã§ãã‚‹ç’°å¢ƒã‚’ä½œã‚‹ã“ã¨ã®é‡è¦æ€§ã‚’èªè­˜ã—ã¦ã„ã‚‹ã€‚ãã†ã—ãŸç¤¾ä¼šã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ã§ã€å¹³å’Œãªä¸–ç•Œã‚’å–ã‚Šæˆ»ã™ã“ã¨ãŒã§ãã‚‹ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
å…±ç”Ÿç¤¾ä¼šã«ãŠã„ã¦ã¯ã€éšœå®³è€…ã‚’å«ã‚å…¨ã¦ã®äººãŒã€è‡ªå·±ã®èƒ½åŠ›ã‚’ç™ºæ®ã—å°Šé‡ã•ã‚Œã‚‹ç’°å¢ƒãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚ãã‚Œã«ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãæ„ç¾©ã‚ã‚‹å­¦ã³ãŒå¿…è¦ã§ã‚ã‚Šã€ãã‚ŒãŒå…±ç”Ÿç¤¾ä¼šã®æ§‹ç¯‰ã«ä¸å¯æ¬ ã§ã‚ã‚‹ã€‚ã‚¹ãƒãƒ¼ãƒ„ã®ä¸–ç•Œã§ã‚‚ã€ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯æŠ€è¡“åŠ›ã ã‘ã§ã¯ãªãã€çµŒæ¸ˆçš„å ±é…¬ã€ç²¾ç¥žåŠ›ã€å°‚é–€çŸ¥è­˜ã®é¢ã§ã‚‚ç•°ãªã‚Šã€ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«ã‚‚ãã®å·®ãŒç¾ã‚Œã¦ã„ã‚‹ã€‚ãƒ—ãƒ­ã¯æ´—ç·´ã•ã‚ŒãŸã‚‚ã®ã‚’ç”¨ã„ã€ã‚¢ãƒžã¯å®Ÿç”¨æ€§ã‚„ã‚³ã‚¹ãƒˆã‚’é‡è¦–ã™ã‚‹å‚¾å‘ã«ã‚ã‚‹ã€‚
ã“ã‚Œã‚‰ã®è¦–ç‚¹ã‹ã‚‰ã€ç§ãŸã¡ã¯ç”Ÿæ´»ã®æ§˜ã€…ãªå´é¢ã«ãŠã„ã¦ã€å…±ç”Ÿç¤¾ä¼šã‚’ç›®æŒ‡ã—ã€ç‹¬è‡ªã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‚²ã¿ã€åœ°åŸŸæ„›ã‚’å¤§äº‹ã«ã—ãªãŒã‚‰ã€æŒç¶šå¯èƒ½ãªæœªæ¥ã‚’å‰µé€ ã™ã‚‹ãŸã‚ã«åŠªåŠ›ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚‹ã€‚

### Input:
"""

    sentence = f"""
### Instructions:
{translated_theme}
Act as an introspective artist who excels at looking deep into his or her own mind.
Please write sentences that connect the bullet points.

### Condition:
Please write in Japanese.
Please supplement the conjunctions so that the places separated by line breaks are logically connected.

### Input:
æ²–ç¸„ã®æš–ã‹ã•ã‚„ç¦å³¶ã®è‡ªç„¶ã¸ã®æ„›æƒ…ã¯ã€è‡ªåˆ†ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨çµã³ã¤ã„ã¦ã„ã‚‹ã€‚åœ°åŸŸã®ç‰¹è‰²ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã¯ã€æ–‡åŒ–ã‚„ä¼çµ±ã‚’å‘³ã‚ã†ã“ã¨ã«ã‚‚ç¹‹ãŒã‚‹ã€‚
åœ°åŸŸã®è‡ªç„¶ã¨ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã‚¹ã‚¤ãƒ¼ãƒ„ã§ç¦å³¶çœŒã‚’æ´»æ€§åŒ–ã—ã€åœ°åŸŸæ„›ã‚„ç’°å¢ƒã¸ã®é…æ…®ã€é£Ÿå“ãƒ­ã‚¹å‰Šæ¸›ã«è²¢çŒ®ã—ãŸã„ã¨æ€ã†ã€‚
ç„¡é§„ã®ãªã„ã€åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿæ–‡åŒ–ã®é‡è¦æ€§ã‚’æ„Ÿã˜ã¦ãŠã‚Šã€ãã‚Œã‚’é€šã˜ã¦æŒç¶šå¯èƒ½ãªç¤¾ä¼šã¥ãã‚Šã«è²¢çŒ®ã—ãŸã„ã€‚ã¾ãŸã€åœ°åŸŸã®äº¤é€šã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚‚é‡è¦ãªèª²é¡Œã§ã‚ã‚‹ã¨è€ƒãˆã€è‹¥è€…ã¨ã—ã¦ç©æ¥µçš„ã«è­°è«–ã«å‚åŠ ã—ãŸã„ã€‚
éŽç–ŽåŒ–ã¨äº¤é€šå•é¡Œã‚’å…‹æœã—ã€ç¦å³¶ã®é£Ÿæ–‡åŒ–ã‚’æ´»ã‹ã—ãŸåœ°åŸŸæ´»æ€§åŒ–ã®ãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŒã¤ã“ã¨ãŒã€åœ°åŸŸã®äººã€…ã®å”åŠ›ã«ã‚ˆã‚ŠéŽç–ŽåŒ–ã‚’é£Ÿã„æ­¢ã‚ã€ã‚ˆã‚Šè‰¯ã„æœªæ¥ã‚’å‰µã‚‹éµã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
å½¼å¥³ã®æ­´å²ã¸ã®èˆˆå‘³ã‚’å…±æœ‰ã—ã€äº¬éƒ½ã§ã®åº§ç¦…ä½“é¨“ã‚„å¤ã„ç”ºä¸¦ã¿ã‚’é€šã—ã¦ã€ã‚ˆã‚Šæ·±ã„çµ†ã‚’è‚²ã‚€ã“ã¨ãŒé‡è¦ã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
æ­´å²ã‚„åœ°åŸŸæ–‡åŒ–ã«è§¦ã‚Œã‚‹ã“ã¨ã§ã€ç§ãŸã¡ã®ç”Ÿãæ–¹ã‚’è¦‹ã¤ã‚ç›´ã—ã€ã‚ˆã‚Šäººé–“ã‚‰ã—ã•ã«å›žå¸°ã—å…±ã«æˆé•·ã—ã¦ã„ãã“ã¨ãŒé‡è¦ã ã¨æ„Ÿã˜ã¦ã„ã‚‹ã€‚
ç§ã¯ç”Ÿã¾ã‚Œè‚²ã£ãŸåœ°åŸŸã¸ã®æ·±ã„æ„›æƒ…ã‚’æŒã£ã¦ãŠã‚Šã€åœ°å…ƒã®æ–‡åŒ–ã‚„ä¼çµ±ã€ç¥­ã‚Šã‚„è¡Œäº‹ã¸ã®å‚åŠ ã‚’é€šã˜ã¦å…±åŒä½“ã®ä¸€å“¡ã¨ã—ã¦ã®çµ†ã‚’æ„Ÿã˜ã‚‹ã€‚åœ°åŸŸæ„›ã¯ã€ç§ãŸã¡ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‚²ã¿ã€æœªæ¥ã¸ç¹‹ã’ã¦ã„ãã¹ãä¾¡å€¤ã§ã‚ã‚‹ã€‚
iPadã‚’ä½¿ã£ãŸã‚¤ãƒ©ã‚¹ãƒˆã®æ‰èƒ½ã‚’æ´»ã‹ã—ã€åŽŸä½œã®é­…åŠ›ã‚’æãªã‚ãšã«æ„Ÿå‹•ã‚’ä¸Žãˆã‚‹ä½œå“ã‚’å‰µé€ ã—ãŸã„ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
åŽŸä½œã®æ„Ÿå‹•ã‚’ã‚¢ãƒ‹ãƒ¡ã§ã©ã†è¡¨ç¾ã™ã‚‹ã‹ã¯å¤§ããªèª²é¡Œã ãŒã€ãƒ‡ã‚¸ã‚¿ãƒ«ã®åˆ©ç‚¹ã‚’æ´»ã‹ã—å‰µé€ çš„ãªè©¦ã¿ã«ã‚ˆã‚Šæ–°ã—ã„é­…åŠ›ã‚’åŠ ãˆã€åŽŸä½œã¸ã®æ•¬æ„ã‚’ä¿ã¡ã¤ã¤æ„Ÿå‹•ã‚’å†å‰µé€ ã—ãŸã„ã€‚
ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰è§£æ±ºã«ã¯ã€å›½éš›ç¤¾ä¼šå…¨ä½“ã®å¹³å’Œé¡˜æœ›ã‚’é‡ã‚“ã˜ã€å®Ÿè¡Œå¯èƒ½ãªå¯¾è©±ã¨è§£æ±ºç­–ã‚’æ¨¡ç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
æœªæ¥ã®ç¤¾ä¼šã«è²¢çŒ®ã™ã‚‹æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã¸ã®æ¸‡æœ›ã¯ã€å˜ãªã‚‹æ„Ÿæƒ…ã§ã¯ãªãã€å†…é¢ã‹ã‚‰ã®å¼·ã„æ¬²æ±‚ã ã€‚ç¾æ•™è‚²ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç–‘å•ã¨å®¿é¡Œã®å¤šã•ã¸ã®ä¸æº€ã¯ã€æ•™è‚²ã®æœ¬è³ªã‚’è¦‹ç›´ã™å¿…è¦æ€§ã‚’ç¤ºå”†ã—ã¦ã„ã‚‹ã€‚
å­ã©ã‚‚ã‚‚å¤§äººã‚‚ã€å¹´é½¢ã«é–¢ã‚ã‚‰ãšã€å¸¸ã«æ–°ã—ã„ã“ã¨ã‚’å­¦ã³ç¶šã‘ã‚‹ã“ã¨ãŒå¿…è¦ã ã€‚
éšœç¢è€…ã‚‚å«ã‚ãŸã™ã¹ã¦ã®äººã€…ãŒã€ç¤¾ä¼šã«ãŠã„ã¦å°Šé‡ã•ã‚Œã€è‡ªã‚‰ã®èƒ½åŠ›ã‚’ç™ºæ®ã§ãã‚‹ç’°å¢ƒã‚’ä½œã‚‹ã“ã¨ã®é‡è¦æ€§ã‚’èªè­˜ã—ã€å…±ç”Ÿç¤¾ä¼šã‚’ç›®æŒ‡ã™ã¹ãã§ã‚ã‚‹ã€‚
å…±ç”Ÿç¤¾ä¼šã«ãŠã„ã¦ã¯ã€éšœå®³è€…ã‚’å«ã‚å…¨ã¦ã®äººãŒã€è‡ªå·±ã®èƒ½åŠ›ã‚’ç™ºæ®ã—å°Šé‡ã•ã‚Œã‚‹ç’°å¢ƒãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚ãã‚Œã«ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãæ„ç¾©ã‚ã‚‹å­¦ã³ãŒå¿…è¦ã§ã‚ã‚Šã€ãã‚ŒãŒå…±ç”Ÿç¤¾ä¼šã®æ§‹ç¯‰ã«ä¸å¯æ¬ ã§ã‚ã‚‹ã€‚
ã‚¹ãƒãƒ¼ãƒ„ã®ãƒ—ãƒ­ã¨ã‚¢ãƒžã¯ã€æŠ€è¡“åŠ›ã ã‘ã§ãªãã€çµŒæ¸ˆçš„å ±é…¬ã€ç²¾ç¥žåŠ›ã€å°‚é–€çŸ¥è­˜ã®é¢ã§ã‚‚ç•°ãªã‚‹ã€‚ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«ã‚‚ãã®å·®ãŒç¾ã‚Œã€ãƒ—ãƒ­ã¯æ´—ç·´ã•ã‚ŒãŸã‚‚ã®ã‚’ç”¨ã„ã€ã‚¢ãƒžã¯å®Ÿç”¨æ€§ã‚„ã‚³ã‚¹ãƒˆã‚’é‡è¦–ã™ã‚‹å‚¾å‘ã«ã‚ã‚‹ã€‚

### Output:
æ²–ç¸„ã®æš–ã‹ã•ã‚„ç¦å³¶ã®è‡ªç„¶ã¸ã®æ„›æƒ…ã¯ã€è‡ªåˆ†ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨æ·±ãçµã³ã¤ã„ã¦ãŠã‚Šã€åœ°åŸŸã®ç‰¹è‰²ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã¯æ–‡åŒ–ã‚„ä¼çµ±ã‚’å‘³ã‚ã†ã“ã¨ã¸ã¨ç¹‹ãŒã‚‹ã€‚ãã®ãŸã‚ã€åœ°åŸŸã®è‡ªç„¶ã¨ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’æ´»ã‹ã—ãŸã‚¹ã‚¤ãƒ¼ãƒ„ã§ç¦å³¶çœŒã‚’æ´»æ€§åŒ–ã™ã‚‹ã“ã¨ã‚„ã€åœ°åŸŸæ„›ã‚„ç’°å¢ƒã¸ã®é…æ…®ã€é£Ÿå“ãƒ­ã‚¹å‰Šæ¸›ãªã©ã«èˆˆå‘³ãŒã‚ã‚‹ã€‚ç„¡é§„ã®ãªã„ã€åœ°åŸŸã«æ ¹ä»˜ã„ãŸé£Ÿæ–‡åŒ–ã®é‡è¦æ€§ã‚’æ„Ÿã˜ã€æŒç¶šå¯èƒ½ãªç¤¾ä¼šã‚’å®Ÿç¾ã—ãŸã„ã¨è€ƒãˆã¦ãŠã‚Šã€ãã®ãŸã‚ã«ã¯åœ°åŸŸã®äº¤é€šã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚‚é‡è¦ãªèª²é¡Œã§ã‚ã‚‹ã€‚è‹¥è€…ã¨ã—ã¦ã€ã“ã‚Œã‚‰ã®è­°è«–ã«ç©æ¥µçš„ã«å‚åŠ ã—ãŸã„ã¨æ€ã†ã€‚
ã“ã®ã‚ˆã†ã«ã€éŽç–ŽåŒ–ã¨äº¤é€šå•é¡Œã‚’å…‹æœã—ã€ç¦å³¶ã®é£Ÿæ–‡åŒ–ã‚’æ´»ã‹ã—ãŸåœ°åŸŸæ´»æ€§åŒ–ã®ãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŒã¤ã“ã¨ã¯ã€åœ°åŸŸã®äººã€…ã¨å”åŠ›ã—éŽç–ŽåŒ–ã‚’é£Ÿã„æ­¢ã‚ã€ã‚ˆã‚Šè‰¯ã„æœªæ¥ã‚’å‰µã‚‹éµã ã¨ç¢ºä¿¡ã—ã¦ã„ã‚‹ã€‚ã¾ãŸã€å½¼å¥³ã®æ­´å²ã¸ã®èˆˆå‘³ã‚’å…±æœ‰ã—ã€äº¬éƒ½ã§ã®åº§ç¦…ä½“é¨“ã‚„å¤ã„ç”ºä¸¦ã¿ã‚’é€šã˜ã¦ã€ã‚ˆã‚Šæ·±ã„çµ†ã‚’è‚²ã‚€ã“ã¨ã‚‚é‡è¦ã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚æ­´å²ã‚„åœ°åŸŸæ–‡åŒ–ã«è§¦ã‚Œã‚‹ã“ã¨ã¯ã€ç§ãŸã¡ã®ç”Ÿãæ–¹ã‚’è¦‹ã¤ã‚ç›´ã—ã€ã‚ˆã‚Šäººé–“ã‚‰ã—ã•ã«å›žå¸°ã—å…±ã«æˆé•·ã™ã‚‹æ©Ÿä¼šã‚’æä¾›ã™ã‚‹ã€‚ç§è‡ªèº«ã€ç”Ÿã¾ã‚Œè‚²ã£ãŸåœ°åŸŸã¸ã®æ·±ã„æ„›æƒ…ã‚’æŒã¡ã€åœ°å…ƒã®æ–‡åŒ–ã‚„ä¼çµ±ã€ç¥­ã‚Šã‚„è¡Œäº‹ã¸ã®å‚åŠ ã‚’é€šã˜ã¦å…±åŒä½“ã®ä¸€å“¡ã¨ã—ã¦ã®çµ†ã‚’æ„Ÿã˜ã¦ã„ã‚‹ã€‚ã“ã®åœ°åŸŸæ„›ã¯ã€ç§ãŸã¡ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‚²ã¿ã€æœªæ¥ã¸ç¹‹ã’ã¦ã„ãã¹ãä¾¡å€¤ã ã¨ç†è§£ã—ã¦ã„ã‚‹ã€‚
ã¾ãŸiPadã‚’ä½¿ã£ãŸã‚¤ãƒ©ã‚¹ãƒˆã®æ‰èƒ½ã‚’æ´»ã‹ã—ã€åŽŸä½œã®é­…åŠ›ã‚’æãªã‚ãšã«æ„Ÿå‹•ã‚’ä¸Žãˆã‚‹ä½œå“ã‚’å‰µé€ ã—ãŸã„ã¨ã®æ€ã„ã‚’æŒã£ã¦ã„ã‚‹ã€‚åŽŸä½œã®æ„Ÿå‹•ã‚’ã‚¢ãƒ‹ãƒ¡ã§ã©ã†è¡¨ç¾ã™ã‚‹ã‹ã¯å¤§ããªèª²é¡Œã§ã‚ã‚‹ãŒã€ãƒ‡ã‚¸ã‚¿ãƒ«ã®åˆ©ç‚¹ã‚’æ´»ã‹ã—å‰µé€ çš„ãªè©¦ã¿ã«ã‚ˆã‚Šæ–°ã—ã„é­…åŠ›ã‚’åŠ ãˆã€åŽŸä½œã¸ã®æ•¬æ„ã‚’ä¿ã¡ã¤ã¤æ„Ÿå‹•ã‚’å†å‰µé€ ã—ãŸã„ã€‚ãã‚ŒãŒä½•ã‚‰ã‹ã®å½¢ã§åœ°åŸŸæ„›ã®è‚²æˆã«ã¤ãªãŒã‚Œã°å¬‰ã—ã„ã€‚
å›½éš›ç¤¾ä¼šã«ç›®ã‚’å‘ã‘ã‚Œã°ã€ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã¨ãƒ­ã‚·ã‚¢ã®æˆ¦äº‰è§£æ±ºã¯ã€å…¨ä½“ã®å¹³å’Œé¡˜æœ›ã‚’é‡ã‚“ã˜ã€å®Ÿè¡Œå¯èƒ½ãªå¯¾è©±ã¨è§£æ±ºç­–ã‚’æ¨¡ç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚æœªæ¥ã®ç¤¾ä¼šã«è²¢çŒ®ã™ã‚‹æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã¸ã®æ¸‡æœ›ã¯ã€å˜ãªã‚‹æ„Ÿæƒ…ã§ã¯ãªãã€å†…é¢ã‹ã‚‰ã®å¼·ã„æ¬²æ±‚ã§ã‚ã‚Šã€ç¾æ•™è‚²ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç–‘å•ã¨å®¿é¡Œã®å¤šã•ã¸ã®ä¸æº€ã¯ã€æ•™è‚²ã®æœ¬è³ªã‚’è¦‹ç›´ã™å¿…è¦æ€§ã‚’ç¤ºå”†ã—ã¦ã„ã‚‹ã€‚å­ã©ã‚‚ã‚‚å¤§äººã‚‚ã€å¹´é½¢ã«é–¢ã‚ã‚‰ãšã€å¸¸ã«æ–°ã—ã„ã“ã¨ã‚’å­¦ã³ç¶šã‘ã‚‹ã“ã¨ãŒå¿…è¦ã§ã‚ã‚Šã€éšœå®³è€…ã‚‚å«ã‚ãŸã™ã¹ã¦ã®äººã€…ãŒç¤¾ä¼šã«ãŠã„ã¦å°Šé‡ã•ã‚Œã€èƒ½åŠ›ã‚’ç™ºæ®ã§ãã‚‹ç’°å¢ƒã‚’ä½œã‚‹ã“ã¨ã®é‡è¦æ€§ã‚’èªè­˜ã—ã¦ã„ã‚‹ã€‚ãã†ã—ãŸç¤¾ä¼šã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ã§ã€å¹³å’Œãªä¸–ç•Œã‚’å–ã‚Šæˆ»ã™ã“ã¨ãŒã§ãã‚‹ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
å…±ç”Ÿç¤¾ä¼šã«ãŠã„ã¦ã¯ã€éšœå®³è€…ã‚’å«ã‚å…¨ã¦ã®äººãŒã€è‡ªå·±ã®èƒ½åŠ›ã‚’ç™ºæ®ã—å°Šé‡ã•ã‚Œã‚‹ç’°å¢ƒãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚ãã‚Œã«ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãæ„ç¾©ã‚ã‚‹å­¦ã³ãŒå¿…è¦ã§ã‚ã‚Šã€ãã‚ŒãŒå…±ç”Ÿç¤¾ä¼šã®æ§‹ç¯‰ã«ä¸å¯æ¬ ã§ã‚ã‚‹ã€‚ã‚¹ãƒãƒ¼ãƒ„ã®ä¸–ç•Œã§ã‚‚ã€ãƒ—ãƒ­ã¨ã‚¢ãƒžã®é•ã„ã¯æŠ€è¡“åŠ›ã ã‘ã§ã¯ãªãã€çµŒæ¸ˆçš„å ±é…¬ã€ç²¾ç¥žåŠ›ã€å°‚é–€çŸ¥è­˜ã®é¢ã§ã‚‚ç•°ãªã‚Šã€ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«ã‚‚ãã®å·®ãŒç¾ã‚Œã¦ã„ã‚‹ã€‚ãƒ—ãƒ­ã¯æ´—ç·´ã•ã‚ŒãŸã‚‚ã®ã‚’ç”¨ã„ã€ã‚¢ãƒžã¯å®Ÿç”¨æ€§ã‚„ã‚³ã‚¹ãƒˆã‚’é‡è¦–ã™ã‚‹å‚¾å‘ã«ã‚ã‚‹ã€‚
ã“ã‚Œã‚‰ã®è¦–ç‚¹ã‹ã‚‰ã€ç§ãŸã¡ã¯ç”Ÿæ´»ã®æ§˜ã€…ãªå´é¢ã«ãŠã„ã¦ã€å…±ç”Ÿç¤¾ä¼šã‚’ç›®æŒ‡ã—ã€ç‹¬è‡ªã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‚²ã¿ã€åœ°åŸŸæ„›ã‚’å¤§äº‹ã«ã—ãªãŒã‚‰ã€æŒç¶šå¯èƒ½ãªæœªæ¥ã‚’å‰µé€ ã™ã‚‹ãŸã‚ã«åŠªåŠ›ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚‹ã€‚

### Input:
"""

    print("prompt:", sentence)

    st.session_state.messages.append(SystemMessage(content=sentence))
    st.session_state.messages.append(HumanMessage(content=group))
    with st.spinner("KJ-GPTãŒæ–‡ç« åŒ–ã—ã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-2:])
    combined_list.append(answer)
    st.session_state.messages.append(AIMessage(content=answer))
    st.session_state.costs.append(cost)

    combined_sentences = "".join(combined_list)
    return combined_sentences

def related_sentence_generating(llm,contexts,wiki_text,translated_theme,wiki_extract):

    sentence = f"""
### Instructions:
{translated_theme}
You are an insightful detective.
Please advise on the next matter to be investigated, using the information on Wikipedia as a springboard for the text summary of your client's request.

### Condition:
Please write in Japanese.
Please write in the style of a hard-boiled novel, in a bleak and immediate manner.

### Summary:
{contexts}

### Wikipedia:
{wiki_extract}
{wiki_text}
"""
    
#     detective = """
# ### Instructions:
# You are an insightful detective.
# As in the example, write a sentence in the style of a hard-boiled novel about a detective listening to his client and thinking.

# ### Condition:
# Please write in Japanese.
# The text should be no more than 30 words.
# Verbs should be in the present progressive tense.
# Write from the client's first-person point of view.

# ### Example:
# ã“ã®æŽ¢åµã¯ã‚¿ãƒã‚³ã‚’ç‡»ã‚‰ã›ãªãŒã‚‰ã˜ã£ã¨ç›®ã‚’é–‰ã˜ã¦ã„ã‚‹

# ### Example:
# ã“ã®æŽ¢åµã¯é»™ã£ã¦å®™ã‚’è¦‹ä¸Šã’ã€çœŸã£ç™½ãªè›å…‰ç¯ã‚’è¦‹ã¤ã‚ã¦ã„ã‚‹

# ### Example:
# å¤§ããªèƒŒä¸­ã‚’å¾®å‹•ã ã«ã•ã›ãšã€ã“ã®æŽ¢åµã¯ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’ã™ã™ã£ã¦è€ƒãˆã¦ã„ã‚‹
# """

#     st.session_state.messages.append(SystemMessage(content=detective))
#     with st.spinner("åˆ†æžä¸­ ..."):
#         detective_answer, cost = get_answer(llm, st.session_state.messages[-1:])
#     st.session_state.costs.append(cost)

    print("prompt:", sentence)

    st.session_state.messages.append(SystemMessage(content=sentence))
    # st.session_state.messages.append(HumanMessage(content=group))
    with st.spinner("æŽ¢åµãŒè€ƒãˆã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-1:])
    st.session_state.messages.append(AIMessage(content=answer))
    st.session_state.costs.append(cost)
    return answer

def related_gal_sentence_generating(llm,contexts,wiki_text,translated_theme,wiki_extract):

    sentence = f"""
### Instructions:
{translated_theme}
You are a Japanese gal attending a vocational school.
Read the text summarising the questioner's concerns and advise on the next steps to take, based on information from Wikipedia.

### Condition:
Please write in Japanese.
Use the same style of writing as in the examples.
Please include three or four of the following emojis in the text in any combination of two of the following emojis.
ðŸ™‡ðŸ» ðŸ’¦ â•ã€€ðŸ™ðŸ» ðŸ‘ðŸ» ðŸ’• âœ¨ ðŸ¤ ðŸ¹ ðŸ‘¼ðŸ» ðŸ’— ðŸŒ· ðŸ‘€ ðŸ’• ðŸš¶ðŸ» ðŸ’¨ ðŸ¤¦ðŸ»â€â™€ï¸ ðŸ’ž ðŸ¥º ðŸ¤­ ðŸ’¡ ðŸ’– ðŸ™ˆ ðŸ’¦ ðŸ˜½ âœŒðŸ» ðŸƒðŸ» âž° ðŸ˜¿ ðŸŒ€ â¤ï¸Ž â€¼ï¸ ðŸ‘ðŸ» ðŸ•ºðŸ» âœ¨ ðŸ‘©ðŸ»â€â¤ï¸â€ðŸ‘©ðŸ» ðŸ’ž

### Example:
ç›¸è«‡è€…ã•ã‚“ã¸ðŸŒ·
è³ªå•ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ðŸ¥º
ã‚ã£ã¡ã‚ƒã„ã„ã“ã¨è€ƒãˆã¦ã¦ãƒªã‚¹ãƒšã‚¯ãƒˆðŸ«¶ðŸ»
è¿”ä¿¡ãŠãã‚ŒãŸã‘ã©ã‚†ã‚‹ã—ã¦ãƒ
ã‚¦ã‚£ã‚­ãƒšãƒ‡ã‚£ã‚¢ã¯åˆãƒŠãƒ¼ã‚¹ã¡ã‚ƒã‚“ã ã‚ˆðŸ–¤
ã¯ãšã‹ã—ãã¦å®¶ã§ä¸€çž¬ç€ãŸã ã‘(ï¼¾ï¼¾)
ç›¸è«‡è€…ã•ã‚“ã¯ãƒãƒ­ã‚¦ã‚£ãƒ³ã©ã£ã‹ã„ã£ãŸï¼Ÿï¼Ÿ

### Summary:
{contexts}

### Wikipedia:
{wiki_extract}
{wiki_text}
"""
    print("prompt:", sentence)

    st.session_state.messages.append(SystemMessage(content=sentence))
    # st.session_state.messages.append(HumanMessage(content=group))
    with st.spinner("DMãŒè¿”ã£ã¦ãã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™ ..."):
        answer, cost = get_answer(llm, st.session_state.messages[-1:])
    st.session_state.messages.append(AIMessage(content=answer))
    st.session_state.costs.append(cost)
    return answer

def messages_init():
    st.session_state.messages = [
        SystemMessage(content=""),
        HumanMessage(content=""),
        AIMessage(content="")
    ]

def main():
    init_page()

    # OpenAI API Keyã®å…¥åŠ›
    with st.form("my_api_key", clear_on_submit=True):
        openai_api_key = st.text_input("OpenAI API Key", type="password")
        api_key_button = st.form_submit_button(label="å®Œäº†")
    
        if api_key_button and openai_api_key:
            st.session_state["openai_api_key"] = openai_api_key
    if openai_api_key:
        llm = select_model(openai_api_key)
    init_messages()

    translated_theme = None

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ç›£è¦–
    theme_container = st.container()
    with theme_container:
        with st.form(key="my_theme", clear_on_submit=False):
            user_theme = st.text_area(label="ãƒ†ãƒ¼ãƒž: ", key="theme_input", height=50)
            st.text("ã«ã¤ã„ã¦")
            theme_button = st.form_submit_button(label="æ±ºå®š")
        if theme_button and user_theme:
            st.session_state["user_theme"] = user_theme
            translated_theme = theme_translate(user_theme,st.session_state["openai_api_key"])


    container = st.container()
    with container:
        with st.form(key="my_form", clear_on_submit=False):
            user_input = st.text_area(label="é …ç›®ãƒ©ãƒ™ãƒ«: ", key="input", height=300)
            
            # generating_button = st.form_submit_button(label="é …ç›®è‡ªå‹•ç”Ÿæˆ")
            grouping_button = st.form_submit_button(label="ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ")
            # labeling_button = st.form_submit_button(label="è¡¨æœ­ã¥ãã‚Š")
            # symbol_button = st.form_submit_button(label="ã‚·ãƒ³ãƒœãƒ«ä½œæˆ")

        # if generating_button and user_theme:
        #     prompt_ptrn = data_generating(user_theme,st.session_state["openai_api_key"])
        #     st.session_state.messages.append(SystemMessage(content=prompt_ptrn))
        #     st.session_state.messages.append(HumanMessage(content=user_input))
        #     with st.spinner("KJ-GPTãŒå…ƒãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ ..."):
        #         answer, cost = get_answer(llm, st.session_state.messages[-2:])
        #     st.session_state.messages.append(AIMessage(content=answer))
        #     st.session_state.costs.append(cost)

        if grouping_button and user_input:
            group_list = get_init_list(user_input)
            number_of_items = len(group_list)
            print(number_of_items)
            labeling_pair = []
            dict = {}
            count = 1
            while number_of_items > 5:
                # lines = count_newlines(user_input)
                if translated_theme is None:
                    translated_theme = theme_translate(user_theme,st.session_state["openai_api_key"])
                prompt_ptrn = prompt_grouping(number_of_items, translated_theme)
                st.session_state.messages.append(SystemMessage(content=prompt_ptrn))
                st.session_state.messages.append(HumanMessage(content=user_input))
                with st.spinner(f"KJ-GPTãŒãƒ©ãƒ™ãƒ«ã‚’é›†ã‚ã¦ã„ã¾ã™ï¼ˆ{count}å›žç›®ï¼šæ®‹ã‚Šãƒ©ãƒ™ãƒ«æ•°{number_of_items}ï¼‰ ..."):
                    answer, cost = get_answer(llm, st.session_state.messages[-2:])
                st.session_state.messages.append(AIMessage(content=answer))
                st.session_state.costs.append(cost)
                group_list = get_list(answer)
                for group in group_list:
                    if isinstance(group, list):
                        group_string = "\n".join(group)
                        if number_of_items >= 20:
                            prompt_ptrn = labeling1
                        elif 16 <= number_of_items < 20:
                            prompt_ptrn = labeling2
                        elif 12 <= number_of_items < 16:
                            prompt_ptrn = labeling3
                        elif 8 <= number_of_items < 12:
                            prompt_ptrn = labeling4
                        else:
                            prompt_ptrn = labeling5
                        st.session_state.messages.append(SystemMessage(content=prompt_ptrn))
                        st.session_state.messages.append(HumanMessage(content=group_string))
                        with st.spinner("KJ-GPTãŒè¡¨æœ­ã‚’è€ƒãˆã¦ã„ã¾ã™ ..."):
                            answer, cost = get_answer(llm, st.session_state.messages[-2:])
                        group_list.append(answer)
                        dict = {answer: group}
                        labeling_pair.append(dict)
                        st.session_state.messages.append(AIMessage(content=answer))
                        st.session_state.costs.append(cost)
                    # else:
                    #     labeling_pair.append(group)
                group_list = [item for item in group_list if not isinstance(item, list)]
                # print(labeling_pair)
                group_list_str = "\n".join(group_list)
                user_input = group_list_str
                # result = st.text_area(label=f"{count}å›žç›®ã®çµæžœ: ", key=f"result{count}", value=group_list_str, height=300)
                count += 1
                number_of_items = len(group_list)
            # symbol_input_list = get_list(user_input)
            # print("symbol_input_list:", symbol_input_list)
            top_items = []
            symbol_sets = []
            symbol_dict = {}
            symbol_count = 0

            # æœ€ä¸Šä½ã®å³¶ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            symbol_list_length = number_of_items

            # æœ€ä¸Šä½ã®å³¶ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ã‚·ãƒ³ãƒœãƒ«ãƒžãƒ¼ã‚¯ã‚’ä½œæˆ
            for item in group_list:
                
                # ã‚·ãƒ³ãƒœãƒ«ãƒžãƒ¼ã‚¯ã®ç·æ•°ã‹ã‚‰ãƒ«ãƒ¼ãƒ—ã”ã¨ã«1ãšã¤æ¸›ã‚‰ã—ãŸæ•°
                symbol_reversed_count = symbol_list_length - symbol_count

                item_str = str(item)
                st.session_state.messages.append(SystemMessage(content=symbol))
                st.session_state.messages.append(HumanMessage(content=item_str))
                with st.spinner("KJ-GPTãŒã‚·ãƒ³ãƒœãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™ ..."):
                    symbol_answer, cost = get_answer(llm, st.session_state.messages[-2:])
                symbol_set = symbol_answer + "ï¼š" + item_str
                symbol_title = "**" + f"({symbol_reversed_count}) " +  symbol_answer + "**"
                symbol_dict["# " + item_str] = symbol_title + "\n" + "# " + item_str
                # print("symbol_set", symbol_set)
                top_items.append(item_str)
                symbol_sets.append(symbol_set)
                st.session_state.messages.append(AIMessage(content=answer))
                st.session_state.costs.append(cost)

                symbol_count += 1

            symbol_str = "\n".join(symbol_sets)
            # st.text_area(label="ã‚·ãƒ³ãƒœãƒ«: ", value=symbol_str, key="final_result", height=300)
            # st.text_area(label="è¾žæ›¸: ", value=labeling_pair, key="final_dict", height=300)

            markdown_text = ""

            # top_itemsã®ãƒªã‚¹ãƒˆã‚’é€†é †ã§å‡¦ç†
            reversed_top_items = list(reversed(top_items))

            # reversed_top_itemsãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦æœ€ä¸Šä½ã®è¦‹å‡ºã—ã‚’å‡¦ç†ã—ã¾ã™ã€‚
            for top_item in reversed_top_items:
                # top_text = top_item.split("ï¼š")[1].strip()
                markdown_text += add_markdown_entry(1, top_item)  # æœ€ä¸Šä½ã®è¦‹å‡ºã—ã‚’é€†é †ã§èª­ã¿è¾¼ã‚“ã§è¿½åŠ 
                markdown_text += find_sub_items(top_item, 2, labeling_pair)  # ã‚µãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŽ¢ã—ã¦è¿½åŠ 
            for key, value in symbol_dict.items():
                markdown_text = markdown_text.replace(key, value)

            st.session_state["markdown_text"] = markdown_text

            converted_markdown = headline_to_list(markdown_text)
            st.markdown(converted_markdown)
            
            # st.text_area(label="Mark down: ", value=markdown_text, key="markdown", height=450)

            # st.text_area(label="éšŽå±¤åŒ–ãƒ‡ãƒ¼ã‚¿: ", key="layered_data", value=markdown_text, height=300)
    
    sentence_container = st.container()
    with sentence_container:
        with st.form(key="my_sentence", clear_on_submit=False):
            layered_data = st.text_area(label="éšŽå±¤åŒ–ãƒ‡ãƒ¼ã‚¿: ", key="layered_data", value=st.session_state["markdown_text"], height=300)
            sentence_button = st.form_submit_button(label="ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡ç« åŒ–")
        if sentence_button and layered_data:

            # ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢"éšŽå±¤åŒ–ãƒ‡ãƒ¼ã‚¿"ã®ãƒ‡ãƒ¼ã‚¿ã§session_stateã®"markdown_text"ã‚’æ›´æ–°
            st.session_state["markdown_text"] = layered_data

            # å¤‰æ•°answerã‚’ãƒªã‚»ãƒƒãƒˆ
            answer = ""
            # å¤‰æ•°labelã‚’ãƒªã‚»ãƒƒãƒˆ
            label = ""
            sentence = f"""
### Instructions:
{translated_theme}
You are a philosopher who excels at introspection. Please logically connect each of the following bulleted items into a sentence.
Please add philosophical criticism along the way.

### Condition:
Please write in Japanese.
Any additional explanations should be enclosed in parentheses.
The bullet points to be entered can be summarized as follows; {label}

### Input:
### å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œ
### æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„

### Output:
å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œã€‚ï¼ˆç­”ãˆã®ã‚ã‚‹å•é¡Œã‚’ãŸã å¼·åˆ¶çš„ã«è§£ç­”ã•ã›ã‚‰ã‚Œã‚‹ã®ã¯ç„¡é§„ã ã¨æ€ã†ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„ChatGPTãªã©ãŒæ€¥é€Ÿã«ç™ºå±•ã—ã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã£ãŸå˜ãªã‚‹æš—è¨˜ã‚„è«–ç†è¨ˆç®—ã¯ã€ãã®ã†ã¡äººé–“ãŒã‚„ã‚‹å¿…è¦ã¯ãªããªã‚‹ã¨æ€ã†ã€‚ãã‚Œãªã®ã«ã€ã“ã®ã¾ã¾åå·®å€¤è‡³ä¸Šä¸»ç¾©ã®è©°ã‚è¾¼ã¿æ•™è‚²ã§ä»Šå¾Œã‚‚ã‚„ã£ã¦ã„ããªã‚‰ã°ã€ä½•ã®å½¹ã«ã‚‚ç«‹ãŸãªã„å¤§äººã‚’è‚²ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚ï¼‰
ãã†ã§ã¯ãªãã¦ã€ã‚‚ã£ã¨æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„ã€‚ï¼ˆç­”ãˆã®ãªã„å•ã„ã«è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ç«‹ã¡å‘ã‹ã£ãŸã‚Šã€è‡ªåˆ†ã ã‘ã®ç‰¹åˆ¥ãªèˆˆå‘³é–¢å¿ƒã‚’è‚²ã¦ã¦å°‚é–€æ€§ã‚’é«˜ã‚ãŸã‚Šã™ã‚‹å‹‰å¼·ã®æ–¹ãŒä»Šå¾Œæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã¯æ˜Žã‚‰ã‹ã ã€‚ï¼‰

### Input:
"""
            
            simplified_answer = ""
            simplifying_sentence = f"""
### Instruction:
{translated_theme}
Please summarise the text in 1~2 lines, including the bracketed parts.

### Condition:
Please write in Japanese.
Please make sure that the text is chewed up in a way that high school students can understand.
Lines beginning with bracketed numbers should be transcribed in their original position and with no change in content.
Please add a logical connection to the text below.
{simplified_answer}

### Input:
(1) å¸¸è­˜ã¯ãšã‚Œã®å¤§åˆ‡ãªè¡Œå‹•

å®¿é¡ŒãŒå¤šã™ãŽã¦èª²é¡Œã‚’ã“ãªã™ã ã‘ã«ãªã£ã¦ã„ã‚‹ã®ãŒå«Œã€‚ï¼ˆç­”ãˆã®ã‚ã‚‹å•é¡Œã‚’ãŸã å¼·åˆ¶çš„ã«è§£ç­”ã•ã›ã‚‰ã‚Œã‚‹ã®ã¯ç„¡é§„ã ã¨æ€ã†ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„ChatGPTãªã©ãŒæ€¥é€Ÿã«ç™ºå±•ã—ã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã£ãŸå˜ãªã‚‹æš—è¨˜ã‚„è«–ç†è¨ˆç®—ã¯ã€ãã®ã†ã¡äººé–“ãŒã‚„ã‚‹å¿…è¦ã¯ãªããªã‚‹ã¨æ€ã†ã€‚ãã‚Œãªã®ã«ã€ã“ã®ã¾ã¾åå·®å€¤è‡³ä¸Šä¸»ç¾©ã®è©°ã‚è¾¼ã¿æ•™è‚²ã§ä»Šå¾Œã‚‚ã‚„ã£ã¦ã„ããªã‚‰ã°ã€ä½•ã®å½¹ã«ã‚‚ç«‹ãŸãªã„å¤§äººã‚’è‚²ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚ï¼‰
ãã†ã§ã¯ãªãã¦ã€ã‚‚ã£ã¨æœªæ¥ã®ç¤¾ä¼šã‚’ç™ºå±•ã•ã›ã‚‹ã‚ˆã†ãªæ„å‘³ã‚ã‚‹å‹‰å¼·ãŒã—ãŸã„ã€‚ï¼ˆç­”ãˆã®ãªã„å•ã„ã«è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ç«‹ã¡å‘ã‹ã£ãŸã‚Šã€è‡ªåˆ†ã ã‘ã®ç‰¹åˆ¥ãªèˆˆå‘³é–¢å¿ƒã‚’è‚²ã¦ã¦å°‚é–€æ€§ã‚’é«˜ã‚ãŸã‚Šã™ã‚‹å‹‰å¼·ã®æ–¹ãŒä»Šå¾Œæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã¯æ˜Žã‚‰ã‹ã ã€‚ï¼‰ã¤ã¾ã‚Šã€ç›®å…ˆã®å®¿é¡Œã‚’æ¶ˆåŒ–ã™ã‚‹ã ã‘ã§ã¯ãªãã€å°†æ¥ã®ç¤¾ä¼šã«æ„ç¾©ã®ã‚ã‚‹å­¦ã³ã‚’ã—ãŸã„ã¨ã„ã†ã“ã¨ã€‚ãã—ã¦ãã®ãŸã‚ã«ã¯ã€å­ã©ã‚‚ã ã‘ã˜ã‚ƒãªãå¤§äººã®æ•™è‚²ã‚‚å¿…è¦ã ã¨æ€ã†ã€‚
ï¼ˆãã‚‚ãã‚‚ä»Šã®æ•™å¸«ãŒæ˜”ãªãŒã‚‰ã®è©°ã‚è¾¼ã¿å¼ã®æ•™è‚²ã§è‚²ã£ãŸã®ã§ã€ãã®æ„è­˜æ”¹é©ãŒå¿…è¦ã ã€‚æ•™å¸«è‡ªèº«ãŒç­”ãˆã®ãªã„è‡ªåˆ†ã®å¿ƒã®åº•ã‹ã‚‰å‡ºã¦ããŸå•ã„ã‚’è¨­å®šã—ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«ãã‚Œã«å–ã‚Šçµ„ã‚€å§¿å‹¢ã‚’è¦‹ã›ãªã„ã¨ã€å­ä¾›é”ã¯ã¤ã„ã¦ã„ã‹ãªã„ã€‚ãã‚Œã ã‘ã§ã¯ãªãã€å­ä¾›ã®è¦ªãŸã¡ã‚‚æ–°ã—ã„å­¦ã³ã‚’äººç”Ÿã«å–ã‚Šå…¥ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ç­”ãˆã®ãªã„æŽ¢ç©¶æ´»å‹•ã¯å¾“æ¥ã®å­¦ç¿’ã«æ¯”ã¹ã¦ã€ã‚ˆã‚Šæ—¥å¸¸ç”Ÿæ´»ã«æ·±ãé–¢ã‚ã‚‹ã‚‚ã®ã ã€‚æ™®æ®µéŽã”ã—ã¦ã„ã‚‹ä¸­ã§æ„Ÿã˜ã‚‹ç–‘å•ã‚„é•å’Œæ„Ÿãªã©ã‚’èµ·ç‚¹ã«ã—ãŸã€å®Ÿä½“é¨“ã«å³ã—ãŸå•ã„ã§ã‚ã‚‹ã»ã©ã€ä»Šå¾Œã®é•·ã„äººç”Ÿã§å–ã‚Šçµ„ã‚€ã«å€¤ã™ã‚‹æ·±ã„ã‚‚ã®ã«ãªã‚Šã‚„ã™ã„ã€‚ãªã®ã§ã€ã“ã‚Œã¾ã§ã®ã‚ˆã†ã«è¦ªãŒæ•™è‚²ã‚’å­¦æ ¡ã‚„å¡¾ã«ä»»ã›ã£ã±ãªã—ã«ã—ã¦ã€å®¶åº­ã§å­ä¾›ã«ç„¡é–¢å¿ƒã§ã„ã¦ã¯å­ä¾›ã®æŽ¢ç©¶å¿ƒãŒè‚²ã¡ã«ãããªã‚‹ã€‚æ•™å¸«ã¨åŒã˜ã‚ˆã†ã«ã€è¦ªãŸã¡ã‚‚è‡ªåˆ†ã®å•ã„ã‚’ç«‹ã¦ã¦ãã‚Œã‚’è¿½æ±‚ã™ã‚‹å–¶ã¿ã‚’å®Ÿéš›ã«ã‚„ã‚‹ã¹ãã ã€‚ãã—ã¦ã€ãã®è¡Œå‹•ãŒå­ä¾›ãŸã¡ã‚’æ„ŸåŒ–ã•ã›ã€å®¶åº­ã‚’æ´»æ°—ã¥ã‹ã›ã¦ã€ã•ã‚‰ã«ã¯è·å ´ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚‚ä¸Šã’ã‚‹ã“ã¨ã«ãªã‚‹ã®ãŒç†æƒ³ã ã€‚ï¼‰ã“ã®ã‚ˆã†ã«ã€æœªæ¥ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹æœ¬å½“ã®å­¦ã³ã¯ã€å¹´é½¢ã«é–¢ä¿‚ãªãèª°ã«ã§ã‚‚é‡è¦ã¨è¨€ãˆã‚‹ã€‚

### Output:
(1) å¸¸è­˜ã¯ãšã‚Œã®å¤§åˆ‡ãªè¡Œå‹•

ãŸã å•é¡Œã®ç­”ãˆã‚’æ•™ãˆè¾¼ã‚€å¤ã„ã‚„ã‚Šæ–¹ã§ã¯ãªãã€ãªãœãã†ãªã‚‹ã®ã‹ã‚’è€ƒãˆãŸã‚Šã€æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã‚Šã™ã‚‹å­¦ã³ãŒå¤§åˆ‡ã ã£ã¦è©±ã ã‚ˆã€‚ãƒãƒƒãƒˆã‚„ChatGPTã¿ãŸã„ãªè³¢ã„ãƒ„ãƒ¼ãƒ«ãŒãŸãã•ã‚“ã‚ã‚‹ã‹ã‚‰ã€å˜ç´”ãªæš—è¨˜ã‚„è¨ˆç®—ã¯ã‚‚ã†äººé–“ãŒã‚ã–ã‚ã–ã‚„ã‚‹ã“ã¨ã˜ã‚ƒãªããªã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ãªã€‚ã§ã‚‚ã€å­¦æ ¡ãŒä»Šã®ã¾ã¾è©°ã‚è¾¼ã¿ã§ç‚¹æ•°ã ã‘è¿½ã„ã‹ã‘ã‚‹æ•™è‚²ã‚’ç¶šã‘ãŸã‚‰ã€æœ¬å½“ã«å¿…è¦ãªã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã‚‰ã‚Œãªã„å¤§äººã«ãªã£ã¦ã—ã¾ã†ã€‚
ã“ã‚Œã‹ã‚‰ã¯ã€ç­”ãˆãŒã™ãã«ã¯å‡ºãªã„ã‚ˆã†ãªå•é¡Œã«ã©ã†ç«‹ã¡å‘ã‹ã†ã‹ã€è‡ªåˆ†ã®å¥½ããªã“ã¨ã‚’è¦‹ã¤ã‘ã¦æ·±ãæŽ˜ã‚Šä¸‹ã’ã‚‹å­¦ã³ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚“ã ã€‚å…ˆç”ŸãŸã¡ã‚‚æ˜”ã®ã‚„ã‚Šæ–¹ã‹ã‚‰å¤‰ã‚ã£ã¦ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«è€ƒãˆã‚‹ã“ã¨ãŒå¤§äº‹ã ã—ã€ãã‚Œã¯è¦ªã‚‚åŒã˜ã€‚å®¶ã§ã®å­¦ã³ã‚‚ã™ã”ãé‡è¦ã§ã€è¦ªãŒè‡ªåˆ†ã§ç–‘å•ã‚’æŒã£ã¦è€ƒãˆã‚‹å§¿ã‚’å­ä¾›ã«è¦‹ã›ã‚‹ã“ã¨ãŒã€å­ä¾›ã®å¥½å¥‡å¿ƒã‚’è‚²ã¦ã‚‹ã‚“ã ã€‚
ã¤ã¾ã‚Šã€å­¦æ ¡ã‚„å¡¾ã ã‘ã˜ã‚ƒãªãã¦ã€å®¶ã§ã‚‚è¦ªãŒå­ä¾›ã¨ä¸€ç·’ã«æ–°ã—ã„ã“ã¨ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸã‚Šã€è€ƒãˆãŸã‚Šã™ã‚‹ã“ã¨ãŒã€å­ä¾›ã®æˆé•·ã«ã¨ã£ã¦ã¯ã‚ã¡ã‚ƒãã¡ã‚ƒå¤§äº‹ã£ã¦ã‚ã‘ã€‚ãã†ã™ã‚‹ã¨ã€å®¶ã®ä¸­ã‚‚ã‚‚ã£ã¨æ¥½ã—ããªã£ã¦ã€è¦ªã®ä»•äº‹ã®ã‚„ã‚‹æ°—ã«ã‚‚ã¤ãªãŒã‚‹ã‚“ã ã€‚

### Input:
"""
            
            summarized_answer = ""
            summarized_sentence = f"""
### Instruction:
{translated_theme}
Briefly summarize the following sentences in one sentence.

### Condition:
Please write in Japanese.
Please make sure that the text is chewed up in a way that high school students can understand.
Please add a logical connection and a conjunction to the the text below.
{summarized_answer}

### Input:
ãŸã å•é¡Œã®ç­”ãˆã‚’æ•™ãˆè¾¼ã‚€å¤ã„ã‚„ã‚Šæ–¹ã§ã¯ãªãã€ãªãœãã†ãªã‚‹ã®ã‹ã‚’è€ƒãˆãŸã‚Šã€æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã‚Šã™ã‚‹å­¦ã³ãŒå¤§åˆ‡ã ã£ã¦è©±ã ã‚ˆã€‚ãƒãƒƒãƒˆã‚„ChatGPTã¿ãŸã„ãªè³¢ã„ãƒ„ãƒ¼ãƒ«ãŒãŸãã•ã‚“ã‚ã‚‹ã‹ã‚‰ã€å˜ç´”ãªæš—è¨˜ã‚„è¨ˆç®—ã¯ã‚‚ã†äººé–“ãŒã‚ã–ã‚ã–ã‚„ã‚‹ã“ã¨ã˜ã‚ƒãªããªã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ãªã€‚ã§ã‚‚ã€å­¦æ ¡ãŒä»Šã®ã¾ã¾è©°ã‚è¾¼ã¿ã§ç‚¹æ•°ã ã‘è¿½ã„ã‹ã‘ã‚‹æ•™è‚²ã‚’ç¶šã‘ãŸã‚‰ã€æœ¬å½“ã«å¿…è¦ãªã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã‚‰ã‚Œãªã„å¤§äººã«ãªã£ã¦ã—ã¾ã†ã‚ˆã€‚
ã“ã‚Œã‹ã‚‰ã¯ã€ç­”ãˆãŒã™ãã«ã¯å‡ºãªã„ã‚ˆã†ãªå•é¡Œã«ã©ã†ç«‹ã¡å‘ã‹ã†ã‹ã€è‡ªåˆ†ã®å¥½ããªã“ã¨ã‚’è¦‹ã¤ã‘ã¦æ·±ãæŽ˜ã‚Šä¸‹ã’ã‚‹å­¦ã³ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚“ã ã€‚å…ˆç”ŸãŸã¡ã‚‚æ˜”ã®ã‚„ã‚Šæ–¹ã‹ã‚‰å¤‰ã‚ã£ã¦ã€ç”Ÿå¾’ã¨ä¸€ç·’ã«è€ƒãˆã‚‹ã“ã¨ãŒå¤§äº‹ã ã—ã€ãã‚Œã¯è¦ªã‚‚åŒã˜ã€‚å®¶ã§ã®å­¦ã³ã‚‚ã™ã”ãé‡è¦ã§ã€è¦ªãŒè‡ªåˆ†ã§ç–‘å•ã‚’æŒã£ã¦è€ƒãˆã‚‹å§¿ã‚’å­ä¾›ã«è¦‹ã›ã‚‹ã“ã¨ãŒã€å­ä¾›ã®å¥½å¥‡å¿ƒã‚’è‚²ã¦ã‚‹ã‚“ã ã€‚
ã¤ã¾ã‚Šã€å­¦æ ¡ã‚„å¡¾ã ã‘ã˜ã‚ƒãªãã¦ã€å®¶ã§ã‚‚è¦ªãŒå­ä¾›ã¨ä¸€ç·’ã«æ–°ã—ã„ã“ã¨ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸã‚Šã€è€ƒãˆãŸã‚Šã™ã‚‹ã“ã¨ãŒã€å­ä¾›ã®æˆé•·ã«ã¨ã£ã¦ã¯ã‚ã¡ã‚ƒãã¡ã‚ƒå¤§äº‹ã£ã¦ã‚ã‘ã€‚ãã†ã™ã‚‹ã¨ã€å®¶ã®ä¸­ã‚‚ã‚‚ã£ã¨æ¥½ã—ããªã£ã¦ã€è¦ªã®ä»•äº‹ã®ã‚„ã‚‹æ°—ã«ã‚‚ã¤ãªãŒã‚‹ã‚ˆã€‚

### Output:
ã„ã¾ã®æ™‚ä»£ã¯ã€å˜ç´”ãªæš—è¨˜ã‚ˆã‚Šã‚‚è€ƒãˆã‚‹åŠ›ã‚„æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã™ã‚‹åŠ›ã‚’è‚²ã¦ã‚‹å­¦ã³ãŒå¤§åˆ‡ãªã‚“ã ã€‚ãã—ã¦ã€å®¶åº­ã§ã‚‚è¦ªãŒå­ä¾›ã¨ä¸€ç·’ã«å­¦ã¶ã“ã¨ãŒã§ãã‚Œã°ã€å­ä¾›ã ã‘ã˜ã‚ƒãªãã¦è¦ªã®æˆé•·ã«ã‚‚ã¤ãªãŒã‚‹ã£ã¦ã‚ã‘ã€‚

### Input:
"""
        
            markdown_text = st.session_state["markdown_text"]
            # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚¹ãƒˆã—ãŸç®‡æ¡æ›¸ãå½¢å¼ã«å¤‰æ›ã€‚
            converted_markdown = headline_to_list(markdown_text)

            st.subheader("åˆ†é¡žçµæžœï¼š")

            # ãƒªã‚¹ãƒˆå½¢å¼ã®ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡ºåŠ›ã€‚
            st.markdown(converted_markdown)
            # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ®µè½ã”ã¨ã«åˆ†å‰²ã€‚
            segmented_sections = split_sections(markdown_text)
            print("segmented_sectionsã¯ã€", segmented_sections)
            basic_data_for_abduction = {}
            summarized_list = []
            summarized_each_list = []
            summarized_list_split = []
            last_answer = ""
            last_answer_summarized = ""
            just_before_answer_summarized = ""
            
            st.subheader("æ–‡ç« åŒ–ï¼š")

            for section in segmented_sections:

                # "**"ã§æŒŸã¾ã‚ŒãŸã‚·ãƒ³ãƒœãƒ«ãƒžãƒ¼ã‚¯ã‚’æŠ½å‡ºã™ã‚‹
                symbol_pattern = r"(\*\*.*?\*\*)"
                matches_symbol = re.findall(symbol_pattern, section)
                matches_symbol = "\n" + matches_symbol[0]

                # ã‚·ãƒ³ãƒœãƒ«ãƒžãƒ¼ã‚¯ã‚’é™¤ã„ãŸãƒ©ãƒ™ãƒ«ç¾¤ã‚’labels_onlyã«å…¥ã‚Œã‚‹
                labels_only = section.replace(matches_symbol, "")

                # labels_onlyã®é …ç›®ã‚’é€†é †ã«ä¸¦ã³æ›¿ãˆã¦labels_only_reversedã«å…¥ã‚Œã‚‹
                labels_only_lines = labels_only.strip().split("\n")
                labels_only_reversed = "\n".join(list(reversed(labels_only_lines)))

                # ã‚·ãƒ³ãƒœãƒ«ãƒžãƒ¼ã‚¯ã‚’ç« ç«‹ã¦ã¨ã—ã¦å‡ºåŠ›
                st.markdown(matches_symbol)

                # BDAï¼ˆBasic Data for Abductionï¼‰ã¨ã—ã¦3è¡Œãšã¤ã«åˆ†å‰²
                basic_data_for_abduction = segmented_by_three(labels_only_reversed)
                print("basic_data_for_abductionã¯ã€", basic_data_for_abduction)

                # BDAã”ã¨ã«æ–‡ç« åŒ–
                for group in basic_data_for_abduction:
                    print("basic_data_for_abductionã®ã‚°ãƒ«ãƒ¼ãƒ—ï¼š", group)
                    # sentence_generatingã§æ–‡ç« åŒ–ã—ã€è¿”ã—å€¤ã®è¦ç´„æ–‡ã‚’just_before_answer_summarizedã«æ ¼ç´
                    just_before_answer_summarized = sentence_generating(llm,group,st.session_state["translated_theme"],summarized_list,st.session_state["openai_api_key"])
                    summarized_list.append(just_before_answer_summarized)

                # print("1240è¡Œç›®ã®summarized_listï¼š", summarized_list)
                # summarized_list = [s for s in summarized_list if s != ""]

                # # ä¸€ã¤ã®å³¶ã®BDAãŒ4ã¤ä»¥ä¸Šã«ãªã£ãŸå ´åˆã€BDAã®è¦ç´„ã‚’3ã¤ãšã¤ã«åˆ†ã‘ã¦ãã‚Œãžã‚Œè¦ç´„ã—ã€summarized_each_listã«æ ¼ç´ã™ã‚‹
                # if len(summarized_list) > 3:
                #     just_before_answer_summarized = ""
                #     for idx in range(0, len(summarized_list), 3):
                #         summarized_list_split = summarized_list[idx:idx + 3]
                #         print("1246è¡Œç›®ã®summarized_list_splitï¼š", summarized_list_split)
                #         summarized_text_each = "\n".join(summarized_list_split)
                #         just_before_answer_summarized = sumarized_sentence_generating(llm,summarized_text_each,st.session_state["translated_theme"],just_before_answer_summarized)
                #         summarized_each_list.append(just_before_answer_summarized)
                # else:
                #     summarized_each_list.append(just_before_answer_summarized)
                # summarized_list = []

                # # å³¶ã®ã‚·ãƒ³ãƒœãƒ«ãƒžãƒ¼ã‚¯ã‚’summarized_listã«å…¥ã‚Œã¦ã€æ¬¡ã®å³¶ã®æ›¸ãå§‹ã‚ã«ã¤ãªã’ã‚‹ã€‚
                # print(matches_symbol)
                # summarized_list.insert(0,st.session_state.messages[-1].content)
                # print("å³¶ã¨å³¶ã¨ã®ç¹‹ãŽã®summarized_listï¼š",summarized_list)
            
            summarized_text = "\n".join(summarized_list)
            just_before_answer_summarized = ""
            print("ã¾ã¨ã‚ã®æ–‡ç« ï¼š", summarized_text)
            st.markdown("**ã¾ã¨ã‚**")
            summarized_all = sumarized_sentence_generating(llm,summarized_text,st.session_state["translated_theme"])
            # summarized_all = summarized_all.replace("\n","")
            st.session_state["summarized_data"] = summarized_all
            st.markdown(summarized_all)

    related_container = st.container()
    with related_container:
        with st.form(key="my_related", clear_on_submit=False):
            summarized_data = st.text_area(label="ã¾ã¨ã‚ã®æ–‡ç« : ", key="summarized_data", value=st.session_state["summarized_data"], height=300)
            ask_detective_button = st.form_submit_button(label="æ¬¡ã®å–æå¯¾è±¡ã‚’æŽ¢åµã«èžãðŸ•µï¸â€â™‚ï¸")
            ask_gal_button = st.form_submit_button(label="ãƒã‚¯ã‚¹ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å¤§å­¦ç”Ÿã«æ•™ãˆã¦ã‚‚ã‚‰ã†ðŸ™ðŸ»âœ¨ðŸ’Œ")

        if ask_detective_button and summarized_data:

            # ã¾ã¨ã‚æ–‡ç« ã®ç·æ–‡å­—æ•°ã®3åˆ†ã®1ã”ã¨ã«åˆ†å‰²ã—ã¦ãƒªã‚¹ãƒˆåŒ–
            split_text_length = int(len(summarized_data) / 3)
            split_sentences = [summarized_data[x:x+split_text_length] for x in range(0,len(summarized_data),split_text_length)]
            # åˆ†å‰²çµæžœãŒ20æ–‡å­—ä»¥ä¸‹ã®æ–‡ç« ã®å ´åˆã€å‰Šé™¤ã™ã‚‹
            for i, item in enumerate(split_sentences):
                if len(item) < 20:
                    del split_sentences[i]

            with st.spinner("æŽ¢åµäº‹å‹™æ‰€ã«å•ã„åˆã‚ã›ä¸­ ..."):
                # wikipedia æ—¥æœ¬èªžãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ‰
                wikija_dataset = load_dataset(
                    path="singletongue/wikipedia-utils",
                    name="passages-c400-jawiki-20230403",
                    split="train",
                )
                # faiss index ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                dm = DownloadManager()
                index_local_path = dm.download(
                    f"https://huggingface.co/datasets/hotchpotch/wikipedia-passages-jawiki-embeddings/resolve/main/faiss_indexes/passages-c400-jawiki-20230403/sup-simcse-ja-base/index_IVF2048_PQ192.faiss"
                )
                # faiss index ã®ãƒ­ãƒ¼ãƒ‰
                faiss_index = faiss.read_index(index_local_path)

                # embeddings ã¸å¤‰æ›ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
                model = SentenceTransformer("cl-nagoya/sup-simcse-ja-base")
                model.max_seq_length = 512

            st.subheader(f"ä¾é ¼ãƒ†ãƒ¼ãƒžï¼š")
            st.markdown(f"""#### ã€Ž{st.session_state["user_theme"]}ã€""")
            st.markdown("ä¸Šã®ã¾ã¨ã‚ã‚’ã‚‚ã¨ã«ã€æ¬¡ã«èª¿æŸ»ã™ã¹ãå¯¾è±¡ã‚’æŽ¢åµï¼ˆðŸ•µï¸â€â™‚ï¸ï¼‰ã‹ã‚‰èžãã¾ã—ãŸã€‚")
            st.caption("""
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„å›³æ›¸é¤¨ã§èª¿ã¹ãŸã‚Šã€å®Ÿéš›ã«ç¾åœ°ã‚’è¨ªã‚ŒãŸã‚Šã™ã‚‹ãŸã‚ã®å…¥ã‚Šå£ã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
ãã“ã§å‡ºä¼šã£ãŸã‚Šè¦‹èžãã—ãŸã“ã¨ã‹ã‚‰ã€æ›´ã«æ¬¡ã®èª¿æŸ»å¯¾è±¡ã«æ¸¡ã‚Šæ­©ãã€æœ€çµ‚çš„ã«ã‚ãªãŸã®å•é¡Œæ„è­˜ã‚’æ›´ã«æ·±ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\n
ãã—ã¦ã€èª¿ã¹ã‚‹ãªã‹ã§ã€æ„Ÿå‹•ã—ãŸã‚Šã€ãªã‚‹ã»ã©ã¨æ€ã£ãŸã‚Šã€ã¾ãŸã¯ã“ã‚Œã¯é•ã†ãªã¨æ„Ÿã˜ãŸã‚Šã—ãŸã‚‰ã€å¿˜ã‚Œãªã„ã†ã¡ã«ç®‡æ¡æ›¸ãã§ãƒ¡ãƒ¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\
ãã‚ŒãŒ30å€‹ã»ã©è²¯ã¾ã£ãŸã‚‰ã€ã¾ãŸã“ã®KJ-GPTã‚’ä½¿ã£ã¦åˆ†æžã—ã¦ã¿ã‚‹ã¨ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã¾ã™ã¾ã™ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
 """)
            wiki_item_list = []
            for i, item in enumerate(split_sentences):
                # container = st.container()
                # container.write(item)
                emb = to_emb(model, item)
                # faiss ã§æ¤œç´¢ã—ã¦ã€é–¢é€£ Top-15 ã‚’å–ã‚Šå‡ºã™
                TOP_K = 15
                scores, indexes = faiss_index.search(emb, TOP_K)
                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é †4~15ä½ã‹ã‚‰1ã¤ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§æŒ‡å®š
                selected_indexes = random.sample(range(4,15), k=1)
                # æ®‹ã‚Šä¸€ã¤ã¯ã€8~20ä½ã®ã†ã¡ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§æŒ‡å®š
                # selected_indexes.insert(1,random.randint(8,20))

                for sel_i, idx in enumerate(selected_indexes):
                    if idx < TOP_K:  # ç¯„å›²ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
                        # if i  == 1 and sel_i == 1:
                        #     id = random.randint(1,5555583)
                        # if idx % 3  == 0:
                        #     id = random.randint(1,5555583)
                        # else:
                        #     id = indexes[0][idx]
                        id = indexes[0][idx]
                        score = scores[0][idx]
                        data = wikija_dataset[int(id)]
                        print((score, data["title"], data["text"][:100]))
                        wiki_title = data["title"]

                        # wikiã®é …ç›®ãŒé‡è¤‡ã—ã¦ã„ãªã„å ´åˆã®ã¿å‡¦ç†
                        if wiki_title not in wiki_item_list:
                            wiki_item_list.append(wiki_title)

                            wiki_text = ">..." + data["text"] + "..."

                            # æŠ½å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®æœ€åˆã®1æ–‡ã‚’å–ã‚Šå‡ºã™
                            first_sentence_wiki = data["text"].partition("ã€‚")[0]

                            url = "https://ja.wikipedia.org/api/rest_v1/page/summary/" + data["title"]

                            response = requests.get(url)
                            json_data = response.json()

                            st.markdown(f"### ãƒ»{wiki_title}")
                            if "thumbnail" in json_data:
                                thumbnail_image = json_data["thumbnail"]['source']
                                st.image(thumbnail_image)
                            if "extract" in json_data:
                                wiki_extract = json_data["extract"]
                                st.caption(wiki_extract)
                            st.markdown(related_sentence_generating(llm,item,data["text"],st.session_state["translated_theme"],wiki_extract))
                            st.markdown(wiki_text)
                            st.link_button("Wikipedia", "https://ja.wikipedia.org/wiki/" + data["title"] + "#:~:text=" + first_sentence_wiki)
                            
                            adult_keywords = ['æ„›æ’«', 'ã‚¢ã‚¯ãƒ¡', 'ã‚¢ãƒŠãƒ«', 'ã‚¤ãƒ©ãƒžãƒã‚ª', 'æ·«ä¹±', 'ã‚ªãƒŠãƒ‹ãƒ¼', 'ä»®æ€§åŒ…èŒŽ', 'ã‚¬ãƒžãƒ³æ±', 'é¡”é¢é¨Žä¹—', 'äº€é ­', 'äº€ç”²ç¸›ã‚Š', 'ã‚¯ãƒ³ãƒ‹ãƒªãƒ³ã‚°ã‚¹', 'ã‚¶ãƒ¼ãƒ¡ãƒ³', 'Gã‚¹ãƒãƒƒãƒˆ', 'ã‚¹ãƒ¯ãƒƒãƒ”ãƒ³ã‚°', 'å››åå…«æ‰‹', 'çœŸæ€§åŒ…èŒŽ', 'ã‚¹ãƒ‘ãƒ³ã‚­ãƒ³ã‚°', 'ã‚¹ã‚«ãƒˆãƒ­', 'å‰æˆ¯', 'ã‚»ãƒ³ã‚ºãƒª', 'å‰ç«‹è…º', 'æ—©æ¼', 'ç¥–ãƒãƒ³', 'ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•', 'ãƒ‡ã‚£ãƒ«ãƒ‰', 'ãƒ‡ãƒ–å°‚', 'é›»ãƒž', 'ãƒ‰ãƒ©ã‚¤ã‚ªãƒ¼ã‚¬ã‚ºãƒ ', 'å¯å–ã‚‰ã‚Œ', 'æœ¬ç•ªè¡Œç‚º', 'ãƒ‘ã‚¤ãƒ‘ãƒ³', 'ãƒã‚­ãƒ¥ãƒ¼ãƒ ãƒ•ã‚§ãƒ©', 'ã¶ã£ã‹ã‘', 'ãƒšãƒƒãƒ†ã‚£ãƒ³ã‚°', 'ãƒšãƒ‹ã‚¹ãƒãƒ³ãƒ‰', 'ãƒãƒ«ãƒã‚ª', 'ã¿ã“ã™ã‚ŠåŠ', 'å¤¢ç²¾', 'æ‚¶ãˆã‚‹', 'ãƒ¤ãƒªãƒãƒ³', 'ãƒ¤ãƒªãƒžãƒ³', 'å¤œé€™ã„', 'ãƒ©ãƒ–ã‚¸ãƒ¥ãƒ¼ã‚¹', 'ã¡ã‚“ã¡ã‚“', 'ã¡ã‚“ã“', 'ãƒãƒ³ãƒãƒ³', 'ãƒãƒ³ã‚³', 'ã¾ã‚“ã“', 'ãŠã¾ã‚“ã“', 'ãŠã£ã±ã„', 'å·¨ä¹³']

                            st.markdown("\n\n")

                            if any(adult_keyword in wiki_title for adult_keyword in adult_keywords):
                                print("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ä¸é©åˆ‡ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚")
                            else:
                                bing_query_url = "https://www.bing.com/search?q=" + wiki_title
                                st.link_button(f"Webã§ã€Œ{wiki_title}ã€ã‚’æ¤œç´¢", bing_query_url)

                                st.markdown("\n\n")

                                st.markdown("##### ðŸ“š")

                                url = "https://www.googleapis.com/books/v1/volumes?q=" + wiki_title + "&langRestrict=ja&orderBy=newest"

                                response = requests.get(url)
                                json_data = response.json()

                                col1, col2, col3 = st.columns(3)
                                columns = [col1, col2, col3]

                                if 'items' in json_data:
                                    for i, idx in enumerate(json_data['items'][0:2]):
                                        book_item = json_data['items'][i]
                                        volume_info = book_item['volumeInfo']
                                        book_id = book_item['id']
                                        book_title = volume_info['title']
                                        col = columns[i]  # å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç•°ãªã‚‹ã‚«ãƒ©ãƒ ã«å‡ç­‰ã«å‰²ã‚Šå½“ã¦ã‚‹
                                        with col:
                                            st.markdown(f"""<span style="word-wrap:break-word;">{book_title}</span>""", unsafe_allow_html=True)
                                            if 'imageLinks' in volume_info:
                                                book_thumbnail = volume_info['imageLinks']['thumbnail']
                                                st.image(book_thumbnail)
                                            else:
                                                book_thumbnail = ""
                                            if 'description' in volume_info:
                                                book_description = volume_info['description']
                                                st.caption(book_description[:100])
                                            else:
                                                book_description = ""
                                            book_link = "https://www.google.co.jp/books/edition/_/" + book_id + "?hl=ja"
                                            # book_link = volume_info['previewLink']
                                            st.link_button("è©³ç´°", book_link)

                                    st.markdown("\n")
                                else:
                                    st.markdown("Google Booksã§ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n")

                                amazon_link = f"https://www.amazon.co.jp/s?k={wiki_title}&i=stripbooks"
                                st.link_button("Amazonã§é–¢é€£æ›¸ç±ã‚’æŽ¢ã™", amazon_link)
                                calil_link = "https://calil.jp/search?q=" + wiki_title
                                st.link_button("å›³æ›¸é¤¨ï¼ˆã‚«ãƒ¼ãƒªãƒ«ï¼‰ã§é–¢é€£è³‡æ–™ã‚’æŽ¢ã™", calil_link)

                                st.markdown("\n\n")

        if ask_gal_button and summarized_data:

            # ã¾ã¨ã‚æ–‡ç« ã®ç·æ–‡å­—æ•°ã®3åˆ†ã®1ã”ã¨ã«åˆ†å‰²ã—ã¦ãƒªã‚¹ãƒˆåŒ–
            split_text_length = int(len(summarized_data) / 3)
            split_sentences = [summarized_data[x:x+split_text_length] for x in range(0,len(summarized_data),split_text_length)]
            # åˆ†å‰²çµæžœãŒ20æ–‡å­—ä»¥ä¸‹ã®æ–‡ç« ã®å ´åˆã€å‰Šé™¤ã™ã‚‹
            for i, item in enumerate(split_sentences):
                if len(item) < 20:
                    del split_sentences[i]

            with st.spinner("ã‚¤ãƒ³ã‚¹ã‚¿ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¤œç´¢ä¸­ ..."):
                # wikipedia æ—¥æœ¬èªžãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ‰
                wikija_dataset = load_dataset(
                    path="singletongue/wikipedia-utils",
                    name="passages-c400-jawiki-20230403",
                    split="train",
                )
                # faiss index ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                dm = DownloadManager()
                index_local_path = dm.download(
                    f"https://huggingface.co/datasets/hotchpotch/wikipedia-passages-jawiki-embeddings/resolve/main/faiss_indexes/passages-c400-jawiki-20230403/sup-simcse-ja-base/index_IVF2048_PQ192.faiss"
                )
                # faiss index ã®ãƒ­ãƒ¼ãƒ‰
                faiss_index = faiss.read_index(index_local_path)

                # embeddings ã¸å¤‰æ›ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
                model = SentenceTransformer("cl-nagoya/sup-simcse-ja-base")
                model.max_seq_length = 512

            st.subheader(f"ä¾é ¼ãƒ†ãƒ¼ãƒžï¼š")
            st.markdown(f"""#### ã€Ž{st.session_state["user_theme"]}ã€""")
            st.markdown("ä¸Šã®ã¾ã¨ã‚ã‚’ã‚‚ã¨ã«ã€æ¬¡ã«èª¿æŸ»ã™ã¹ãå¯¾è±¡ã‚’å¤§å­¦ç”Ÿã‹ã‚‰èžãã¾ã—ãŸðŸ¤­ðŸ¤")
            st.caption("""
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚„å›³æ›¸é¤¨ã§èª¿ã¹ãŸã‚Šã€å®Ÿéš›ã«ç¾åœ°ã‚’è¨ªã‚ŒãŸã‚Šã™ã‚‹ãŸã‚ã®å…¥ã‚Šå£ã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
ãã“ã§å‡ºä¼šã£ãŸã‚Šè¦‹èžãã—ãŸã“ã¨ã‹ã‚‰ã€æ›´ã«æ¬¡ã®èª¿æŸ»å¯¾è±¡ã«æ¸¡ã‚Šæ­©ãã€æœ€çµ‚çš„ã«ã‚ãªãŸã®å•é¡Œæ„è­˜ã‚’æ›´ã«æ·±ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\n
ãã—ã¦ã€èª¿ã¹ã‚‹ãªã‹ã§ã€æ„Ÿå‹•ã—ãŸã‚Šã€ãªã‚‹ã»ã©ã¨æ€ã£ãŸã‚Šã€ã¾ãŸã¯ã“ã‚Œã¯é•ã†ãªã¨æ„Ÿã˜ãŸã‚Šã—ãŸã‚‰ã€å¿˜ã‚Œãªã„ã†ã¡ã«ç®‡æ¡æ›¸ãã§ãƒ¡ãƒ¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\
ãã‚ŒãŒ30å€‹ã»ã©è²¯ã¾ã£ãŸã‚‰ã€ã¾ãŸã“ã®KJ-GPTã‚’ä½¿ã£ã¦åˆ†æžã—ã¦ã¿ã‚‹ã¨ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã¾ã™ã¾ã™ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
 """)
            wiki_item_list = []
            for i, item in enumerate(split_sentences):
                # container = st.container()
                # container.write(item)
                emb = to_emb(model, item)
                # faiss ã§æ¤œç´¢ã—ã¦ã€é–¢é€£ Top-15 ã‚’å–ã‚Šå‡ºã™
                TOP_K = 15
                scores, indexes = faiss_index.search(emb, TOP_K)
                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é †4~15ä½ã‹ã‚‰1ã¤ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§æŒ‡å®š
                selected_indexes = random.sample(range(4,15), k=1)
                # æ®‹ã‚Šä¸€ã¤ã¯ã€8~20ä½ã®ã†ã¡ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§æŒ‡å®š
                # selected_indexes.insert(1,random.randint(8,20))

                for sel_i, idx in enumerate(selected_indexes):
                    if idx < TOP_K:  # ç¯„å›²ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
                        # if i  == 1 and sel_i == 1:
                        #     id = random.randint(1,5555583)
                        # if idx % 3  == 0:
                        #     id = random.randint(1,5555583)
                        # else:
                        #     id = indexes[0][idx]
                        id = indexes[0][idx]
                        score = scores[0][idx]
                        data = wikija_dataset[int(id)]
                        print((score, data["title"], data["text"][:100]))
                        wiki_title = data["title"]

                        # wikiã®é …ç›®ãŒé‡è¤‡ã—ã¦ã„ãªã„å ´åˆã®ã¿å‡¦ç†
                        if wiki_title not in wiki_item_list:
                            wiki_item_list.append(wiki_title)

                            wiki_text = ">..." + data["text"] + "..."

                            # æŠ½å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®æœ€åˆã®1æ–‡ã‚’å–ã‚Šå‡ºã™
                            first_sentence_wiki = data["text"].partition("ã€‚")[0]

                            url = "https://ja.wikipedia.org/api/rest_v1/page/summary/" + data["title"]

                            response = requests.get(url)
                            json_data = response.json()

                            st.markdown(f"### ãƒ»{wiki_title}")
                            if "thumbnail" in json_data:
                                thumbnail_image = json_data["thumbnail"]['source']
                                st.image(thumbnail_image)
                            if "extract" in json_data:
                                wiki_extract = json_data["extract"]
                                st.caption(wiki_extract)
                            st.markdown(related_gal_sentence_generating(llm,item,data["text"],st.session_state["translated_theme"],wiki_extract))
                            st.markdown(wiki_text)
                            st.link_button("Wikipedia", "https://ja.wikipedia.org/wiki/" + data["title"] + "#:~:text=" + first_sentence_wiki)
                            
                            adult_keywords = ['æ„›æ’«', 'ã‚¢ã‚¯ãƒ¡', 'ã‚¢ãƒŠãƒ«', 'ã‚¤ãƒ©ãƒžãƒã‚ª', 'æ·«ä¹±', 'ã‚ªãƒŠãƒ‹ãƒ¼', 'ä»®æ€§åŒ…èŒŽ', 'ã‚¬ãƒžãƒ³æ±', 'é¡”é¢é¨Žä¹—', 'äº€é ­', 'äº€ç”²ç¸›ã‚Š', 'ã‚¯ãƒ³ãƒ‹ãƒªãƒ³ã‚°ã‚¹', 'ã‚¶ãƒ¼ãƒ¡ãƒ³', 'Gã‚¹ãƒãƒƒãƒˆ', 'ã‚¹ãƒ¯ãƒƒãƒ”ãƒ³ã‚°', 'å››åå…«æ‰‹', 'çœŸæ€§åŒ…èŒŽ', 'ã‚¹ãƒ‘ãƒ³ã‚­ãƒ³ã‚°', 'ã‚¹ã‚«ãƒˆãƒ­', 'å‰æˆ¯', 'ã‚»ãƒ³ã‚ºãƒª', 'å‰ç«‹è…º', 'æ—©æ¼', 'ç¥–ãƒãƒ³', 'ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•', 'ãƒ‡ã‚£ãƒ«ãƒ‰', 'ãƒ‡ãƒ–å°‚', 'é›»ãƒž', 'ãƒ‰ãƒ©ã‚¤ã‚ªãƒ¼ã‚¬ã‚ºãƒ ', 'å¯å–ã‚‰ã‚Œ', 'æœ¬ç•ªè¡Œç‚º', 'ãƒ‘ã‚¤ãƒ‘ãƒ³', 'ãƒã‚­ãƒ¥ãƒ¼ãƒ ãƒ•ã‚§ãƒ©', 'ã¶ã£ã‹ã‘', 'ãƒšãƒƒãƒ†ã‚£ãƒ³ã‚°', 'ãƒšãƒ‹ã‚¹ãƒãƒ³ãƒ‰', 'ãƒãƒ«ãƒã‚ª', 'ã¿ã“ã™ã‚ŠåŠ', 'å¤¢ç²¾', 'æ‚¶ãˆã‚‹', 'ãƒ¤ãƒªãƒãƒ³', 'ãƒ¤ãƒªãƒžãƒ³', 'å¤œé€™ã„', 'ãƒ©ãƒ–ã‚¸ãƒ¥ãƒ¼ã‚¹', 'ã¡ã‚“ã¡ã‚“', 'ã¡ã‚“ã“', 'ãƒãƒ³ãƒãƒ³', 'ãƒãƒ³ã‚³', 'ã¾ã‚“ã“', 'ãŠã¾ã‚“ã“', 'ãŠã£ã±ã„', 'å·¨ä¹³']

                            st.markdown("\n\n")

                            if any(adult_keyword in wiki_title for adult_keyword in adult_keywords):
                                print("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ä¸é©åˆ‡ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚")
                            else:
                                bing_query_url = "https://www.bing.com/search?q=" + wiki_title
                                st.link_button(f"Webã§ã€Œ{wiki_title}ã€ã‚’æ¤œç´¢", bing_query_url)

                                st.markdown("\n\n")

                                st.markdown("##### ðŸ“š")

                                url = "https://www.googleapis.com/books/v1/volumes?q=" + wiki_title + "&langRestrict=ja&orderBy=newest"

                                response = requests.get(url)
                                json_data = response.json()

                                col1, col2, col3 = st.columns(3)
                                columns = [col1, col2, col3]

                                if 'items' in json_data:
                                    for i, idx in enumerate(json_data['items'][0:2]):
                                        book_item = json_data['items'][i]
                                        volume_info = book_item['volumeInfo']
                                        book_id = book_item['id']
                                        book_title = volume_info['title']
                                        col = columns[i]  # å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç•°ãªã‚‹ã‚«ãƒ©ãƒ ã«å‡ç­‰ã«å‰²ã‚Šå½“ã¦ã‚‹
                                        with col:
                                            st.markdown(f"""<span style="word-wrap:break-word;">{book_title}</span>""", unsafe_allow_html=True)
                                            if 'imageLinks' in volume_info:
                                                book_thumbnail = volume_info['imageLinks']['thumbnail']
                                                st.image(book_thumbnail)
                                            else:
                                                book_thumbnail = ""
                                            if 'description' in volume_info:
                                                book_description = volume_info['description']
                                                st.caption(book_description[:100])
                                            else:
                                                book_description = ""
                                            book_link = "https://www.google.co.jp/books/edition/_/" + book_id + "?hl=ja"
                                            # book_link = volume_info['previewLink']
                                            st.link_button("è©³ç´°", book_link)

                                    st.markdown("\n")
                                else:
                                    st.markdown("Google Booksã§ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n")

                                amazon_link = f"https://www.amazon.co.jp/s?k={wiki_title}&i=stripbooks"
                                st.link_button("Amazonã§é–¢é€£æ›¸ç±ã‚’æŽ¢ã™", amazon_link)
                                calil_link = "https://calil.jp/search?q=" + wiki_title
                                st.link_button("å›³æ›¸é¤¨ï¼ˆã‚«ãƒ¼ãƒªãƒ«ï¼‰ã§é–¢é€£è³‡æ–™ã‚’æŽ¢ã™", calil_link)

                                st.markdown("\n\n")


    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º
    messages = st.session_state.get("messages", [])
    for message in messages:
        if isinstance(message, AIMessage):
            with st.chat_message("assistant"):
                st.markdown(message.content)
        elif isinstance(message, HumanMessage):
            with st.chat_message("user"):
                st.markdown(message.content)
        # else:
        #     st.write(f"System message: {message.content}")

    # ã‚³ã‚¹ãƒˆã®è¨ˆç®—ã¨è¡¨ç¤º
    costs = st.session_state.get('costs', [])
    st.sidebar.markdown("## Costs")
    st.sidebar.markdown(f"**Total cost: ${sum(costs):.5f}**")
    for cost in costs:
        st.sidebar.markdown(f"- ${cost:.5f}")

if __name__ == "__main__":
    main()
